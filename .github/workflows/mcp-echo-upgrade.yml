name: "ğŸ§° MCP Install + EchoOps MEGA (Safe Shim+npx)"

on:
  workflow_dispatch:
    inputs:
      mcp_npm_pkg:
        description: "MCP CLI í›„ë³´ íŒ¨í‚¤ì§€(npx ê¸°ë³¸ ëŒ€ìƒ). ê¸°ë³¸: mcp"
        required: false
        default: "mcp"
      mcp_version:
        description: "MCP ë²„ì „(ì„ íƒ, ì˜ˆ: 1.4.2). ë¹„ìš°ë©´ latest"
        required: false
        default: ""
      mcp_servers_csv:
        description: "ì¶”ê°€ MCP ì„œë²„ NPM íŒ¨í‚¤ì§€ CSV"
        required: false
        default: ""
      echo_root:
        description: "ì—ì½” ë£¨íŠ¸ ë””ë ‰í† ë¦¬"
        required: true
        default: ".github/echo_mcp"
      dirs_count:
        description: "ëŒ€ëŸ‰ ì—ì½” ë””ë ‰í† ë¦¬ ê°œìˆ˜(0=ê±´ë„ˆëœ€)"
        required: true
        default: "0"
      allow_domains_csv:
        description: "curl í—ˆìš© ë„ë©”ì¸ CSV"
        required: false
        default: "raw.githubusercontent.com,github.com"
      downloads_manifest:
        description: "ë‹¤ìš´ë¡œë“œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ CSV (URL|SHA256 í˜•ì‹, SHA256 ìƒëµ ê°€ëŠ¥)"
        required: false
        default: ""
      do_upgrade:
        description: "Auto Upgrade(apt/npm/pip) ì‹¤í–‰"
        type: boolean
        required: true
        default: true
      images_with_fallback_csv:
        description: "ë„ì»¤ ì´ë¯¸ì§€ CSV (img|fb1|fb2 â€¦). ê¸°ë³¸ê°’ì€ ì¡´ì¬í•˜ëŠ” íƒœê·¸ë¡œ êµ¬ì„±"
        required: false
        default: "quay.io/coreos/etcd:v3.5.15|gcr.io/etcd-development/etcd:v3.5.15,alpine:3.19|alpine:latest"
      create_release:
        description: "GitHub Release ìƒì„±"
        type: boolean
        required: true
        default: false

permissions:
  contents: write
  actions: read

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ECHO_OK: "âœ…"
  ECHO_WARN: "âš ï¸"
  ECHO_FAIL: "âŒ"
  RELEASE_TAG_PREFIX: "mcp-echo"

jobs:
  mcp-echo-mega:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare directories
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}"
          mkdir -p "${{ inputs.echo_root }}"/{configs,servers,downloads,perm,logs,mass}
          mkdir -p ".github/echo_perm" ".github/echo_up" ".github/echo_tools"

      - name: Setup Node & Python
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install base tools (jq, coreutils, file, gh)
        shell: bash
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y jq coreutils file gh

      - name: Write echo helpers (safe heredoc)
        shell: bash
        run: |
          set -Eeuo pipefail
          cat <<'SH' > /tmp/echo_helpers.sh
          set -Eeuo pipefail
          ECHO_OK="${ECHO_OK:-âœ…}"; ECHO_WARN="${ECHO_WARN:-âš ï¸}"; ECHO_FAIL="${ECHO_FAIL:-âŒ}"
          LOG_DIR="${LOG_DIR:-.github/echo_logs}"; mkdir -p "$LOG_DIR"
          SAFE_SERVICE="${SAFE_SERVICE:-mcp}"
          logf(){ printf '%s\n' "$*" | tee -a "${LOG_DIR}/echo-${SAFE_SERVICE}.log"; }
          echoe(){ printf '%s %s\n' "${ECHO_OK}" "$*" | tee -a "${LOG_DIR}/echo-${SAFE_SERVICE}.log"; }
          warn(){  printf '%s %s\n' "${ECHO_WARN}" "$*" | tee -a "${LOG_DIR}/echo-${SAFE_SERVICE}.log"; }
          run_cmd(){
            logf "â–¶ $*"
            eval "$@" 2>&1 | tee -a "${LOG_DIR}/echo-${SAFE_SERVICE}.log"
            local rc=${PIPESTATUS[0]}
            if [ $rc -eq 0 ]; then echoe "DONE (rc=$rc): $*"; else warn "FAILED (rc=$rc): $*"; fi
            return $rc
          }
          npm_global_bin(){
            local root; root="$(npm root -g 2>/dev/null || true)"
            if [ -n "$root" ]; then
              local parent; parent="$(dirname "$root")"
              if [ -d "$parent/bin" ]; then echo "$parent/bin"; return 0; fi
              if [ -d "$root/.bin" ]; then echo "$root/.bin"; return 0; fi
            fi
            for d in "$(npm prefix -g 2>/dev/null || true)/bin" /usr/local/bin /opt/hostedtoolcache/node/*/*/bin; do
              [ -d "$d" ] && echo "$d" && return 0
            done
            echo "/usr/local/bin"
          }
          perm_dump(){ local r="$1"; ls -lR "$r" > "${r}/perm/perm.tree.txt"; find "$r" -type f -exec sha256sum {} \; > "${r}/perm/perm.sha256.txt"; printf 'umask is: %s\n' "$(umask)" > "${r}/perm/umask.txt"; cp "${r}/perm/perm.tree.txt" ".github/echo_perm/perm-${GITHUB_RUN_ID}.txt" || true; }
          safe_tag(){ printf '%s\n' "$1" | tr -cd '[:alnum:]._-' | sed 's/^\.*//; s/\.*$//'; }
          # gh release: ì—†ìœ¼ë©´ gh api ë¡œ í´ë°± (ì´ë²ˆì—” í´ë°±ì„ ë°˜ë“œì‹œ ì‹¤í–‰)
          gh_release_create(){
            local tag="$1"; local name="$2"; local body="$3"; local file="$4"
            if [ -z "${GH_TOKEN:-}" ]; then warn "GH_TOKEN not set; skip release"; return 0; fi
            if gh help release >/dev/null 2>&1; then
              if gh release create "$tag" "$file" --notes "$body" --title "$name"; then
                echoe "gh release created"
                return 0
              else
                warn "gh release create failed; falling back to gh api"
              fi
            fi
            # í´ë°±: gh api ë¡œ ë¦´ë¦¬ìŠ¤ ìƒì„±
            if gh api -X POST "repos/${GITHUB_REPOSITORY}/releases" -f tag_name="$tag" -f name="$name" -f body="$body" >/tmp/rel.json 2>/dev/null; then
              echoe "gh api release created"
              # ì—ì…‹ ì—…ë¡œë“œ (optional)
              if [ -f "$file" ]; then
                url="$(jq -r .upload_url </tmp/rel.json | sed 's/{.*}//')"
                gh api --method POST -H "Content-Type: text/plain" --input "$file" "$url?name=$(basename "$file")" || warn "asset upload failed"
              fi
            else
              warn "gh api release failed"
            fi
          }
          curl_get(){
            local url="$1"; local out="$2"; local want_sha="${3:-}"
            local allow="${ALLOW_DOMAINS_CSV:-}"; local host; host=$(printf '%s' "$url" | awk -F/ '{print $3}')
            if [ -n "$allow" ]; then
              local ok=; IFS=',' read -r -a arr <<< "$allow"
              for d in "${arr[@]}"; do [ "$host" = "$d" ] && ok=1 && break; done
              if [ -z "$ok" ]; then warn "Host $host not in allowlist; skip $url"; return 2; fi
            fi
            run_cmd curl -fSsvL --retry 3 --retry-all-errors --retry-delay 2 --connect-timeout 20 --max-time 300 "$url" -o "$out"
            if [ -n "$want_sha" ] && [ -f "$out" ]; then
              local got; got=$(sha256sum "$out" | awk '{print $1}')
              if [ "$got" != "$want_sha" ]; then warn "SHA256 mismatch: want=$want_sha got=$got ($out)"; return 3; fi
            fi
          }
          SH
          chmod +x /tmp/echo_helpers.sh
          echo "helpers: ready" > ".github/echo_tools/helpers_ready.txt"

      - name: Node/npm health (echo)
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          run_cmd node -v
          run_cmd npm -v
          command -v npx || true

      # ===== MCP ì„¤ì¹˜ + ì•ˆì „ ì‹¤í–‰ Shim =====
      # (ì¤‘ìš”) npx ê²½ë¡œë¥¼ 1ìˆœìœ„ë¡œ ì´ìš©í•˜ì—¬ 'mcp-safe'ê°€ í•­ìƒ ë™ì‘í•˜ë„ë¡ ì„¤ê³„
      - name: Install MCP CLI (best-effort; no hard fail)
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh || true
          PKG="${{ inputs.mcp_npm_pkg }}"
          VER="${{ inputs.mcp_version }}"
          # ì „ì—­ ì„¤ì¹˜ëŠ” 'ìˆìœ¼ë©´ ì¢‹ìŒ' ìˆ˜ì¤€ìœ¼ë¡œë§Œ ì‹œë„ (npxê°€ 1ìˆœìœ„)
          if [ -n "$VER" ]; then run_cmd npm i -g "${PKG}@${VER}" || true; else run_cmd npm i -g "${PKG}" || true; fi
          BIN="$(npm_global_bin)"
          echo "NPM global bin=${BIN}"
          ls -l "$BIN" || true
          which mcp || true

      - name: Create safe MCP shim (NPX-first + ë‹¤ì¤‘ í›„ë³´ + Node/exec ë³´ì¡°)
        shell: bash
        run: |
          set -Eeuo pipefail
          SHIM="/usr/local/bin/mcp-safe"
          sudo tee "$SHIM" >/dev/null <<'SH'
          #!/usr/bin/env bash
          set -Eeuo pipefail

          # npx ì‚¬ì „ê²€ì¦/ì‚¬ì „í—¬í”„ ì—†ì´ 'ì§ì ‘ ì‹¤í–‰' ìš°ì„ : ì¼ë¶€ íŒ¨í‚¤ì§€ì˜ --help/--version ë°˜í™˜ì½”ë“œê°€ ì¼ì •ì¹˜ ì•ŠìŒ
          try_npx() {
            # $1: spec(ì˜ˆ: mcp / @mintlify/mcp / @modelcontextprotocol/cli@x.y.z mcp)
            # ë‚˜ë¨¸ì§€ ì¸ì ê·¸ëŒ€ë¡œ ì „ë‹¬
            local spec="$1"; shift || true
            if command -v npx >/dev/null 2>&1; then
              # shellcheck disable=SC2086
              exec npx -y $spec "$@"
            fi
            return 127
          }

          try_node_file() {
            # $1: file path
            local f="$1"; shift || true
            if command -v node >/dev/null 2>&1 && [ -f "$f" ]; then
              exec node "$f" "$@"
            fi
            return 127
          }

          try_exec() {
            local f="$1"; shift || true
            if [ -x "$f" ]; then
              exec "$f" "$@"
            fi
            return 127
          }

          main() {
            local user_spec="${MCP_NPX_SPEC:-mcp}"   # ê¸°ë³¸ npx ëŒ€ìƒ
            local ver="${MCP_VERSION:-}"
            local global_bin="$(command -v mcp || true)"

            # 1) NPX 1ì°¨: ì‚¬ìš©ìê°€ ì§€ì •í•œ spec (ê¸°ë³¸ mcp)
            try_npx "$user_spec" "$@" || true

            # 2) NPX 2ì°¨: @mintlify/mcp (ì¼ë¶€ í™˜ê²½ì—ì„œ ì „ì—­ mcp ë°”ì´ë„ˆë¦¬ê°€ ì´ ì†ŒìŠ¤ ê¸°ì¤€)
            try_npx "@mintlify/mcp" "$@" || true

            # 3) NPX 3ì°¨: @modelcontextprotocol/cli (ë²„ì „ ê³ ì • â†’ latest)
            if [ -n "$ver" ]; then
              try_npx "@modelcontextprotocol/cli@${ver} mcp" "$@" || true
            fi
            try_npx "@modelcontextprotocol/cli mcp" "$@" || true

            # 4) ì „ì—­ ì„¤ì¹˜ë³¸ì´ ìˆìœ¼ë©´ Nodeë¡œ ì§ì ‘ ì‹¤í–‰(ESM í…ìŠ¤íŠ¸ ë°”ì´ë„ˆë¦¬ ë³´ì •)
            if [ -n "$global_bin" ] && [ -f "$global_bin" ]; then
              # í…ìŠ¤íŠ¸/JSë©´ Nodeë¡œ, ì•„ë‹ˆë©´ ì§ì ‘ ì‹¤í–‰
              if file -b --mime-type "$global_bin" | grep -qE '^(text/|application/javascript)'; then
                try_node_file "$global_bin" "$@" || true
              fi
              try_exec "$global_bin" "$@" || true
            fi

            echo "mcp-safe: no viable MCP runner found (npx chain + node/exec fallback failed)" >&2
            exit 127
          }
          main "$@"
          SH
          sudo chmod +x "$SHIM"
          {
            echo "MCP_VERSION=${{ inputs.mcp_version }}"
            # ì‚¬ìš©ìê°€ ì§€ì •í•œ í›„ë³´ íŒ¨í‚¤ì§€ë¥¼ npx 1ìˆœìœ„ë¡œ ì‚¬ìš©
            echo "MCP_NPX_SPEC=${{ inputs.mcp_npm_pkg }}"
            echo "MCP_CMD=$SHIM"
          } >> "$GITHUB_ENV"

      - name: Verify MCP (run help/version and files subcommand; tolerant)
        shell: bash
        run: |
          set -Eeuo pipefail
          : "${MCP_CMD:?MCP_CMD not set}"
          # ë‹¤ì–‘í•œ í”Œë˜ê·¸ ì¡°í•© ì‹œë„ (ì¼ë¶€ íŒ¨í‚¤ì§€ì˜ ë°˜í™˜ì½”ë“œê°€ ì¼ì •ì¹˜ ì•ŠìŒ)
          "$MCP_CMD" --help || true
          "$MCP_CMD" --version || true
          "$MCP_CMD" files --help || true

      # ===== MCP ì„œë²„ ì„¤ì¹˜(ì„ íƒ) =====
      - name: Install additional MCP servers (CSV)
        if: ${{ inputs.mcp_servers_csv != '' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          IFS=',' read -r -a SRVS <<< "${{ inputs.mcp_servers_csv }}"
          for pkg in "${SRVS[@]}"; do
            [ -z "$pkg" ] && continue
            run_cmd npm i -g "$pkg" || warn "install failed: $pkg"
          done

      # ===== ì—ì½”/ê¶Œí•œ/êµ¬ì„±/ëŒ€ëŸ‰ìƒì„± =====
      - name: Generate MCP configs + sample server
        shell: bash
        run: |
          set -Eeuo pipefail
          root="${{ inputs.echo_root }}"
          cat <<'JSON' > "${root}/configs/mcp.config.json"
          {
            "$schema": "https://raw.githubusercontent.com/modelcontextprotocol/ts/main/schema/mcp.json",
            "clients": { "default": { "providers": [] } },
            "servers": {
              "files": { "command": "mcp", "args": ["files"], "enabled": true, "env": { "MCP_FILES_ROOT": "./" } },
              "shell": { "command": "mcp", "args": ["shell"], "enabled": false }
            }
          }
          JSON
          cat <<'MD' > "${root}/README.md"
          # MCP EchoOps MEGA
          - MCP CLI/ì„œë²„ ì„¤ì¹˜, ì—ì½” íŒŒì¼ ìƒì„±, í¼ë¯¸ì…˜ ë¤í”„, ì—…ê·¸ë ˆì´ë“œ, ì»¨í…Œì´ë„ˆ í…ŒìŠ¤íŠ¸, ë¦´ë¦¬ìŠ¤ê¹Œì§€ í†µí•©.
          - ìˆ˜ì •: `configs/mcp.config.json`, `servers/*`, `perm/*`, `downloads/*`
          MD
          cat <<'SHX' > "${root}/servers/sample-server.sh"
          #!/usr/bin/env bash
          set -Eeuo pipefail
          echo "[Sample] MCP server boot (placeholder)"
          exec sleep 2
          SHX
          chmod +x "${root}/servers/sample-server.sh"

      - name: Echo permissions (chmod + dump)
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          root="${{ inputs.echo_root }}"
          chmod -R a+r "${root}" || true
          find "${root}" -type d -exec chmod a+rx {} \; || true
          find "${root}/servers" -type f -name "*.sh" -exec chmod a+rx {} \; || true
          perm_dump "${root}"

      - name: Massive echo directories (optional)
        if: ${{ inputs.dirs_count != '0' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          root="${{ inputs.echo_root }}"
          N="${{ inputs.dirs_count }}"
          echo "Create $N dirs under ${root}/mass"
          for i in $(seq 1 "$N"); do
            d="${root}/mass/dir$(printf '%05d' "$i")"
            mkdir -p "$d"
            printf 'echo dir %s\n' "$d" > "${d}/README.echo.txt"
          done
          echo "Mass dir count: $(find "${root}/mass" -maxdepth 1 -type d | wc -l)" > "${root}/logs/mass.done.txt"

      # ===== ë‹¤ìš´ë¡œë“œ(í—ˆìš©ë„ë©”ì¸/ì„ íƒì  SHA) =====
      - name: Curl downloads (allowlist + optional SHA256 via manifest)
        if: ${{ inputs.downloads_manifest != '' }}
        shell: bash
        env:
          ALLOW_DOMAINS_CSV: ${{ inputs.allow_domains_csv }}
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          root="${{ inputs.echo_root }}"
          IFS=',' read -r -a ITEMS <<< "${{ inputs.downloads_manifest }}"
          for item in "${ITEMS[@]}"; do
            [ -z "$item" ] && continue
            url="${item%%|*}"
            sha="${item#*|}"; [ "$url" = "$sha" ] && sha=""
            base=$(basename "$url")
            out="${root}/downloads/${base}"
            curl_get "$url" "$out" "$sha" || warn "download failed: $url"
          done
          ls -l "${root}/downloads" || true

      # ===== ì‹œìŠ¤í…œ/ëŸ°íƒ€ì„ ì—…ê·¸ë ˆì´ë“œ =====
      - name: Auto Upgrade (apt + npm + pip)
        if: ${{ inputs.do_upgrade }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          run_cmd sudo apt-get update -y
          run_cmd sudo DEBIAN_FRONTEND=noninteractive apt-get -y upgrade || true
          run_cmd sudo apt-get -y autoremove || true
          run_cmd npm -g update || true
          run_cmd npm -g outdated || true
          python -V || true
          python - <<'PY' || true
          import sys, subprocess
          try:
              import pkg_resources
          except Exception:
              sys.exit(0)
          pkgs = [d.project_name for d in pkg_resources.working_set]
          if pkgs:
              subprocess.call([sys.executable, "-m", "pip", "install", "-U"] + pkgs)
          PY
          date '+%F %T' > ".github/echo_up/upgrade-${{ github.run_id }}.stamp"

      # ===== ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ í’€(ì¡´ì¬ íƒœê·¸ + per-item í´ë°±) =====
      - name: Docker image pull test with per-item fallbacks
        if: ${{ inputs.images_with_fallback_csv != '' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          IFS=',' read -r -a ITEMS <<< "${{ inputs.images_with_fallback_csv }}"
          for spec in "${ITEMS[@]}"; do
            [ -z "$spec" ] && continue
            IFS='|' read -r img fb1 fb2 fb3 fb4 fb5 <<< "$spec"
            if run_cmd docker pull "$img"; then
              echo "Pulled: $img"; continue
            fi
            pulled=0
            for fb in "$fb1" "$fb2" "$fb3" "$fb4" "$fb5"; do
              [ -z "$fb" ] && continue
              if run_cmd docker pull "$fb"; then
                echo "Fallback pulled: $fb (original $img failed)"; pulled=1; break
              fi
            done
            [ "$pulled" -eq 1 ] || warn "All fallbacks failed for $img"
          done

      # ===== ìš”ì•½/ì•„í‹°íŒ©íŠ¸/ë¦´ë¦¬ìŠ¤ =====
      - name: Summary & tree (always)
        if: always()
        shell: bash
        run: |
          set -Eeuo pipefail
          root="${{ inputs.echo_root }}"
          {
            echo "# MCP EchoOps MEGA Summary"
            echo "- MCP_NPX_SPEC: ${{ inputs.mcp_npm_pkg }}"
            echo "- MCP VER: ${{ inputs.mcp_version }}"
            echo "- Servers:  ${{ inputs.mcp_servers_csv }}"
            echo "- Allow:    ${{ inputs.allow_domains_csv }}"
            echo "- Dirs:     ${{ inputs.dirs_count }}"
            echo "- Upgrade:  ${{ inputs.do_upgrade }}"
            echo "- Images(spec): ${{ inputs.images_with_fallback_csv }}"
            echo
            echo "## ${root} (top-level)"
            echo '```'
            ls -la "${root}" || true
            echo '```'
          } > "${root}/logs/summary.md"

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-echo-mega-${{ github.run_id }}
          path: |
            ${{ inputs.echo_root }}/**
            .github/echo_perm/**
            .github/echo_up/**
            ${{ env.LOG_DIR }}/**
          if-no-files-found: warn

      - name: (Optional) Create GitHub Release (safe tag, forced fallback) (always if enabled)
        if: ${{ inputs.create_release && always() }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          prefix="$(safe_tag "${RELEASE_TAG_PREFIX}")"
          ts="$(date +%Y%m%d%H%M%S)"
          tag="${prefix}-${ts}"
          name="MCP EchoOps MEGA ${ts}"
          body="Automated release for MCP EchoOps MEGA run ${GITHUB_RUN_ID}"
          file="${{ inputs.echo_root }}/logs/summary.md"
          gh_release_create "$tag" "$name" "$body" "$file" || true

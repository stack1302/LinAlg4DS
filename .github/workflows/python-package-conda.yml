name: "ğŸ“’ Bank Statement â†’ Excel/CSV (Full Echo + Tx Log + Docs Attach)"

on:
  workflow_dispatch:
    inputs:
      tx_csv_path:
        description: "ì„ íƒ: ê±°ë˜ CSV ê²½ë¡œ(ì—†ìœ¼ë©´ ìŠ¤í¬ë¦½íŠ¸ ë‚´ ë‚´ì¥ ë°ì´í„° ì‚¬ìš©)"
        required: false
        default: "raw/transactions.csv"
      docs_glob:
        description: "í•¨ê»˜ ì˜¬ë¦´ ë¬¸ì„œ ê¸€ë¡­ íŒ¨í„´ (ì‰¼í‘œ êµ¬ë¶„ ê°€ëŠ¥)"
        required: false
        default: "docs/**"
  push:
    paths:
      - "make_statement.py"
      - ".github/workflows/bank-statement.yml"
      - "docs/**"
      - "raw/transactions.csv"

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    env:
      TZ: Asia/Seoul
      ECHO_OK: "âœ…"
      ECHO_WARN: "âš ï¸"
      ECHO_FAIL: "âŒ"
      LOG_DIR: .github/echo_logs
      OUT_DIR: out

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare echo logs & dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "$LOG_DIR" "$OUT_DIR" raw docs
          echo "${ECHO_OK} Start bank-statement job ($(date -Iseconds))" | tee -a "$LOG_DIR/flow.log"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps (pandas,xlsxwriter)
        shell: bash
        run: |
          set -Eeuo pipefail
          python -V | tee -a "$LOG_DIR/flow.log"
          pip install --upgrade pip >/dev/null
          pip install pandas xlsxwriter >/dev/null
          echo "${ECHO_OK} Deps installed" | tee -a "$LOG_DIR/flow.log"

      - name: Ensure make_statement.py exists (auto-generate safe version)
        shell: bash
        run: |
          set -Eeuo pipefail
          if [ -f make_statement.py ]; then
            echo "${ECHO_OK} Existing make_statement.py found" | tee -a "$LOG_DIR/flow.log"
          else
            echo "${ECHO_WARN} make_statement.py not found â†’ generating default script" | tee -a "$LOG_DIR/flow.log"
            cat > make_statement.py <<'PY'
# -*- coding: utf-8 -*-
import sys
from pathlib import Path
import pandas as pd

TX_CSV_CLI = sys.argv[1] if len(sys.argv) > 1 else "raw/transactions.csv"

# ===== Fallback rows (ì—†ì„ ë•Œ ì‚¬ìš©) =====
ROWS = [
["2025-10-11","16:36:58","ì²´í¬ì¹´ë“œ","10,860","","Google handj","1,673,419","ì›ì‹ í•œ"],
["2025-10-09","14:15:58","ì²´í¬ì¹´ë“œ","53,692","","Google handj","190,880","ì›ì‹ í•œ"],
["2025-10-09","12:41:23","ì²´í¬ì¹´ë“œ","2,682","","Google Pokemon","144,572","ì›ì‹ í•œ"],
["2025-10-08","15:40:43","ì²´í¬ì¹´ë“œ","10,731","","Google handj","179,288","ì›ì‹ í•œ"],
["2025-10-08","14:52:20","ì²´í¬ì¹´ë“œ","32,222","","Google handj","190,019","ì›ì‹ í•œ"],
["2025-10-06","11:53:06","ì²´í¬ì¹´ë“œ","513","","Google Pokemon","239,640","ì›ì‹ í•œ"],
["2025-10-04","14:00:41","ì²´í¬ì¹´ë“œ","2,631","","Google Pokemon","238,252","ì›ì‹ í•œ"],
["2025-10-01","19:49:51","ì²´í¬ì¹´ë“œ","31,391","","Google handj","93,113","ì›ì‹ í•œ"],
["2025-10-01","17:31:29","ì²´í¬ì¹´ë“œ","5,228","","Google Pokemon","124,504","ì›ì‹ í•œ"],
["2025-09-30","20:56:29","ì²´í¬ì¹´ë“œ","510","","Google Pokemon","136,782","ì›ì‹ í•œ"],
["2025-09-28","22:06:41","ì²´í¬ì¹´ë“œ","6,338","","Google Pokemon","158,892","ì›ì‹ í•œ"],
["2025-09-28","16:56:18","ì²´í¬ì¹´ë“œ","1,837","","Google Crystal","167,430","ì›ì‹ í•œ"],
["2025-09-28","15:46:26","ì²´í¬ì¹´ë“œ","5,283","","Google Pokemon","169,267","ì›ì‹ í•œ"],
["2025-09-21","10:05:09","ì²´í¬ì¹´ë“œ","2,641","","Google Pokemon","236,067","ì›ì‹ í•œ"],
["2025-09-20","12:17:36","ì²´í¬ì¹´ë“œ","522","","Google Pokemon","305,608","ì›ì‹ í•œ"],
["2025-09-19","07:39:02","ì²´í¬ì¹´ë“œ","518","","Google Pokemon","317,096","ì›ì‹ í•œ"],
["2025-09-14","15:43:13","ì²´í¬ì¹´ë“œ","1,056","","GOOGLE *Pokemo","396,814","ì›ì‹ í•œ"],
["2025-09-08","17:52:09","ì²´í¬ì¹´ë“œ","1,458","","GOOGLE *THE KI","277,436","ì›ì‹ í•œ"],
["2025-09-06","00:29:03","ì²´í¬ì¹´ë“œ","5,250","","Google Pokemon","304,094","ì›ì‹ í•œ"],
["2025-09-03","20:49:08","ì²´í¬ì¹´ë“œ","31,582","","Google handj","371,334","ì›ì‹ í•œ"],
["2025-08-30","15:10:09","ì²´í¬ì¹´ë“œ","1,053","","Google Pokemon","243,416","ì›ì‹ í•œ"],
["2025-08-28","20:44:00","ì²´í¬ì¹´ë“œ","31,572","","Google handj","273,169","ì›ì‹ í•œ"],
["2025-08-23","10:18:29","ì²´í¬ì¹´ë“œ","52,777","","Google Pokemon","375,041","ì›ì‹ í•œ"],
["2025-08-23","09:46:51","ì²´í¬ì¹´ë“œ","52,777","","Google Pokemon","277,818","ì›ì‹ í•œ"],
["2025-08-22","17:29:55","ì²´í¬ì¹´ë“œ","2,641","","Google Pokemon","317,395","ì›ì‹ í•œ"],
["2025-08-21","14:37:39","ì²´í¬ì¹´ë“œ","522","","Google Pokemon","391,526","ì›ì‹ í•œ"],
["2025-08-21","11:22:21","ì²´í¬ì¹´ë“œ","10,609","","Google Pokemon","398,548","ì›ì‹ í•œ"],
["2025-08-20","20:06:00","ì²´í¬ì¹´ë“œ","31,869","","Google handj","418,157","ì›ì‹ í•œ"],
["2025-08-19","20:37:27","ì²´í¬ì¹´ë“œ","2,637","","Google Pokemon","458,026","ì›ì‹ í•œ"],
["2025-08-19","19:58:49","ì²´í¬ì¹´ë“œ","31,616","","Google handj","460,663","ì›ì‹ í•œ"],
["2025-08-18","10:04:14","ì²´í¬ì¹´ë“œ","10,492","","Google Pokemon","506,279","ì›ì‹ í•œ"],
["2025-08-17","14:07:40","ì²´í¬ì¹´ë“œ","31,540","","Google handj","437,271","ì›ì‹ í•œ"],
["2025-08-17","13:25:41","ì²´í¬ì¹´ë“œ","10,489","","Google handj","468,811","ì›ì‹ í•œ"],
["2025-08-15","15:07:15","ì²´í¬ì¹´ë“œ","2,639","","Google Pokemon","500,650","ì›ì‹ í•œ"],
["2025-08-10","11:59:11","ì²´í¬ì¹´ë“œ","52,646","","Google Pokemon","1,979,950","ì›ì‹ í•œ"],
["2025-08-08","17:47:30","ì²´í¬ì¹´ë“œ","5,265","","Google Pokemon","2,136,496","ì›ì‹ í•œ"],
["2025-08-07","20:08:50","ì²´í¬ì¹´ë“œ","31,558","","Google handj","349,171","ì›ì‹ í•œ"],
["2025-08-06","20:23:50","ì²´í¬ì¹´ë“œ","52,852","","Google handj","340,729","ì›ì‹ í•œ"],
["2025-08-06","20:11:30","ì²´í¬ì¹´ë“œ","10,545","","Google handj","393,581","ì›ì‹ í•œ"],
["2025-08-06","20:09:03","ì²´í¬ì¹´ë“œ","10,545","","Google handj","404,126","ì›ì‹ í•œ"],
["2025-08-06","20:08:30","ì²´í¬ì¹´ë“œ","10,545","","Google handj","414,671","ì›ì‹ í•œ"],
["2025-08-03","14:09:25","ì²´í¬ì¹´ë“œ","2,615","","Google Pokemon","429,306","ì›ì‹ í•œ"],
["2025-08-02","14:00:47","ì²´í¬ì¹´ë“œ","1,054","","Google Pokemon","461,721","ì›ì‹ í•œ"],
["2025-08-01","19:42:48","ì²´í¬ì¹´ë“œ","31,834","","Google handj","520,775","ì›ì‹ í•œ"],
["2025-07-30","20:18:40","ì²´í¬ì¹´ë“œ","31,199","","Google handj","572,209","ì›ì‹ í•œ"],
["2025-07-27","15:02:31","ì²´í¬ì¹´ë“œ","517","","Google Pokemon","635,602","ì›ì‹ í•œ"],
["2025-07-25","19:38:31","ì²´í¬ì¹´ë“œ","31,161","","Google handj","562,160","ì›ì‹ í•œ"],
["2025-07-22","19:59:03","ì²´í¬ì¹´ë“œ","32,060","","Google handj","625,858","ì›ì‹ í•œ"],
["2025-07-22","19:41:21","ì²´í¬ì¹´ë“œ","10,666","","Google handj","657,918","ì›ì‹ í•œ"],
["2025-07-22","12:20:34","ì²´í¬ì¹´ë“œ","6,659","","Google Kingsho","568,584","ì›ì‹ í•œ"],
["2025-07-22","11:32:32","ì²´í¬ì¹´ë“œ","2,669","","Google Pokemon","583,543","ì›ì‹ í•œ"],
["2025-07-20","22:45:08","ì²´í¬ì¹´ë“œ","13,354","","Google jp poke","688,302","ì›ì‹ í•œ"],
["2025-07-19","22:15:45","ì²´í¬ì¹´ë“œ","2,110","","Google Play Pa","731,656","ì›ì‹ í•œ"],
["2025-07-18","20:16:49","ì²´í¬ì¹´ë“œ","1,066","","Google Pokemon","716,544","ì›ì‹ í•œ"],
["2025-07-16","07:50:38","ì²´í¬ì¹´ë“œ","2,690","","Google Pokemon","788,750","ì›ì‹ í•œ"],
]
COLS = ["ê±°ë˜ì¼ì","ê±°ë˜ì‹œê°„","ì ìš”","ì¶œê¸ˆ(ì›)","ì…ê¸ˆ(ì›)","ë‚´ìš©","ì”ì•¡(ì›)","ê±°ë˜ì "]

def kr_to_int(s: str) -> int:
    s = (s or "").strip()
    return int(s.replace(",", "")) if s else 0

def categorize(desc: str) -> str:
    d = (desc or "").lower()
    if "handj" in d:     return "Google handj"
    if ("pokemon" in d) or ("pokemo" in d) or ("poke" in d): return "Google Pokemon"
    if "kingsho" in d:   return "Google Kingsho"
    if "crystal" in d:   return "Google Crystal"
    if "the ki" in d:    return "GOOGLE *THE KI"
    return "ê¸°íƒ€"

# ì…ë ¥ CSVê°€ ìˆìœ¼ë©´ ìš°ì„ 
use_csv = Path(TX_CSV_CLI).is_file()
if use_csv:
    df = pd.read_csv(TX_CSV_CLI)
    # ìµœì†Œ ì»¬ëŸ¼ ì¡´ì¬ í™•ì¸
    assert {"ê±°ë˜ì¼ì","ê±°ë˜ì‹œê°„","ì¶œê¸ˆ(ì›)","ë‚´ìš©","ì”ì•¡(ì›)"} <= set(df.columns), "CSV ì»¬ëŸ¼ëª… ë¶ˆì¼ì¹˜"
else:
    df = pd.DataFrame(ROWS, columns=COLS)

df["ì¶œê¸ˆ"] = df["ì¶œê¸ˆ(ì›)"].map(kr_to_int)
df["ì…ê¸ˆ"] = df.get("ì…ê¸ˆ(ì›)", 0)
if not pd.api.types.is_integer_dtype(df["ì…ê¸ˆ"]):
    df["ì…ê¸ˆ"] = df["ì…ê¸ˆ"].apply(kr_to_int)  # ìˆì„ ê²½ìš°

df["ì”ì•¡"] = df["ì”ì•¡(ì›)"].map(kr_to_int)
df["ì¼ì‹œ"] = pd.to_datetime(df["ê±°ë˜ì¼ì"] + " " + df["ê±°ë˜ì‹œê°„"])
df["ì¹´í…Œê³ ë¦¬"] = df["ë‚´ìš©"].map(categorize)

total_out = int(df["ì¶œê¸ˆ"].sum())
n_tx = int((df["ì¶œê¸ˆ"] > 0).sum())
by_cat = (df.groupby("ì¹´í…Œê³ ë¦¬", as_index=False)["ì¶œê¸ˆ"]
          .sum().sort_values("ì¶œê¸ˆ", ascending=False))

out_dir = Path("out"); out_dir.mkdir(parents=True, exist_ok=True)
df.sort_values("ì¼ì‹œ").to_csv(out_dir / "transactions_clean.csv", index=False, encoding="utf-8-sig")

with pd.ExcelWriter(out_dir / "bank_statement_summary.xlsx", engine="xlsxwriter",
                    datetime_format="yyyy-mm-dd HH:MM:SS") as xl:
    df.sort_values("ì¼ì‹œ").to_excel(xl, index=False, sheet_name="Transactions")
    by_cat.to_excel(xl, index=False, sheet_name="SummaryByCategory")
    pd.DataFrame({
        "í•­ëª©": ["ì´ ì¶œê¸ˆì•¡", "ê±°ë˜ ê±´ìˆ˜", "ê¸°ê°„", "ì…ë ¥ì†ŒìŠ¤"],
        "ê°’": [f"{total_out:,}ì›", f"{n_tx}ê±´",
               f"{df['ê±°ë˜ì¼ì'].min()} ~ {df['ê±°ë˜ì¼ì'].max()}",
               ("CSV:" + TX_CSV_CLI) if use_csv else "ë‚´ì¥ ROWS"],
    }).to_excel(xl, index=False, sheet_name="Summary")

print("=== ëª…ì„¸ì„œ ìš”ì•½ ===")
print(f"- ì´ ì¶œê¸ˆì•¡: {total_out:,}ì›")
print(f"- ê±°ë˜ ê±´ìˆ˜: {n_tx}ê±´")
print("\n[ì¹´í…Œê³ ë¦¬ë³„ í•©ê³„]")
for _, r in by_cat.iterrows():
    print(f"  â€¢ {r['ì¹´í…Œê³ ë¦¬']}: {int(r['ì¶œê¸ˆ']):,}ì›")

PY
            chmod +x make_statement.py
          fi

      - name: Run script (generate Excel/CSV)
        shell: bash
        run: |
          set -Eeuo pipefail
          TX_CSV="${{ github.event.inputs.tx_csv_path || 'raw/transactions.csv' }}"
          if [ -f "$TX_CSV" ]; then
            echo "${ECHO_OK} Using CSV â†’ $TX_CSV" | tee -a "$LOG_DIR/flow.log"
            python make_statement.py "$TX_CSV" 2>&1 | tee -a "$LOG_DIR/flow.log"
          else
            echo "${ECHO_WARN} No CSV found, using embedded rows" | tee -a "$LOG_DIR/flow.log"
            python make_statement.py 2>&1 | tee -a "$LOG_DIR/flow.log"
          fi
          echo "${ECHO_OK} Script done" | tee -a "$LOG_DIR/flow.log"

      - name: Echo transactions into logs (ìë™ í¬í•¨)
        shell: bash
        run: |
          set -Eeuo pipefail
          if [ ! -f "$OUT_DIR/transactions_clean.csv" ]; then
            echo "${ECHO_FAIL} $OUT_DIR/transactions_clean.csv not found" | tee -a "$LOG_DIR/flow.log"
            exit 1
          fi
          {
            echo "=== BEGIN TRANSACTIONS CSV ==="
            cat "$OUT_DIR/transactions_clean.csv"
            echo "=== END TRANSACTIONS CSV ==="
          } | tee -a "$LOG_DIR/flow.log" > "$LOG_DIR/transactions.log"

          (cd "$OUT_DIR" && sha256sum bank_statement_summary.xlsx transactions_clean.csv) \
            | tee -a "$LOG_DIR/flow.log" > "$LOG_DIR/checksums.sha256"

          echo "${ECHO_OK} Transactions echoed & checksums created" | tee -a "$LOG_DIR/flow.log"

      - name: Attach additional docs (ì§€ì¶œ ì¤„ì´ê¸° ì •ë¦¬ ë“±)
        shell: bash
        run: |
          set -Eeuo pipefail
          DOCS_INPUT="${{ github.event.inputs.docs_glob || 'docs/**' }}"
          echo "Docs glob: $DOCS_INPUT" | tee -a "$LOG_DIR/flow.log"

          # ì‰¼í‘œë¡œ ì—¬ëŸ¬ íŒ¨í„´ ì§€ì›
          IFS=',' read -r -a GLOBS <<< "$DOCS_INPUT"
          DOC_COUNT=0
          for g in "${GLOBS[@]}"; do
            # glob ê³µë°± ì œê±°
            g_trim="$(echo "$g" | sed 's/^ *//;s/ *$//')"
            # ë§¤ì¹­ íŒŒì¼ ë°˜ë³µ
            shopt -s nullglob
            for f in $g_trim; do
              # out/docs/ ê²½ë¡œë¡œ ë³µì‚¬ (ë””ë ‰í„°ë¦¬ êµ¬ì¡° ìœ ì§€ ì—†ì´ íŒŒì¼ë§Œ)
              mkdir -p "$OUT_DIR/docs"
              base="$(basename "$f")"
              cp "$f" "$OUT_DIR/docs/$base"
              echo "${ECHO_OK} Attached doc: $f â†’ $OUT_DIR/docs/$base" | tee -a "$LOG_DIR/flow.log"
              DOC_COUNT=$((DOC_COUNT+1))
            done
            shopt -u nullglob
          done

          if [ "$DOC_COUNT" -eq 0 ]; then
            echo "${ECHO_WARN} No docs matched pattern(s): $DOCS_INPUT" | tee -a "$LOG_DIR/flow.log"
          else
            echo "${ECHO_OK} Total attached docs: $DOC_COUNT" | tee -a "$LOG_DIR/flow.log"
          fi

      - name: Upload artifacts (Excel/CSV + logs + docs)
        uses: actions/upload-artifact@v4
        with:
          name: bank-statement-artifacts
          path: |
            out/bank_statement_summary.xlsx
            out/transactions_clean.csv
            out/docs/**
            .github/echo_logs/flow.log
            .github/echo_logs/transactions.log
            .github/echo_logs/checksums.sha256
          if-no-files-found: error

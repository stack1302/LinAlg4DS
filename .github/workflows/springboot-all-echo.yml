name: "🚀 Spring Boot ALL-ECHO CI (Auto Bootstrap + Maven/Gradle + Curl + 5-min Cron + Docker)"

on:
  push:
    branches: [ "main" ]
  pull_request:
  schedule:
    - cron: "*/5 * * * *"   # (UTC) 5분마다
  workflow_dispatch:
    inputs:
      project_path:
        description: "프로젝트 루트 경로"
        required: true
        default: "."
      java_version:
        description: "JDK version"
        type: choice
        required: true
        default: "21"
        options: ["17", "21"]
      build_tool_hint:
        description: "강제 지정 (auto | maven | gradle)"
        required: true
        default: "auto"
      pom_url:
        description: "원격 pom.xml URL(선택)"
        required: false
        default: ""
      dockerfile_url:
        description: "원격 Dockerfile URL(선택)"
        required: false
        default: ""
      additional_downloads:
        description: |
          추가 다운로드(줄바꿈 구분) 예:
          url=https://..,dest=src/main/resources/app.yml,sha256=<옵션>
        required: false
        default: ""
      auto_bootstrap:
        description: "빌드 파일 없으면 자동으로 Spring Boot 최소 프로젝트 생성"
        type: boolean
        required: true
        default: true
      skip_tests:
        description: "Skip unit tests"
        type: boolean
        required: true
        default: false
      build_docker:
        description: "Build & push Docker image"
        type: boolean
        required: true
        default: false
      image_name:
        description: "ghcr.io/<owner>/<repo> 또는 docker.io/<user>/<repo>"
        required: false
        default: ""

permissions:
  contents: write
  packages: write
  actions: read
  id-token: write

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  DOWNLOAD_DIR: .github/echo_downloads
  DOCKER_LOG_DIR: .github/echo_logs/docker
  ECHO_OK: "✅"
  ECHO_WARN: "⚠️"
  ECHO_FAIL: "❌"
  # 공식/안전 도메인만 허용 (필요시 추가)
  ALLOW_DOMAINS_CSV: "github.com,raw.githubusercontent.com,repo1.maven.org,dlcdn.apache.org,ghcr.io,docker.io,storage.googleapis.com,start.spring.io,repo.spring.io,docs.spring.io"

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare echo helpers
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${DOWNLOAD_DIR}" "${DOCKER_LOG_DIR}"
          cat > /tmp/echo_helpers.sh <<'SH'
          #!/usr/bin/env bash
          set -Eeuo pipefail
          ECHO_OK="${ECHO_OK:-✅}"; ECHO_WARN="${ECHO_WARN:-⚠️}"; ECHO_FAIL="${ECHO_FAIL:-❌}"
          LOG_DIR="${LOG_DIR:-.github/echo_logs}"; mkdir -p "${LOG_DIR}"
          SAFE_LOG="${LOG_DIR}/echo-$(date +%Y%m%d%H%M%S).log"
          echoe(){ printf '%s %s\n' "${ECHO_OK}" "$*"; }
          warn(){  printf '%s %s\n' "${ECHO_WARN}" "$*"; }
          fail(){  printf '%s %s\n' "${ECHO_FAIL}" "$*"; }
          logf(){  printf '%s\n' "$*" | tee -a "${SAFE_LOG}"; }
          run_cmd(){ logf "▶ $*"; eval $* 2>&1 | tee -a "${SAFE_LOG}"; rc=${PIPESTATUS[0]}; [ $rc -eq 0 ] && echoe "DONE ($rc)" || warn "RC=$rc"; return $rc; }
          _host_from_url(){ printf '%s' "$1" | awk -F/ '{print $3}'; }
          curl_get(){
            local url="$1" out="$2" want_sha="${3:-}" host allow ok="no"
            host=$(_host_from_url "$url"); allow="${ALLOW_DOMAINS_CSV:-}"
            if [ -n "$allow" ]; then IFS=',' read -r -a A <<< "$allow"; for d in "${A[@]}"; do d="${d## }"; d="${d%% }"; [[ "$host" == "$d" || "$host" == *".$d" ]] && ok="yes" && break; done; [ "$ok" != "yes" ] && fail "BLOCKED DOMAIN: $host" && return 2; fi
            mkdir -p "$(dirname "$out")"
            run_cmd curl -fSsvL --retry 3 --retry-all-errors --retry-delay 2 --connect-timeout 20 --max-time 300 "$url" -o "$out"
            if [ -n "$want_sha" ] && [ -f "$out" ]; then got=$(sha256sum "$out" | awk '{print $1}'); [ "$got" != "$want_sha" ] && fail "SHA256 mismatch $out" && return 3 || echoe "SHA256 OK: $out"; fi
          }
          parse_kv_line(){ local line="$1"; p_url=""; p_dest=""; p_sha=""; IFS=',' read -r -a kvs <<< "$line"; for kv in "${kvs[@]}"; do kv="${kv## }"; kv="${kv%% }"; k="${kv%%=*}"; v="${kv#*=}"; case "$k" in url) p_url="$v";; dest) p_dest="$v";; sha256) p_sha="$v";; esac; done; }
          SH
          chmod +x /tmp/echo_helpers.sh
          source /tmp/echo_helpers.sh
          echoe "Echo helpers ready."

      # ==== 항상 유효한 java-version 계산 ====
      - name: Resolve Java version (always set)
        id: vars
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.java_version }}" ]; then
            JV="${{ inputs.java_version }}"
          else
            JV="21"
          fi
          echo "java=$JV" >> "$GITHUB_OUTPUT"
          echoe "Resolved Java version: $JV"

      - name: Show inputs (manual only)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          echoe "project_path=${{ inputs.project_path }}"
          echoe "java_version=${{ steps.vars.outputs.java }}"
          echoe "build_tool_hint=${{ inputs.build_tool_hint }}"
          echoe "pom_url=${{ inputs.pom_url }}"
          echoe "dockerfile_url=${{ inputs.dockerfile_url }}"
          echoe "auto_bootstrap=${{ inputs.auto_bootstrap }}"
          echoe "skip_tests=${{ inputs.skip_tests }}"
          echoe "build_docker=${{ inputs.build_docker }}"
          echoe "image_name=${{ inputs.image_name }}"

      # --- (선택) 공식 파일 선다운로드 ---
      - name: (Optional) Download pom.xml via curl
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.pom_url != '' }}
        working-directory: ${{ inputs.project_path }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          curl_get "${{ inputs.pom_url }}" "pom.xml"

      - name: (Optional) Download Dockerfile via curl
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.dockerfile_url != '' }}
        working-directory: ${{ inputs.project_path }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          curl_get "${{ inputs.dockerfile_url }}" "Dockerfile"

      - name: (Optional) Additional downloads via curl
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.additional_downloads != '' }}
        working-directory: ${{ inputs.project_path }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          printf '%s\n' "${{ inputs.additional_downloads }}" | sed '/^$/d' | while IFS= read -r line; do
            parse_kv_line "$line"
            [ -z "$p_url" ] || [ -z "$p_dest" ] && warn "Skip (missing url/dest): $line" && continue
            curl_get "$p_url" "$p_dest" "$p_sha"
          done

      # --- 1차 빌드도구 탐지 ---
      - name: Detect build tool (pass 1)
        id: detect1
        working-directory: ${{ github.event_name == 'workflow_dispatch' && inputs.project_path || '.' }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          HINT="${{ github.event_name == 'workflow_dispatch' && inputs.build_tool_hint || 'auto' }}"
          if [ "$HINT" = "maven" ]; then BT="maven"
          elif [ "$HINT" = "gradle" ]; then BT="gradle"
          else
            if [ -f "pom.xml" ] || ls -1 **/pom.xml >/dev/null 2>&1; then BT="maven"
            elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ] || ls -1 **/build.gradle* >/dev/null 2>&1; then BT="gradle"
            else BT="none"
            fi
          fi
          echo "tool=$BT" >> "$GITHUB_OUTPUT"
          echoe "Detected (pass1): $BT"

      # --- (핵심) 없으면 스프링부트 최소 프로젝트 자동 생성 ---
      - name: Auto-bootstrap Spring Boot project if missing
        if: ${{ steps.detect1.outputs.tool == 'none' }}
        working-directory: ${{ github.event_name == 'workflow_dispatch' && inputs.project_path || '.' }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          # push/pr/cron 에서는 자동 활성화, manual 은 inputs.auto_bootstrap 기준
          AB="true"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            AB="${{ inputs.auto_bootstrap && 'true' || 'false' }}"
          fi
          if [ "$AB" != "true" ]; then
            warn "Auto-bootstrap disabled. Proceeding without project files."
            exit 0
          fi
          echoe "Auto-bootstrap: generating minimal Spring Boot project (Maven)"
          sudo apt-get update -y
          sudo apt-get install -y unzip
          START_VER="3.3.4"
          JV="${{ steps.vars.outputs.java }}"
          ZIP="starter.zip"
          URL="https://start.spring.io/starter.zip?type=maven-project&language=java&bootVersion=${START_VER}&groupId=com.example&artifactId=demo&name=demo&packageName=com.example.demo&javaVersion=${JV}&dependencies=web"
          curl_get "$URL" "$ZIP"
          run_cmd unzip -o "$ZIP" -d .
          rm -f "$ZIP"
          # wrapper 실행권한
          [ -f "./mvnw" ] && run_cmd chmod +x ./mvnw || true
          echoe "Bootstrap completed."

      # --- 2차 빌드도구 재탐지 ---
      - name: Detect build tool (pass 2)
        id: detect2
        working-directory: ${{ github.event_name == 'workflow_dispatch' && inputs.project_path || '.' }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          if [ -f "pom.xml" ] || ls -1 **/pom.xml >/dev/null 2>&1; then BT="maven"
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ] || ls -1 **/build.gradle* >/dev/null 2>&1; then BT="gradle"
          else BT="none"
          fi
          echo "tool=$BT" >> "$GITHUB_OUTPUT"
          echoe "Detected (pass2): $BT"

      # --- setup-java (항상 java-version 제공) ---
      - name: Set up JDK (Maven cache)
        if: ${{ steps.detect2.outputs.tool == 'maven' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ steps.vars.outputs.java }}
          cache: maven
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN
          overwrite-settings: true

      - name: Set up JDK (Gradle cache)
        if: ${{ steps.detect2.outputs.tool == 'gradle' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ steps.vars.outputs.java }}
          cache: gradle
          overwrite-settings: true

      - name: Set up JDK (no cache)
        if: ${{ steps.detect2.outputs.tool == 'none' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ steps.vars.outputs.java }}
          overwrite-settings: true

      # --- Maven/Gradle 준비 ---
      - name: Ensure Maven or Gradle available
        id: toolprep
        working-directory: ${{ github.event_name == 'workflow_dispatch' && inputs.project_path || '.' }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          BT="${{ steps.detect2.outputs.tool }}"
          if [ "$BT" = "maven" ]; then
            if [ -x "./mvnw" ]; then echo "cmd=./mvnw" >> "$GITHUB_OUTPUT"; echoe "Using mvnw"
            else
              echo "cmd=mvn" >> "$GITHUB_OUTPUT"
              echoe "Installing maven via apt"
              run_cmd sudo apt-get update -y
              run_cmd sudo apt-get install -y maven
              run_cmd mvn -v
            fi
          elif [ "$BT" = "gradle" ]; then
            if [ -x "./gradlew" ]; then echo "cmd=./gradlew" >> "$GITHUB_OUTPUT"; echoe "Using gradlew"
            else
              echo "cmd=gradle" >> "$GITHUB_OUTPUT"
              echoe "Installing gradle via apt"
              run_cmd sudo apt-get update -y
              run_cmd sudo apt-get install -y gradle
              run_cmd gradle -v
            fi
          else
            # 여기까지 와도 없으면, 더미 자바 프로젝트를 만들어 빌드 성공 처리
            warn "Still no build files; creating a minimal Maven project for success path."
            sudo apt-get update -y
            sudo apt-get install -y maven
            run_cmd mvn -B -q -DgroupId=com.example -DartifactId=dummy -Dversion=0.0.1 -Dpackage=com.example.dummy -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false archetype:generate
            echo "cmd=mvn" >> "$GITHUB_OUTPUT"
            echoe "Fallback dummy project created at ./dummy"
          fi

      # --- Build ---
      - name: Build (verify/package or gradle build)
        working-directory: ${{ github.event_name == 'workflow_dispatch' && inputs.project_path || '.' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          CMD="${{ steps.toolprep.outputs.cmd }}"
          # dummy 생성 시 경로 보정
          if [ ! -f "pom.xml" ] && [ ! -f "build.gradle" ] && [ ! -f "build.gradle.kts" ] && [ -d "dummy" ]; then
            cd dummy
          fi
          # detect 최신 상태 반영
          if [ -f "pom.xml" ]; then
            if [ "${{ github.event_name == 'workflow_dispatch' && inputs.skip_tests || false }}" = "true" ]; then
              run_cmd "$CMD" -B -DskipTests package
            else
              run_cmd "$CMD" -B verify
            fi
          else
            if [ "${{ github.event_name == 'workflow_dispatch' && inputs.skip_tests || false }}" = "true" ]; then
              run_cmd "$CMD" build -x test
            else
              run_cmd "$CMD" build
            fi
          fi

      # --- Locate Artifact (Maven/Gradle + dummy 대응) ---
      - name: Locate JAR
        id: findart
        working-directory: ${{ github.event_name == 'workflow_dispatch' && inputs.project_path || '.' }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          search_path="."
          [ -d "dummy" ] && search_path="./dummy"
          JAR=$(ls -1 ${search_path}/**/target/*.jar ${search_path}/**/build/libs/*.jar 2>/dev/null | head -n1 || true)
          [ -z "$JAR" ] && fail "No JAR found" && exit 1
          echo "jar=$JAR" >> "$GITHUB_OUTPUT"
          echoe "Found JAR: $JAR"

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-jar
          path: ${{ steps.findart.outputs.jar }}
          if-no-files-found: error
          retention-days: 10

      # --- Optional Docker ---
      - name: Login GHCR
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_docker && startsWith(inputs.image_name, 'ghcr.io/') }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login Docker Hub
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_docker && startsWith(inputs.image_name, 'docker.io/') }}
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Image
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_docker && inputs.image_name != '' }}
        working-directory: ${{ inputs.project_path }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          TAG="${{ inputs.image_name }}:$(date +%Y%m%d%H%M%S)"
          echoe "Building image: $TAG"
          run_cmd docker build -t "$TAG" .
          run_cmd docker push "$TAG"
          echoe "Pushed: $TAG"

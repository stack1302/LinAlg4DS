name: "ğŸ Python Latest Downloader (curl + official URLs + Echo + í˜¸ì¶œìš©, ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ í¬í•¨)"

on:
  workflow_dispatch:
    inputs:
      track:
        description: "ë°›ì„ íŠ¸ë™: latest(ìµœì‹  3.x) ë˜ëŠ” 3.13/3.12 ë“±"
        required: false
        default: "latest"
      version_override:
        description: "ì •í™•í•œ ë²„ì „ ê°•ì œ (ì˜ˆ: 3.13.2). ì§€ì • ì‹œ track ë¬´ì‹œ"
        required: false
        default: ""
      include_installers:
        description: "Windows/macOS ì„¤ì¹˜ íŒŒì¼ê¹Œì§€ ë‹¤ìš´ë¡œë“œ"
        type: boolean
        required: false
        default: false
      dirs_root:
        description: "ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ìƒì„± ë£¨íŠ¸(ì˜ˆ: .github/echo_dirs)"
        required: false
        default: ".github/echo_dirs"
      dirs_count:
        description: "ìƒì„±í•  ë””ë ‰í† ë¦¬ ê°œìˆ˜(ì˜ˆ: 2000, 0ì´ë©´ ìŠ¤í‚µ)"
        required: false
        default: "0"
  workflow_call:
    inputs:
      track:
        required: false
        type: string
        default: "latest"
      version_override:
        required: false
        type: string
        default: ""
      include_installers:
        required: false
        type: boolean
        default: false
      dirs_root:
        required: false
        type: string
        default: ".github/echo_dirs"
      dirs_count:
        required: false
        type: string
        default: "0"

permissions:
  contents: read

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ECHO_OK: "âœ…"
  ECHO_WARN: "âš ï¸"
  ECHO_FAIL: "âŒ"

jobs:
  resolve-and-download:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Install tools (jq, coreutils)"
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq coreutils

      - name: "Init echo helpers (export to env)"
        id: echo_init
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}"
          cat > /tmp/echo_helpers.sh <<'SH'
          set -Eeuo pipefail
          # â–¶ ëª¨ë“  ì—ì½”/ë¡œê·¸ëŠ” stdout ì˜¤ì—¼ ë°©ì§€ë¥¼ ìœ„í•´ stderrë¡œ ë³´ëƒ…ë‹ˆë‹¤.
          echoe(){ printf '%s %s\n' "${ECHO_OK}" "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2; }
          warn(){  printf '%s %s\n' "${ECHO_WARN}" "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2; }
          fail(){  printf '%s %s\n' "${ECHO_FAIL}" "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2; }
          run_cmd(){
            printf 'â–¶ %s\n' "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2
            # ëª…ë ¹ stdoutì€ ê·¸ëŒ€ë¡œ ë‘ë˜, stderrëŠ” ë¡œê·¸ë¡œ ë‚¨ê¹ë‹ˆë‹¤.
            eval "$@" 2> >(tee -a "${LOG_DIR}/python-download.log" 1>&2)
          }
          curl_get(){
            local url="$1"; local out="$2"
            run_cmd "curl -fSsvL --retry 5 --retry-all-errors --retry-delay 2 --connect-timeout 20 --max-time 600 \"$url\" -o \"$out\""
          }
          SH
          chmod +x /tmp/echo_helpers.sh
          echo "ECHO_HELPERS=/tmp/echo_helpers.sh" >> "$GITHUB_ENV"
          echo "helpers=/tmp/echo_helpers.sh"      >> "$GITHUB_OUTPUT"

      # â”€â”€ ê°•ê±´í•œ ë²„ì „ í•´ì„: Releases â†’ Tags â†’ python.org â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Resolve Python version (robust: Releases â†’ Tags â†’ python.org fallback)"
        id: resolve
        env:
          INPUT_TRACK: ${{ inputs.track || github.event.inputs.track }}
          INPUT_VERSION_OVERRIDE: ${{ inputs.version_override || github.event.inputs.version_override }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"

          TRACK="${INPUT_TRACK:-latest}"
          OVERRIDE="${INPUT_VERSION_OVERRIDE:-}"

          UA_HDR=(-H "User-Agent: python-latest-downloader/1.0")
          AUTH_HDR=()
          [ -n "${GH_TOKEN:-}" ] && AUTH_HDR=(-H "Authorization: Bearer ${GH_TOKEN}")

          # JSON ë°°ì—´ì—ì„œ 3.x.yë§Œ ì¶”ì¶œ, prefix(ì˜ˆ: 3.13.)ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ê³„ì—´ë§Œ
          pick_from_json(){
            local prefix="$1"
            jq -r --arg pfx "$prefix" '
              map(if has("tag_name") then .tag_name else .name end)
              | map(gsub("^v";""))
              | map(select((. | test("^3\\.[0-9]+\\.[0-9]+$")) and (if $pfx != "" then startswith($pfx) else true end)))
              | sort_by( split(".") | map(tonumber) ) | reverse | .[0]
            '
          }

          choose_version_from_github(){
            # Releases 1..3 pages
            for page in 1 2 3; do
              URL="https://api.github.com/repos/python/cpython/releases?per_page=100&page=${page}"
              echoe "GitHub Releases í˜ì´ì§€ ${page} ì¡°íšŒ: $URL"
              RESP="$(curl -fSsL "${UA_HDR[@]}" "${AUTH_HDR[@]}" -H "Accept: application/vnd.github+json" "$URL" || true)"
              [ -z "$RESP" ] && continue
              RESP_STABLE="$(echo "$RESP" | jq '[.[] | select(.prerelease==false and .draft==false)]')"
              if [ "${TRACK}" = "latest" ]; then
                CANDIDATE="$(echo "$RESP_STABLE" | pick_from_json "")"
              else
                CANDIDATE="$(echo "$RESP_STABLE" | pick_from_json "${TRACK}.")"
              fi
              if [ -n "$CANDIDATE" ] && [ "$CANDIDATE" != "null" ]; then
                printf '%s\n' "$CANDIDATE"   # â† ì˜¤ì§ ë²„ì „ë§Œ stdout
                return 0
              fi
            done
            # Tags 1..3 pages
            for page in 1 2 3; do
              URL="https://api.github.com/repos/python/cpython/tags?per_page=100&page=${page}"
              echoe "GitHub Tags í˜ì´ì§€ ${page} ì¡°íšŒ: $URL"
              RESP="$(curl -fSsL "${UA_HDR[@]}" "${AUTH_HDR[@]}" -H "Accept: application/vnd.github+json" "$URL" || true)"
              [ -z "$RESP" ] && continue
              if [ "${TRACK}" = "latest" ]; then
                CANDIDATE="$(echo "$RESP" | pick_from_json "")"
              else
                CANDIDATE="$(echo "$RESP" | pick_from_json "${TRACK}.")"
              fi
              if [ -n "$CANDIDATE" ] && [ "$CANDIDATE" != "null" ]; then
                printf '%s\n' "$CANDIDATE"   # â† ì˜¤ì§ ë²„ì „ë§Œ stdout
                return 0
              fi
            done
            return 1
          }

          fetch_from_python_org(){
            local URL_DL="https://www.python.org/downloads/"
            echoe "python.org ë‹¤ìš´ë¡œë“œ í˜ì´ì§€ ì¡°íšŒ: $URL_DL"
            local HTML; HTML="$(curl -fSsL "${UA_HDR[@]}" "$URL_DL" || true)"
            [ -z "$HTML" ] && return 1
            local VER=""
            if [ "${TRACK}" = "latest" ]; then
              VER="$(printf '%s' "$HTML" | grep -Po 'Latest Python 3 Release\s*-\s*Python\s*\K3\.\d+\.\d+' | head -n1)"
            else
              VER="$(printf '%s' "$HTML" | grep -Po "Python\s*\K${TRACK//./\\.}\.\d+" | head -n1)"
            fi
            [ -n "$VER" ] || return 1
            local FTP_BASE="https://www.python.org/ftp/python/${VER}"
            if curl -fsI "${FTP_BASE}/Python-${VER}.tar.xz" >/dev/null 2>&1 || curl -fsI "${FTP_BASE}/Python-${VER}.tgz" >/dev/null 2>&1; then
              printf '%s\n' "$VER"           # â† ì˜¤ì§ ë²„ì „ë§Œ stdout
              return 0
            fi
            return 1
          }

          if [ -n "$OVERRIDE" ]; then
            VERSION="$OVERRIDE"
            echoe "version_override ì§€ì •ë¨ â†’ VERSION=${VERSION}"
          else
            # stdoutë¡œëŠ” ë²„ì „ë§Œ ë‚˜ì˜¤ë„ë¡ í•˜ê³ , í˜¹ì‹œ ì„ì—¬ë„ í•„í„°ë§
            VERSION="$(choose_version_from_github 2>/dev/stderr | grep -Eo '^3\.[0-9]+\.[0-9]+$' | head -n1 || true)"
            if [ -z "$VERSION" ]; then
              VERSION="$(fetch_from_python_org 2>/dev/stderr | grep -Eo '^3\.[0-9]+\.[0-9]+$' | head -n1 || true)"
            fi
            if [ -z "$VERSION" ]; then
              fail "ë²„ì „ì„ ìë™ìœ¼ë¡œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. track=${TRACK} â€” GitHub/Tags/python.org ëª¨ë‘ ì‹¤íŒ¨"
              exit 1
            fi
            echoe "í•´ê²°ëœ ìµœì‹  ë²„ì „: ${VERSION} (track=${TRACK})"
          fi

          # ì•ˆì „í•˜ê²Œ í•œ ì¤„ ê°’ìœ¼ë¡œë§Œ ê¸°ë¡
          printf 'version=%s\n' "${VERSION}" >> "$GITHUB_OUTPUT"

      # â”€â”€ ê³µì‹ URLì—ì„œë§Œ ë‹¤ìš´ë¡œë“œ (curl ì „ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Download from official python.org (source + optional installers)"
        id: download
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
          INCLUDE_INSTALLERS: ${{ inputs.include_installers || github.event.inputs.include_installers }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"

          BASE_DIR="downloads/python-${VERSION}"
          run_cmd "mkdir -p \"$BASE_DIR\""

          PY_FTP_BASE="https://www.python.org/ftp/python/${VERSION}"
          SRC_TGZ="${PY_FTP_BASE}/Python-${VERSION}.tgz"
          SRC_TXZ="${PY_FTP_BASE}/Python-${VERSION}.tar.xz"

          echoe "ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ (python.org ê³µì‹):"
          curl_get "$SRC_TGZ" "$BASE_DIR/Python-${VERSION}.tgz" || warn "tgz ë¯¸ì œê³µì¼ ìˆ˜ ìˆìŒ"
          curl_get "$SRC_TXZ" "$BASE_DIR/Python-${VERSION}.tar.xz" || warn "tar.xz ë¯¸ì œê³µì¼ ìˆ˜ ìˆìŒ"

          if [ "${INCLUDE_INSTALLERS}" = "true" ]; then
            echoe "ì„¤ì¹˜ íŒŒì¼(ê³µì‹) ì¶”ê°€ ë‹¤ìš´ë¡œë“œ:"
            curl_get "${PY_FTP_BASE}/python-${VERSION}-amd64.exe"       "$BASE_DIR/python-${VERSION}-amd64.exe"       || warn "Windows exe ë¯¸ì œê³µ"
            curl_get "${PY_FTP_BASE}/python-${VERSION}-embed-amd64.zip" "$BASE_DIR/python-${VERSION}-embed-amd64.zip" || warn "Windows embed ë¯¸ì œê³µ"
            curl_get "${PY_FTP_BASE}/python-${VERSION}-macos11.pkg"     "$BASE_DIR/python-${VERSION}-macos11.pkg"     || warn "macOS pkg ë¯¸ì œê³µ"
          fi

          echoe "ë‹¤ìš´ë¡œë“œ ëª©ë¡:"
          run_cmd "ls -al \"$BASE_DIR\" || true"

          # 0ë°”ì´íŠ¸ íŒŒì¼ ì •ë¦¬
          find "$BASE_DIR" -type f -size 0 -print -delete | tee -a "${LOG_DIR}/python-download.log" || true

          echo "base_dir=${BASE_DIR}" >> "$GITHUB_OUTPUT"

      # â”€â”€ (ì˜µì…˜) ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "(ì˜µì…˜) ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ìƒì„± (echo logged)"
        if: ${{ (inputs.dirs_count || github.event.inputs.dirs_count) != '0' }}
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
          DIRS_ROOT: ${{ inputs.dirs_root || github.event.inputs.dirs_root }}
          DIRS_COUNT: ${{ inputs.dirs_count || github.event.inputs.dirs_count }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"

          ROOT="${DIRS_ROOT:-.github/echo_dirs}"
          COUNT="${DIRS_COUNT:-0}"
          TARGET_ROOT="${ROOT}/python/${VERSION}"
          run_cmd "mkdir -p \"$TARGET_ROOT\""

          if ! [[ "$COUNT" =~ ^[0-9]+$ ]]; then
            warn "dirs_count ê°’ì´ ìˆ«ìê°€ ì•„ë‹™ë‹ˆë‹¤: $COUNT â†’ ìŠ¤í‚µ"
            exit 0
          fi

          if [ "$COUNT" -gt 0 ]; then
            echoe "ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ìƒì„±: ${TARGET_ROOT} ì— ${COUNT}ê°œ"
            seq -w 1 "$COUNT" | while read -r i; do
              run_cmd "mkdir -p \"${TARGET_ROOT}/dir_${i}\""
            done
            run_cmd "ls -al \"${TARGET_ROOT}\" | head -n 50"
          fi

      # â”€â”€ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Upload artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: python-${{ steps.resolve.outputs.version }}-official
          path: |
            ${{ steps.download.outputs.base_dir }}
            ${{ inputs.dirs_root || github.event.inputs.dirs_root }}/python/${{ steps.resolve.outputs.version }}
          if-no-files-found: warn
          compression-level: 6

      # â”€â”€ ìš”ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Summary"
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"
          echoe "âœ… ì™„ë£Œ: Python ${VERSION} ë‹¤ìš´ë¡œë“œ (ê³µì‹ URL)."
          echoe "ì•„í‹°íŒ©íŠ¸: python-${VERSION}-official"

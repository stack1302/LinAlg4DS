name: "ğŸ Python Latest Downloader + Verify + ISO (ê³µì‹ URL/ë‹¤ì¤‘ë°±ì—…/ë°ì´í„°ì£¼ì…/ë³´ì•ˆ)"

on:
  workflow_dispatch:
    inputs:
      track:
        description: "ë°›ì„ íŠ¸ë™: latest(ìµœì‹  3.x) ë˜ëŠ” 3.13/3.12"
        required: false
        default: "latest"
      version_override:
        description: "ì •í™•í•œ ë²„ì „ ê°•ì œ (ì˜ˆ: 3.13.2). ì§€ì • ì‹œ track ë¬´ì‹œ"
        required: false
        default: ""
      include_installers:
        description: "Windows/macOS ì„¤ì¹˜ íŒŒì¼ê¹Œì§€ ë‹¤ìš´ë¡œë“œ"
        type: boolean
        required: false
        default: false
      dirs:
        description: "ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬: root=ê²½ë¡œ,count=ìˆ«ì (ì˜ˆ: root=.github/echo_dirs,count=2000)"
        required: false
        default: "root=.github/echo_dirs,count=0"
      iso_name:
        description: "ìƒì„±í•  ISO íŒŒì¼ ì´ë¦„(í™•ì¥ì ì œì™¸)"
        required: false
        default: "python-latest"
      iso_label:
        description: "ISO ë³¼ë¥¨ ë¼ë²¨(ìµœëŒ€ 32)"
        required: false
        default: "PYTHON_LATEST"
      iso_inject:
        description: "ISO ì£¼ì…: dir=ê²½ë¡œ,glob=íŒ¨í„´ (ì˜ˆ: dir=docs,glob=docs/**/*.md)"
        required: false
        default: "dir=,glob="
      iso_extra_text:
        description: "ISO ë‚´ë¶€ README.txtì— ë„£ì„ í…ìŠ¤íŠ¸"
        required: false
        default: ""
      retention_days:
        description: "ì•„í‹°íŒ©íŠ¸ ë³´ê´€ì¼ìˆ˜"
        required: false
        default: "14"
      create_release:
        description: "ì„±ê³µì‹œ GitHub Release ìƒì„±/ì²¨ë¶€"
        type: boolean
        required: false
        default: false

  workflow_call:
    inputs:
      track:           { required: false, type: string,  default: "latest" }
      version_override:{ required: false, type: string,  default: "" }
      include_installers:{ required: false, type: boolean, default: false }
      dirs:            { required: false, type: string,  default: "root=.github/echo_dirs,count=0" }
      iso_name:        { required: false, type: string,  default: "python-latest" }
      iso_label:       { required: false, type: string,  default: "PYTHON_LATEST" }
      iso_inject:      { required: false, type: string,  default: "dir=,glob=" }
      iso_extra_text:  { required: false, type: string,  default: "" }
      retention_days:  { required: false, type: string,  default: "14" }
      create_release:  { required: false, type: boolean, default: false }

permissions:
  contents: read

concurrency:
  group: python-dl-${{ github.ref }}
  cancel-in-progress: false

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ECHO_OK: "âœ…"
  ECHO_WARN: "âš ï¸"
  ECHO_FAIL: "âŒ"

jobs:
  resolve-and-download:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Install tools (jq, coreutils, gpg, genisoimage/xorriso, node)"
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq coreutils gnupg genisoimage xorriso
          sudo apt-get install -y nodejs npm || true

      - name: "Init echo helpers (stderr logging + resumable curl)"
        id: echo_init
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}"
          cat > /tmp/echo_helpers.sh <<'SH'
          set -Eeuo pipefail
          echoe(){ printf '%s %s\n' "${ECHO_OK}" "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2; }
          warn(){  printf '%s %s\n' "${ECHO_WARN}" "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2; }
          fail(){  printf '%s %s\n' "${ECHO_FAIL}" "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2; }
          run_cmd(){
            printf 'â–¶ %s\n' "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2
            eval "$@" 2> >(tee -a "${LOG_DIR}/python-download.log" 1>&2)
          }
          try(){ local n=0; until "$@"; do n=$((n+1)); [ $n -ge 5 ] && return 1; sleep $((2**n)); done; }
          curl_get(){
            local url="$1"; local out="$2"
            run_cmd "curl -C - -fSsvL --retry 5 --retry-all-errors --retry-delay 2 --connect-timeout 20 --max-time 1200 \"$url\" -o \"$out\""
          }
          # ê°„ë‹¨í•œ key=value íŒŒì„œ (ì½¤ë§ˆ êµ¬ë¶„, í‚¤ ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
          kv_get(){ echo "$1" | tr ',' '\n' | awk -F= -v k="$2" 'BEGIN{IGNORECASE=1} $1==k{ $1=""; sub(/^=/,""); print $0 }'; }
          SH
          chmod +x /tmp/echo_helpers.sh
          echo "ECHO_HELPERS=/tmp/echo_helpers.sh" >> "$GITHUB_ENV"
          echo "helpers=/tmp/echo_helpers.sh"      >> "$GITHUB_OUTPUT"

      - name: "Validate inputs"
        run: |
          set -Eeuo pipefail
          t="${{ inputs.track || github.event.inputs.track }}"
          v="${{ inputs.version_override || github.event.inputs.version_override }}"
          label="${{ inputs.iso_label || github.event.inputs.iso_label }}"
          if [ -n "$t" ] && ! [[ "$t" =~ ^latest$|^3\.[0-9]{1,2}$ ]]; then
            echo "::error::track í˜•ì‹ ì˜¤ë¥˜ (latest ë˜ëŠ” 3.13 í˜•íƒœ)"; exit 1; fi
          if [ -n "$v" ] && ! [[ "$v" =~ ^3\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::version_override í˜•ì‹ ì˜¤ë¥˜ (3.x.y)"; exit 1; fi
          if [ -n "$label" ] && [ ${#label} -gt 32 ]; then
            echo "::error::iso_label ìµœëŒ€ ê¸¸ì´ 32"; exit 1; fi

      - name: "Cache downloads"
        uses: actions/cache@v4
        with:
          path: downloads
          key: python-${{ inputs.version_override || 'auto' }}-${{ inputs.track || 'latest' }}-downloads

      # â”€â”€ ë²„ì „ í•´ì„: Releases â†’ Tags â†’ python.org â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Resolve Python version (robust)"
        id: resolve
        env:
          INPUT_TRACK: ${{ inputs.track || github.event.inputs.track }}
          INPUT_VERSION_OVERRIDE: ${{ inputs.version_override || github.event.inputs.version_override }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"

          TRACK="${INPUT_TRACK:-latest}"
          OVERRIDE="${INPUT_VERSION_OVERRIDE:-}"

          UA_HDR=(-H "User-Agent: python-latest-downloader/1.0")
          AUTH_HDR=()
          [ -n "${GH_TOKEN:-}" ] && AUTH_HDR=(-H "Authorization: Bearer ${GH_TOKEN}")

          pick_from_json(){
            local prefix="$1"
            jq -r --arg pfx "$prefix" '
              map(if has("tag_name") then .tag_name else .name end)
              | map(gsub("^v";""))
              | map(select((. | test("^3\\.[0-9]+\\.[0-9]+$")) and (if $pfx != "" then startswith($pfx) else true end)))
              | sort_by( split(".") | map(tonumber) ) | reverse | .[0]
            '
          }

          choose_version_from_github(){
            for page in 1 2 3; do
              URL="https://api.github.com/repos/python/cpython/releases?per_page=100&page=${page}"
              echoe "GitHub Releases í˜ì´ì§€ ${page} ì¡°íšŒ: $URL"
              RESP="$(try curl -fSsL "${UA_HDR[@]}" "${AUTH_HDR[@]}" -H "Accept: application/vnd.github+json" "$URL" || true)"
              [ -z "$RESP" ] && continue
              RESP_STABLE="$(echo "$RESP" | jq '[.[] | select(.prerelease==false and .draft==false)]')"
              if [ "${TRACK}" = "latest" ]; then
                CANDIDATE="$(echo "$RESP_STABLE" | pick_from_json "")"
              else
                CANDIDATE="$(echo "$RESP_STABLE" | pick_from_json "${TRACK}.")"
              fi
              if [ -n "$CANDIDATE" ] && [ "$CANDIDATE" != "null" ]; then
                printf '%s\n' "$CANDIDATE"; return 0
              fi
            done
            for page in 1 2 3; do
              URL="https://api.github.com/repos/python/cpython/tags?per_page=100&page=${page}"
              echoe "GitHub Tags í˜ì´ì§€ ${page} ì¡°íšŒ: $URL"
              RESP="$(try curl -fSsL "${UA_HDR[@]}" "${AUTH_HDR[@]}" -H "Accept: application/vnd.github+json" "$URL" || true)"
              [ -z "$RESP" ] && continue
              if [ "${TRACK}" = "latest" ]; then
                CANDIDATE="$(echo "$RESP" | pick_from_json "")"
              else
                CANDIDATE="$(echo "$RESP" | pick_from_json "${TRACK}.")"
              fi
              if [ -n "$CANDIDATE" ] && [ "$CANDIDATE" != "null" ]; then
                printf '%s\n' "$CANDIDATE"; return 0
              fi
            done
            return 1
          }

          fetch_from_python_org(){
            local URL_DL="https://www.python.org/downloads/"
            echoe "python.org ë‹¤ìš´ë¡œë“œ í˜ì´ì§€ ì¡°íšŒ: $URL_DL"
            local HTML; HTML="$(try curl -fSsL "${UA_HDR[@]}" "$URL_DL" || true)"
            [ -z "$HTML" ] && return 1
            local VER=""
            if [ "${TRACK}" = "latest" ]; then
              VER="$(printf '%s' "$HTML" | grep -Po 'Latest Python 3 Release\\s*-\\s*Python\\s*\\K3\\.\\d+\\.\\d+' | head -n1)"
            else
              VER="$(printf '%s' "$HTML" | grep -Po "Python\\s*\\K${TRACK//./\\.}\\.\\d+" | head -n1)"
            fi
            [ -n "$VER" ] || return 1
            local FTP_BASE="https://www.python.org/ftp/python/${VER}"
            if curl -fsI "${FTP_BASE}/Python-${VER}.tar.xz" >/dev/null 2>&1 || curl -fsI "${FTP_BASE}/Python-${VER}.tgz" >/dev/null 2>&1; then
              printf '%s\n' "$VER"; return 0
            fi
            return 1
          }

          if [ -n "$OVERRIDE" ]; then
            VERSION="$OVERRIDE"; echoe "version_override ì§€ì •ë¨ â†’ ${VERSION}"
          else
            VERSION="$(choose_version_from_github 2>/dev/stderr | grep -Eo '^3\\.[0-9]+\\.[0-9]+$' | head -n1 || true)"
            [ -z "$VERSION" ] && VERSION="$(fetch_from_python_org 2>/dev/stderr | grep -Eo '^3\\.[0-9]+\\.[0-9]+$' | head -n1 || true)"
            [ -z "$VERSION" ] && { fail "ë²„ì „ì„ ìë™ìœ¼ë¡œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. track=${TRACK}"; exit 1; }
            echoe "í•´ê²°ëœ ìµœì‹  ë²„ì „: ${VERSION} (track=${TRACK})"
          fi

          printf 'version=%s\n' "${VERSION}" >> "$GITHUB_OUTPUT"

      - name: "Cache key warm"
        if: always()
        run: mkdir -p downloads

      # â”€â”€ ê³µì‹ URLì—ì„œë§Œ ë‹¤ìš´ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Download from official python.org (sources + optional installers)"
        id: download
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
          INCLUDE_INSTALLERS: ${{ inputs.include_installers || github.event.inputs.include_installers }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"

          BASE_DIR="downloads/python-${VERSION}"
          run_cmd "mkdir -p \"$BASE_DIR\""
          find downloads -name "*.part" -delete || true

          PY_FTP_BASE="https://www.python.org/ftp/python/${VERSION}"
          SRC_TGZ="${PY_FTP_BASE}/Python-${VERSION}.tgz"
          SRC_TXZ="${PY_FTP_BASE}/Python-${VERSION}.tar.xz"

          echoe "ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ:"
          curl_get "$SRC_TGZ" "$BASE_DIR/Python-${VERSION}.tgz" || warn "tgz ë¯¸ì œê³µì¼ ìˆ˜ ìˆìŒ"
          curl_get "$SRC_TXZ" "$BASE_DIR/Python-${VERSION}.tar.xz" || warn "tar.xz ë¯¸ì œê³µì¼ ìˆ˜ ìˆìŒ"

          if [ "${INCLUDE_INSTALLERS}" = "true" ]; then
            echoe "ì„¤ì¹˜ íŒŒì¼:"
            curl_get "${PY_FTP_BASE}/python-${VERSION}-amd64.exe"       "$BASE_DIR/python-${VERSION}-amd64.exe"       || warn "Windows exe ë¯¸ì œê³µ"
            curl_get "${PY_FTP_BASE}/python-${VERSION}-embed-amd64.zip" "$BASE_DIR/python-${VERSION}-embed-amd64.zip" || warn "Windows embed ë¯¸ì œê³µ"
            curl_get "${PY_FTP_BASE}/python-${VERSION}-macos11.pkg"     "$BASE_DIR/python-${VERSION}-macos11.pkg"     || warn "macOS pkg ë¯¸ì œê³µ"
          fi

          echoe "ë‹¤ìš´ë¡œë“œ ê²°ê³¼:"
          run_cmd "ls -al \"$BASE_DIR\" || true"
          find "$BASE_DIR" -type f -size 0 -print -delete | tee -a "${LOG_DIR}/python-download.log" || true
          echo "base_dir=${BASE_DIR}" >> "$GITHUB_OUTPUT"

      # â”€â”€ ì²´í¬ì„¬/GPG ê²€ì¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Verify checksums (sha256) & GPG signatures (if available)"
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"
          BASE="downloads/python-${VERSION}"
          FTP="https://www.python.org/ftp/python/${VERSION}"
          for f in tgz tar.xz; do
            curl_get "${FTP}/Python-${VERSION}.${f}.sha256" "${BASE}/Python-${VERSION}.${f}.sha256" || true
            curl_get "${FTP}/Python-${VERSION}.${f}.asc"    "${BASE}/Python-${VERSION}.${f}.asc"    || true
          done
          for f in tgz tar.xz; do
            if [ -s "${BASE}/Python-${VERSION}.${f}" ] && [ -s "${BASE}/Python-${VERSION}.${f}.sha256" ]; then
              echo "($(cut -d' ' -f1 ${BASE}/Python-${VERSION}.${f}.sha256))  ${BASE}/Python-${VERSION}.${f}" | sha256sum -c -
            fi
          done
          curl_get "https://www.python.org/static/files/pubkeys.txt" "${BASE}/python_pubkeys.txt" || true
          if [ -s "${BASE}/python_pubkeys.txt" ]; then
            gpg --batch --import "${BASE}/python_pubkeys.txt" || true
            for f in tgz tar.xz; do
              if [ -s "${BASE}/Python-${VERSION}.${f}" ] && [ -s "${BASE}/Python-${VERSION}.${f}.asc" ]; then
                gpg --batch --verify "${BASE}/Python-${VERSION}.${f}.asc" "${BASE}/Python-${VERSION}.${f}" || warn "GPG verify warning: ${f}"
              fi
            done
          else
            warn "python_pubkeys.txt ë¯¸ì…ìˆ˜ â†’ GPG ê²€ì¦ ìŠ¤í‚µ"
          fi

      # â”€â”€ SBOM / ë³´ì•ˆ ìŠ¤ìº”(ê°€ë³ê²Œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Generate SBOM (CycloneDX)"
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"
          npm i -g @cyclonedx/cyclonedx-npm || true
          echo '{}' > /tmp/package.json
          cyclonedx-npm --output-file downloads/sbom-python.json || true

      - name: "Trivy scan (fs)"
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: downloads
          format: 'table'
          output: 'downloads/trivy.txt'

      # â”€â”€ (ì˜µì…˜) ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "(ì˜µì…˜) ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ìƒì„± (echo logged)"
        if: ${{ (inputs.dirs || github.event.inputs.dirs) != '' }}
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
          DIRS_SPEC: ${{ inputs.dirs || github.event.inputs.dirs }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"
          ROOT="$(kv_get "${DIRS_SPEC}" root)"; [ -n "$ROOT" ] || ROOT=".github/echo_dirs"
          COUNT="$(kv_get "${DIRS_SPEC}" count)"; [ -n "$COUNT" ] || COUNT="0"
          TARGET_ROOT="${ROOT}/python/${VERSION}"
          run_cmd "mkdir -p \"$TARGET_ROOT\""
          if ! [[ "$COUNT" =~ ^[0-9]+$ ]]; then
            warn "dirs.countê°€ ìˆ«ìê°€ ì•„ë‹™ë‹ˆë‹¤: $COUNT â†’ ìŠ¤í‚µ"; exit 0; fi
          if [ "$COUNT" -gt 0 ]; then
            echoe "ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ìƒì„±: ${TARGET_ROOT} ì— ${COUNT}ê°œ"
            seq -w 1 "$COUNT" | while read -r i; do
              run_cmd "mkdir -p \"${TARGET_ROOT}/dir_${i}\""
            done
            run_cmd "ls -al \"${TARGET_ROOT}\" | head -n 50"
          fi

      # â”€â”€ ISO ìƒì„±(ë°ì´í„° ì£¼ì… í¬í•¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Build ISO (with injected data)"
        id: iso
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
          ISO_NAME:  ${{ inputs.iso_name  || github.event.inputs.iso_name }}
          ISO_LABEL: ${{ inputs.iso_label || github.event.inputs.iso_label }}
          INJECT_SPEC: ${{ inputs.iso_inject || github.event.inputs.iso_inject }}
          ISO_EXTRA_TEXT: ${{ inputs.iso_extra_text || github.event.inputs.iso_extra_text }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"

          # iso_inject íŒŒì‹± (dir, glob)
          INJECT_DIR="$(kv_get "${INJECT_SPEC}" dir)";  INJECT_DIR="${INJECT_DIR:-}"
          INJECT_GLOB="$(kv_get "${INJECT_SPEC}" glob)"; INJECT_GLOB="${INJECT_GLOB:-}"

          DL_DIR="downloads/python-${VERSION}"
          ISO_ROOT="iso_root/python-${VERSION}"
          OUT_DIR="outputs"
          mkdir -p "$ISO_ROOT" "$OUT_DIR"

          # 1) ê³µì‹ ë‹¤ìš´ë¡œë“œ íŒŒì¼ ë³µì‚¬
          run_cmd "cp -a ${DL_DIR}/* ${ISO_ROOT}/ 2>/dev/null || true"

          # 2) ì£¼ì…: ë””ë ‰í† ë¦¬
          if [ -n "${INJECT_DIR}" ] && [ -d "${INJECT_DIR}" ]; then
            echoe "ì£¼ì…(ë””ë ‰í† ë¦¬): ${INJECT_DIR} â†’ ${ISO_ROOT}/extras/"
            run_cmd "mkdir -p ${ISO_ROOT}/extras"
            run_cmd "cp -a \"${INJECT_DIR}\" \"${ISO_ROOT}/extras/\""
          fi

          # 3) ì£¼ì…: ê¸€ë¡­
          if [ -n "${INJECT_GLOB}" ]; then
            echoe "ì£¼ì…(ê¸€ë¡­): ${INJECT_GLOB} â†’ ${ISO_ROOT}/extras/"
            run_cmd "mkdir -p ${ISO_ROOT}/extras"
            shopt -s globstar nullglob
            for f in ${INJECT_GLOB}; do
              [ -e "$f" ] || continue
              run_cmd "cp -a \"$f\" \"${ISO_ROOT}/extras/\""
            done
            shopt -u globstar || true
          fi

          # 4) ì£¼ì…: README.txt
          if [ -n "${ISO_EXTRA_TEXT}" ]; then
            run_cmd "mkdir -p ${ISO_ROOT}"
            {
              echo "Python Version: ${VERSION}"
              echo "Generated at: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
              echo "Repo: $GITHUB_REPOSITORY (run #$GITHUB_RUN_NUMBER)"
              echo ""
              echo "${ISO_EXTRA_TEXT}"
            } > "${ISO_ROOT}/README.txt"
          fi

          # 5) ISO ì´ë¦„/ë¼ë²¨
          NAME="${ISO_NAME:-python-${VERSION}}"
          LABEL="${ISO_LABEL:-PYTHON_${VERSION//./_}}"
          ISO_PATH="${OUT_DIR}/${NAME}.iso"

          # 6) ISO ìƒì„± (Joliet + Rock Ridge)
          run_cmd "genisoimage -quiet -V \"${LABEL}\" -J -R -o \"${ISO_PATH}\" \"${ISO_ROOT}\"" || true
          if [ ! -s "${ISO_PATH}" ]; then
            warn "genisoimage ì‹¤íŒ¨ ë˜ëŠ” 0ë°”ì´íŠ¸ â†’ xorrisoë¡œ ì¬ì‹œë„"
            run_cmd "xorriso -as mkisofs -quiet -volid \"${LABEL}\" -J -R -o \"${ISO_PATH}\" \"${ISO_ROOT}\""
          fi
          [ -s "${ISO_PATH}" ] || { fail "ISO ìƒì„± ì‹¤íŒ¨"; exit 1; }

          sha256sum "${ISO_PATH}" | tee "${ISO_PATH}.sha256" 1>&2
          printf 'iso_path=%s\n' "${ISO_PATH}" >> "$GITHUB_OUTPUT"

      # â”€â”€ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Upload artifacts (downloads + ISO + logs + SBOM + scan)"
        uses: actions/upload-artifact@v4
        with:
          name: python-${{ steps.resolve.outputs.version }}-bundle-${{ github.run_number }}
          path: |
            ${{ steps.download.outputs.base_dir }}
            iso_root
            ${{ steps.iso.outputs.iso_path }}
            ${{ steps.iso.outputs.iso_path }}.sha256
            downloads/sbom-python.json
            downloads/trivy.txt
            .github/echo_logs
          if-no-files-found: warn
          retention-days: ${{ inputs.retention_days || github.event.inputs.retention_days }}
          compression-level: 6

      # â”€â”€ Provenance & Release(ì˜µì…˜) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Attest build provenance (SLSA-ish)"
        if: always()
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: "python-${{ steps.resolve.outputs.version }}-bundle"
          subject-digest: "sha256:$(sha256sum ${{ steps.iso.outputs.iso_path }} | cut -d' ' -f1)"

      - name: "Create GitHub Release (optional)"
        if: ${{ (inputs.create_release || github.event.inputs.create_release) == true }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.resolve.outputs.version }}
          name: "Python ${{ steps.resolve.outputs.version }} bundle"
          draft: false
          prerelease: false
          files: |
            ${{ steps.download.outputs.base_dir }}/*
            ${{ steps.iso.outputs.iso_path }}
            ${{ steps.iso.outputs.iso_path }}.sha256
            downloads/sbom-python.json
            downloads/trivy.txt

      # â”€â”€ ì‹¤íŒ¨ ì‹œ ë¤í”„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Failure dump"
        if: failure()
        run: |
          set -Eeuo pipefail
          echo "### Downloads tree" >> $GITHUB_STEP_SUMMARY
          { echo '```'; find downloads -maxdepth 3 -type f -printf '%P\n' | sort || true; echo '```'; } >> $GITHUB_STEP_SUMMARY
          echo "### ISO root tree" >> $GITHUB_STEP_SUMMARY
          { echo '```'; find iso_root -maxdepth 4 -type f -printf '%P\n' | sort || true; echo '```'; } >> $GITHUB_STEP_SUMMARY

      - name: "Summary"
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"
          echoe "âœ… ì™„ë£Œ: Python ${VERSION} ë‹¤ìš´ë¡œë“œ/ê²€ì¦ + ISO ìƒì„±/ì£¼ì… + ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ì™„ë£Œ."

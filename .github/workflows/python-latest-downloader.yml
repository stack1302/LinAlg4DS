name: "ðŸ Python Latest Downloader (curl + official URLs + Echo + í˜¸ì¶œìš©)"

on:
  workflow_dispatch:
    inputs:
      track:
        description: "ë°›ì„ íŠ¸ëž™: latest(ìµœì‹  3.x), 3.13, 3.12 ì²˜ëŸ¼ íŠ¹ì • ë§ˆì´ë„ˆë§Œ"
        required: false
        default: "latest"
      version_override:
        description: "ì •í™•í•œ ë²„ì „ì„ ê°•ì œë¡œ ì§€ì • (ì˜ˆ: 3.13.0). ì§€ì • ì‹œ track ë¬´ì‹œ"
        required: false
        default: ""
      include_installers:
        description: "Windows/macOS ì„¤ì¹˜ íŒŒì¼ê¹Œì§€ í•¨ê»˜ ë‹¤ìš´ë¡œë“œ"
        type: boolean
        required: false
        default: false
  workflow_call:
    inputs:
      track:
        required: false
        type: string
        default: "latest"
      version_override:
        required: false
        type: string
        default: ""
      include_installers:
        required: false
        type: boolean
        default: false

permissions:
  contents: read

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ECHO_OK: "âœ…"
  ECHO_WARN: "âš ï¸"
  ECHO_FAIL: "âŒ"

jobs:
  resolve-and-download:
    name: "Resolve latest version & Download from official URLs"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: "Checkout (for artifact path)"
        uses: actions/checkout@v4

      - name: "Install tools (jq, coreutils)"
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq coreutils

      - name: "Init echo helpers"
        id: echo_init
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}"
          echoe(){ printf '%s %s\n' "${ECHO_OK}" "$*" | tee -a "${LOG_DIR}/python-download.log"; }
          warn(){  printf '%s %s\n' "${ECHO_WARN}" "$*" | tee -a "${LOG_DIR}/python-download.log"; }
          fail(){  printf '%s %s\n' "${ECHO_FAIL}" "$*" | tee -a "${LOG_DIR}/python-download.log"; }
          run_cmd(){ printf 'â–¶ %s\n' "$*" | tee -a "${LOG_DIR}/python-download.log"; eval "$@" 2>&1 | tee -a "${LOG_DIR}/python-download.log"; }
          curl_get(){
            local url="$1"; local out="$2"
            run_cmd "curl -fSsvL --retry 5 --retry-all-errors --retry-delay 2 --connect-timeout 20 --max-time 600 \"$url\" -o \"$out\""
          }
          # export functions to subshells
          declare -f echoe; declare -f warn; declare -f fail; declare -f run_cmd; declare -f curl_get > /tmp/echo_helpers.sh
          echo "helpers=/tmp/echo_helpers.sh" >> "$GITHUB_OUTPUT"

      - name: "Resolve Python version (official cpython releases)"
        id: resolve
        env:
          INPUT_TRACK: ${{ inputs.track || github.event.inputs.track }}
          INPUT_VERSION_OVERRIDE: ${{ inputs.version_override || github.event.inputs.version_override }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -Eeuo pipefail
          . "$(/usr/bin/grep -oP '(?<=helpers=).*' <<< '${{ steps.echo_init.outputs.helpers }}')"

          TRACK="${INPUT_TRACK:-latest}"
          OVERRIDE="${INPUT_VERSION_OVERRIDE:-}"
          API_URL="https://api.github.com/repos/python/cpython/releases?per_page=100"

          if [ -n "$OVERRIDE" ]; then
            VERSION="$OVERRIDE"
            echoe "version_override ì§€ì •ë¨ â†’ VERSION=${VERSION}"
          else
            echoe "ë¦´ë¦¬ìŠ¤ ëª©ë¡ ì¡°íšŒ: $API_URL (ì‚¬ì „ ë¦´ë¦¬ìŠ¤/ë“œëž˜í”„íŠ¸ ì œì™¸)"
            # GH_TOKEN ìžˆìœ¼ë©´ í—¤ë”ë¡œ, ì—†ì–´ë„ ê³µê°œ API í˜¸ì¶œ ê°€ëŠ¥
            if [ -n "${GH_TOKEN:-}" ]; then
              RESP="$(curl -fSsL -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "$API_URL")"
            else
              RESP="$(curl -fSsL -H "Accept: application/vnd.github+json" "$API_URL")"
            fi

            # ì•ˆì • ë¦´ë¦¬ìŠ¤ë§Œ í•„í„°í•˜ê³ , íƒœê·¸ëª…(v3.13.0)ì—ì„œ v ì œê±°
            # TRACK=latest â†’ ìµœì‹  3.x í•˜ë‚˜ ì„ íƒ
            # TRACK=3.13 ì²˜ëŸ¼ ì£¼ì–´ì§€ë©´ ê·¸ prefixë¡œ ì‹œìž‘í•˜ëŠ” ìµœì‹  ì„ íƒ
            if [ "${TRACK}" = "latest" ]; then
              VERSION="$(echo "$RESP" | jq -r '[.[] | select(.prerelease==false and .draft==false) | .tag_name] 
                | map(gsub("^v";"")) 
                | map(select(startswith("3."))) 
                | .[0]')"
            else
              PREFIX="${TRACK}."
              VERSION="$(echo "$RESP" | jq -r --arg pfx "$PREFIX" '[.[] 
                | select(.prerelease==false and .draft==false) 
                | .tag_name 
                | gsub("^v";"") 
                | select(startswith($pfx))] 
                | .[0]')"
            fi

            if [ -z "${VERSION}" ] || [ "${VERSION}" = "null" ]; then
              fail "GitHub ë¦´ë¦¬ìŠ¤ì—ì„œ ë²„ì „ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. track=${TRACK}"
              exit 1
            fi
            echoe "í•´ê²°ëœ ìµœì‹  ë²„ì „: ${VERSION} (track=${TRACK})"
          fi

          # ëŒ€ì†Œë¬¸ìž ì„žì—¬ ìžˆìœ¼ë‹ˆ ë³€ìˆ˜ ì¤€ë¹„
          V_LC="$(printf '%s' "${VERSION}" | tr '[:upper:]' '[:lower:]')"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "v_lc=${V_LC}"       >> "$GITHUB_OUTPUT"

      - name: "Download from official python.org (source + optional installers)"
        id: download
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
          INCLUDE_INSTALLERS: ${{ inputs.include_installers || github.event.inputs.include_installers }}
        run: |
          set -Eeuo pipefail
          . "$(/usr/bin/grep -oP '(?<=helpers=).*' <<< '${{ steps.echo_init.outputs.helpers }}')"

          BASE_DIR="downloads/python-${VERSION}"
          run_cmd "mkdir -p \"$BASE_DIR\""

          PY_FTP_BASE="https://www.python.org/ftp/python/${VERSION}"

          # ê³µì‹ ì†ŒìŠ¤ (ë‘˜ ë‹¤ ì‹œë„: .tgz, .tar.xz)
          SRC_TGZ="${PY_FTP_BASE}/Python-${VERSION}.tgz"
          SRC_TXZ="${PY_FTP_BASE}/Python-${VERSION}.tar.xz"

          echoe "ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ (python.org ê³µì‹):"
          curl_get "$SRC_TGZ" "$BASE_DIR/Python-${VERSION}.tgz" || warn "tgz ë¯¸ì œê³µì¼ ìˆ˜ ìžˆìŒ"
          curl_get "$SRC_TXZ" "$BASE_DIR/Python-${VERSION}.tar.xz" || warn "tar.xz ë¯¸ì œê³µì¼ ìˆ˜ ìžˆìŒ"

          # ì„ íƒ: Windows/macOS ì„¤ì¹˜ íŒŒì¼
          if [ "${INCLUDE_INSTALLERS}" = "true" ]; then
            echoe "ì„¤ì¹˜ íŒŒì¼(ê³µì‹) ì¶”ê°€ ë‹¤ìš´ë¡œë“œ:"
            # Windows (64-bit) ì„¤ì¹˜ EXE & Embeddable ZIP (íŒŒì¼ëª…ì€ ì†Œë¬¸ìž 'python-')
            WIN_EXE="${PY_FTP_BASE}/python-${VERSION}-amd64.exe"
            WIN_EMB="${PY_FTP_BASE}/python-${VERSION}-embed-amd64.zip"
            curl_get "$WIN_EXE" "$BASE_DIR/python-${VERSION}-amd64.exe" || warn "Windows exe ë¯¸ì œê³µ ë²„ì „"
            curl_get "$WIN_EMB" "$BASE_DIR/python-${VERSION}-embed-amd64.zip" || warn "Windows embeddable ë¯¸ì œê³µ ë²„ì „"

            # macOS universal2 ì„¤ì¹˜ íŒ¨í‚¤ì§€ (macos11)
            MAC_PKG="${PY_FTP_BASE}/python-${VERSION}-macos11.pkg"
            curl_get "$MAC_PKG" "$BASE_DIR/python-${VERSION}-macos11.pkg" || warn "macOS pkg ë¯¸ì œê³µ ë²„ì „"
          fi

          echoe "ë‹¤ìš´ë¡œë“œ ëª©ë¡:"
          run_cmd "ls -al \"$BASE_DIR\" || true"

          # ê°„ë‹¨ ë¬´ê²°ì„±: ì‚¬ì´ì¦ˆ 0ì¸ íŒŒì¼ ì œê±°
          find "$BASE_DIR" -type f -size 0 -print -delete | tee -a "${LOG_DIR}/python-download.log" || true

          echo "base_dir=${BASE_DIR}" >> "$GITHUB_OUTPUT"

      - name: "Upload artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: python-${{ steps.resolve.outputs.version }}-official
          path: ${{ steps.download.outputs.base_dir }}
          if-no-files-found: warn
          compression-level: 6

      - name: "Summary"
        run: |
          set -Eeuo pipefail
          . "$(/usr/bin/grep -oP '(?<=helpers=).*' <<< '${{ steps.echo_init.outputs.helpers }}')"
          echoe "âœ… ì™„ë£Œ: Python ${VERSION} ë‹¤ìš´ë¡œë“œ (ê³µì‹ URL ê¸°ë°˜)."
          echoe "ì•„í‹°íŒ©íŠ¸ ì´ë¦„: python-${VERSION}-official"

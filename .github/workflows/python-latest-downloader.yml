name: "üêç Python Latest Downloader + Verify + ISO (Í≥µÏãù URL/Îã§Ï§ëÎ∞±ÏóÖ/Îç∞Ïù¥ÌÑ∞Ï£ºÏûÖ/Î≥¥Ïïà)"

on:
  workflow_dispatch:
    inputs:
      track:
        description: "Î∞õÏùÑ Ìä∏Îûô: latest(ÏµúÏã† 3.x) ÎòêÎäî 3.13/3.12"
        required: false
        default: "latest"
      version_override:
        description: "Ï†ïÌôïÌïú Î≤ÑÏ†Ñ Í∞ïÏ†ú (Ïòà: 3.13.2). ÏßÄÏ†ï Ïãú track Î¨¥Ïãú"
        required: false
        default: ""
      include_installers:
        description: "Windows/macOS ÏÑ§Ïπò ÌååÏùºÍπåÏßÄ Îã§Ïö¥Î°úÎìú"
        type: boolean
        required: false
        default: false

      # ÎåÄÎüâ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
      dirs_root:
        description: "ÎåÄÎüâ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± Î£®Ìä∏(Ïòà: .github/echo_dirs)"
        required: false
        default: ".github/echo_dirs"
      dirs_count:
        description: "ÏÉùÏÑ±Ìï† ÎîîÎ†âÌÜ†Î¶¨ Í∞úÏàò(Ïòà: 2000, 0Ïù¥Î©¥ Ïä§ÌÇµ)"
        required: false
        default: "0"

      # ISO ÏÉùÏÑ±/Ï£ºÏûÖ
      iso_name:
        description: "ÏÉùÏÑ±Ìï† ISO ÌååÏùº Ïù¥Î¶Ñ(ÌôïÏû•Ïûê Ï†úÏô∏). Í≥µÎ∞±/ÌäπÏàòÎ¨∏Ïûê ÏßÄÏñë"
        required: false
        default: "python-latest"
      iso_label:
        description: "ISO Î≥ºÎ•® ÎùºÎ≤®(ÎåÄÎ¨∏Ïûê/Ïà´Ïûê/Ïñ∏ÎçîÏä§ÏΩîÏñ¥ Í∂åÏû•, ÏµúÎåÄ 32)"
        required: false
        default: "PYTHON_LATEST"
      iso_inject_dir:
        description: "ISOÏóê ÌÜµÏß∏Î°ú ÎÑ£ÏùÑ ÎîîÎ†âÌÜ†Î¶¨ Í≤ΩÎ°ú(Î¶¨Ìè¨ ÎÇ¥)"
        required: false
        default: ""
      iso_inject_glob:
        description: "ISOÏóê Ï∂îÍ∞ÄÌï† ÌååÏùº Í∏ÄÎ°≠(Ïòà: docs/**/*.md)"
        required: false
        default: ""
      iso_extra_text:
        description: "ISO ÎÇ¥Î∂ÄÏóê README.txtÎ°ú Ï∂îÍ∞ÄÌï† ÏûêÏú† ÌÖçÏä§Ìä∏"
        required: false
        default: ""

      # Ïö¥ÏòÅ/Î≥¥Ïïà¬∑Î∞∞Ìè¨
      retention_days:
        description: "ÏïÑÌã∞Ìå©Ìä∏ Î≥¥Í¥ÄÏùºÏàò"
        required: false
        default: "14"
      create_release:
        description: "ÏÑ±Í≥µÏãú GitHub Release ÏÉùÏÑ±/Ï≤®Î∂Ä"
        type: boolean
        required: false
        default: false

  workflow_call:
    inputs:
      track:
        required: false
        type: string
        default: "latest"
      version_override:
        required: false
        type: string
        default: ""
      include_installers:
        required: false
        type: boolean
        default: false
      dirs_root:
        required: false
        type: string
        default: ".github/echo_dirs"
      dirs_count:
        required: false
        type: string
        default: "0"
      iso_name:
        required: false
        type: string
        default: "python-latest"
      iso_label:
        required: false
        type: string
        default: "PYTHON_LATEST"
      iso_inject_dir:
        required: false
        type: string
        default: ""
      iso_inject_glob:
        required: false
        type: string
        default: ""
      iso_extra_text:
        required: false
        type: string
        default: ""
      retention_days:
        required: false
        type: string
        default: "14"
      create_release:
        required: false
        type: boolean
        default: false

permissions:
  contents: read

# ÎèôÏãú Ïã§Ìñâ Ï†úÏñ¥(Ï§ëÎ≥µ Î∞©ÏßÄ)
concurrency:
  group: python-dl-${{ github.ref }}
  cancel-in-progress: false

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ECHO_OK: "‚úÖ"
  ECHO_WARN: "‚ö†Ô∏è"
  ECHO_FAIL: "‚ùå"

jobs:
  resolve-and-download:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Install tools (jq, coreutils, gpg, genisoimage/xorriso, node)"
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq coreutils gnupg genisoimage xorriso
          # nodeÎäî SBOMÏö© cyclonedx-npm ÏÑ§ÏπòÏóê ÏÇ¨Ïö©(Ïã§Ìå® Î¨¥Ïãú)
          sudo apt-get install -y nodejs npm || true

      - name: "Init echo helpers (stderr logging + resumable curl)"
        id: echo_init
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}"
          cat > /tmp/echo_helpers.sh <<'SH'
          set -Eeuo pipefail
          # Î™®Îì† Î°úÍ∑∏Îäî stdout Ïò§Ïóº Î∞©ÏßÄ ÏúÑÌï¥ stderrÎ°ú Î≥¥ÎÉÑ
          echoe(){ printf '%s %s\n' "${ECHO_OK}" "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2; }
          warn(){  printf '%s %s\n' "${ECHO_WARN}" "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2; }
          fail(){  printf '%s %s\n' "${ECHO_FAIL}" "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2; }
          run_cmd(){
            printf '‚ñ∂ %s\n' "$*" | tee -a "${LOG_DIR}/python-download.log" 1>&2
            eval "$@" 2> >(tee -a "${LOG_DIR}/python-download.log" 1>&2)
          }
          # Î∞±Ïò§ÌîÑ ÎûòÌçº(ÏµúÎåÄ 5Ìöå, 2^n Ï¥à ÎåÄÍ∏∞)
          try(){ local n=0; until "$@"; do n=$((n+1)); [ $n -ge 5 ] && return 1; sleep $((2**n)); done; }
          # Ïû¨Í∞ú Í∞ÄÎä•Ìïú curl (-C -) + ÌäºÌäºÌïú ÏòµÏÖò
          curl_get(){
            local url="$1"; local out="$2"
            run_cmd "curl -C - -fSsvL --retry 5 --retry-all-errors --retry-delay 2 --connect-timeout 20 --max-time 1200 \"$url\" -o \"$out\""
          }
          SH
          chmod +x /tmp/echo_helpers.sh
          echo "ECHO_HELPERS=/tmp/echo_helpers.sh" >> "$GITHUB_ENV"
          echo "helpers=/tmp/echo_helpers.sh"      >> "$GITHUB_OUTPUT"

      - name: "Validate inputs"
        run: |
          set -Eeuo pipefail
          t="${{ inputs.track || github.event.inputs.track }}"
          v="${{ inputs.version_override || github.event.inputs.version_override }}"
          label="${{ inputs.iso_label || github.event.inputs.iso_label }}"
          if [ -n "$t" ] && ! [[ "$t" =~ ^latest$|^3\.[0-9]{1,2}$ ]]; then
            echo "::error::track ÌòïÏãù Ïò§Î•ò (latest ÎòêÎäî 3.13 ÌòïÌÉú)"; exit 1; fi
          if [ -n "$v" ] && ! [[ "$v" =~ ^3\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::version_override ÌòïÏãù Ïò§Î•ò (3.x.y)"; exit 1; fi
          if [ -n "$label" ] && [ ${#label} -gt 32 ]; then
            echo "::error::iso_label ÏµúÎåÄ Í∏∏Ïù¥ 32"; exit 1; fi

      - name: "Cache downloads"
        uses: actions/cache@v4
        with:
          path: downloads
          key: python-${{ inputs.version_override || 'auto' }}-${{ inputs.track || 'latest' }}-downloads

      # ‚îÄ‚îÄ Î≤ÑÏ†Ñ Ìï¥ÏÑù: Releases ‚Üí Tags ‚Üí python.org ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Resolve Python version (robust)"
        id: resolve
        env:
          INPUT_TRACK: ${{ inputs.track || github.event.inputs.track }}
          INPUT_VERSION_OVERRIDE: ${{ inputs.version_override || github.event.inputs.version_override }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"

          TRACK="${INPUT_TRACK:-latest}"
          OVERRIDE="${INPUT_VERSION_OVERRIDE:-}"

          UA_HDR=(-H "User-Agent: python-latest-downloader/1.0")
          AUTH_HDR=()
          [ -n "${GH_TOKEN:-}" ] && AUTH_HDR=(-H "Authorization: Bearer ${GH_TOKEN}")

          pick_from_json(){
            local prefix="$1"
            jq -r --arg pfx "$prefix" '
              map(if has("tag_name") then .tag_name else .name end)
              | map(gsub("^v";""))
              | map(select((. | test("^3\\.[0-9]+\\.[0-9]+$")) and (if $pfx != "" then startswith($pfx) else true end)))
              | sort_by( split(".") | map(tonumber) ) | reverse | .[0]
            '
          }

          choose_version_from_github(){
            for page in 1 2 3; do
              URL="https://api.github.com/repos/python/cpython/releases?per_page=100&page=${page}"
              echoe "GitHub Releases ÌéòÏù¥ÏßÄ ${page} Ï°∞Ìöå: $URL"
              RESP="$(try curl -fSsL "${UA_HDR[@]}" "${AUTH_HDR[@]}" -H "Accept: application/vnd.github+json" "$URL" || true)"
              [ -z "$RESP" ] && continue
              RESP_STABLE="$(echo "$RESP" | jq '[.[] | select(.prerelease==false and .draft==false)]')"
              if [ "${TRACK}" = "latest" ]; then
                CANDIDATE="$(echo "$RESP_STABLE" | pick_from_json "")"
              else
                CANDIDATE="$(echo "$RESP_STABLE" | pick_from_json "${TRACK}.")"
              fi
              if [ -n "$CANDIDATE" ] && [ "$CANDIDATE" != "null" ]; then
                printf '%s\n' "$CANDIDATE"; return 0
              fi
            done
            for page in 1 2 3; do
              URL="https://api.github.com/repos/python/cpython/tags?per_page=100&page=${page}"
              echoe "GitHub Tags ÌéòÏù¥ÏßÄ ${page} Ï°∞Ìöå: $URL"
              RESP="$(try curl -fSsL "${UA_HDR[@]}" "${AUTH_HDR[@]}" -H "Accept: application/vnd.github+json" "$URL" || true)"
              [ -z "$RESP" ] && continue
              if [ "${TRACK}" = "latest" ]; then
                CANDIDATE="$(echo "$RESP" | pick_from_json "")"
              else
                CANDIDATE="$(echo "$RESP" | pick_from_json "${TRACK}.")"
              fi
              if [ -n "$CANDIDATE" ] && [ "$CANDIDATE" != "null" ]; then
                printf '%s\n' "$CANDIDATE"; return 0
              fi
            done
            return 1
          }

          fetch_from_python_org(){
            local URL_DL="https://www.python.org/downloads/"
            echoe "python.org Îã§Ïö¥Î°úÎìú ÌéòÏù¥ÏßÄ Ï°∞Ìöå: $URL_DL"
            local HTML; HTML="$(try curl -fSsL "${UA_HDR[@]}" "$URL_DL" || true)"
            [ -z "$HTML" ] && return 1
            local VER=""
            if [ "${TRACK}" = "latest" ]; then
              VER="$(printf '%s' "$HTML" | grep -Po 'Latest Python 3 Release\\s*-\\s*Python\\s*\\K3\\.\\d+\\.\\d+' | head -n1)"
            else
              VER="$(printf '%s' "$HTML" | grep -Po "Python\\s*\\K${TRACK//./\\.}\\.\\d+" | head -n1)"
            fi
            [ -n "$VER" ] || return 1
            local FTP_BASE="https://www.python.org/ftp/python/${VER}"
            if curl -fsI "${FTP_BASE}/Python-${VER}.tar.xz" >/dev/null 2>&1 || curl -fsI "${FTP_BASE}/Python-${VER}.tgz" >/dev/null 2>&1; then
              printf '%s\n' "$VER"; return 0
            fi
            return 1
          }

          if [ -n "$OVERRIDE" ]; then
            VERSION="$OVERRIDE"; echoe "version_override ÏßÄÏ†ïÎê® ‚Üí ${VERSION}"
          else
            VERSION="$(choose_version_from_github 2>/dev/stderr | grep -Eo '^3\\.[0-9]+\\.[0-9]+$' | head -n1 || true)"
            [ -z "$VERSION" ] && VERSION="$(fetch_from_python_org 2>/dev/stderr | grep -Eo '^3\\.[0-9]+\\.[0-9]+$' | head -n1 || true)"
            [ -z "$VERSION" ] && { fail "Î≤ÑÏ†ÑÏùÑ ÏûêÎèôÏúºÎ°ú Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§. track=${TRACK}"; exit 1; }
            echoe "Ìï¥Í≤∞Îêú ÏµúÏã† Î≤ÑÏ†Ñ: ${VERSION} (track=${TRACK})"
          fi

          printf 'version=%s\n' "${VERSION}" >> "$GITHUB_OUTPUT"

      - name: "Cache key warm"
        if: always()
        run: |
          set -Eeuo pipefail
          mkdir -p downloads

      # ‚îÄ‚îÄ Í≥µÏãù URLÏóêÏÑúÎßå Îã§Ïö¥Î°úÎìú ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Download from official python.org (sources + optional installers)"
        id: download
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
          INCLUDE_INSTALLERS: ${{ inputs.include_installers || github.event.inputs.include_installers }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"

          BASE_DIR="downloads/python-${VERSION}"
          run_cmd "mkdir -p \"$BASE_DIR\""
          # ÎÇ®ÏïÑÏûàÏùÑ Ïàò ÏûàÎäî partial Ï†úÍ±∞
          find downloads -name "*.part" -delete || true

          PY_FTP_BASE="https://www.python.org/ftp/python/${VERSION}"
          SRC_TGZ="${PY_FTP_BASE}/Python-${VERSION}.tgz"
          SRC_TXZ="${PY_FTP_BASE}/Python-${VERSION}.tar.xz"

          echoe "ÏÜåÏä§ Îã§Ïö¥Î°úÎìú:"
          curl_get "$SRC_TGZ" "$BASE_DIR/Python-${VERSION}.tgz" || warn "tgz ÎØ∏Ï†úÍ≥µÏùº Ïàò ÏûàÏùå"
          curl_get "$SRC_TXZ" "$BASE_DIR/Python-${VERSION}.tar.xz" || warn "tar.xz ÎØ∏Ï†úÍ≥µÏùº Ïàò ÏûàÏùå"

          if [ "${INCLUDE_INSTALLERS}" = "true" ]; then
            echoe "ÏÑ§Ïπò ÌååÏùº:"
            curl_get "${PY_FTP_BASE}/python-${VERSION}-amd64.exe"       "$BASE_DIR/python-${VERSION}-amd64.exe"       || warn "Windows exe ÎØ∏Ï†úÍ≥µ"
            curl_get "${PY_FTP_BASE}/python-${VERSION}-embed-amd64.zip" "$BASE_DIR/python-${VERSION}-embed-amd64.zip" || warn "Windows embed ÎØ∏Ï†úÍ≥µ"
            curl_get "${PY_FTP_BASE}/python-${VERSION}-macos11.pkg"     "$BASE_DIR/python-${VERSION}-macos11.pkg"     || warn "macOS pkg ÎØ∏Ï†úÍ≥µ"
          fi

          echoe "Îã§Ïö¥Î°úÎìú Í≤∞Í≥º:"
          run_cmd "ls -al \"$BASE_DIR\" || true"
          find "$BASE_DIR" -type f -size 0 -print -delete | tee -a "${LOG_DIR}/python-download.log" || true
          echo "base_dir=${BASE_DIR}" >> "$GITHUB_OUTPUT"

      # ‚îÄ‚îÄ Ï≤¥ÌÅ¨ÏÑ¨/GPG Í≤ÄÏ¶ù ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Verify checksums (sha256) & GPG signatures (if available)"
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"
          BASE="downloads/python-${VERSION}"
          FTP="https://www.python.org/ftp/python/${VERSION}"

          # Í¥ÄÎ†® ÌååÏùº Í∞ÄÏ†∏Ïò§Í∏∞(ÏûàÏùÑ ÎïåÎßå)
          for f in tgz tar.xz; do
            curl_get "${FTP}/Python-${VERSION}.${f}.sha256" "${BASE}/Python-${VERSION}.${f}.sha256" || true
            curl_get "${FTP}/Python-${VERSION}.${f}.asc"    "${BASE}/Python-${VERSION}.${f}.asc"    || true
          done

          # sha256 Í≤ÄÏ¶ù
          for f in tgz tar.xz; do
            if [ -s "${BASE}/Python-${VERSION}.${f}" ] && [ -s "${BASE}/Python-${VERSION}.${f}.sha256" ]; then
              echo "($(cut -d' ' -f1 ${BASE}/Python-${VERSION}.${f}.sha256))  ${BASE}/Python-${VERSION}.${f}" | sha256sum -c -
            fi
          done

          # GPG ÌÇ§ ÏàòÏßë Î∞è Í≤ÄÏ¶ù(ÏûàÏùÑ Îïå)
          curl_get "https://www.python.org/static/files/pubkeys.txt" "${BASE}/python_pubkeys.txt" || true
          if [ -s "${BASE}/python_pubkeys.txt" ]; then
            gpg --batch --import "${BASE}/python_pubkeys.txt" || true
            for f in tgz tar.xz; do
              if [ -s "${BASE}/Python-${VERSION}.${f}" ] && [ -s "${BASE}/Python-${VERSION}.${f}.asc" ]; then
                gpg --batch --verify "${BASE}/Python-${VERSION}.${f}.asc" "${BASE}/Python-${VERSION}.${f}" || warn "GPG verify warning: ${f}"
              fi
            done
          else
            warn "python_pubkeys.txt ÎØ∏ÏûÖÏàò ‚Üí GPG Í≤ÄÏ¶ù Ïä§ÌÇµ"
          fi

      # ‚îÄ‚îÄ SBOM / Î≥¥Ïïà Ïä§Ï∫î(Í∞ÄÎ≥çÍ≤å) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Generate SBOM (CycloneDX)"
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"
          npm i -g @cyclonedx/cyclonedx-npm || true
          echo '{}' > /tmp/package.json
          cyclonedx-npm --output-file downloads/sbom-python.json || true

      - name: "Trivy scan (fs)"
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: downloads
          format: 'table'
          output: 'downloads/trivy.txt'

      # ‚îÄ‚îÄ (ÏòµÏÖò) ÎåÄÎüâ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "(ÏòµÏÖò) ÎåÄÎüâ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± (echo logged)"
        if: ${{ (inputs.dirs_count || github.event.inputs.dirs_count) != '0' }}
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
          DIRS_ROOT: ${{ inputs.dirs_root || github.event.inputs.dirs_root }}
          DIRS_COUNT: ${{ inputs.dirs_count || github.event.inputs.dirs_count }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"

          ROOT="${DIRS_ROOT:-.github/echo_dirs}"
          COUNT="${DIRS_COUNT:-0}"
          TARGET_ROOT="${ROOT}/python/${VERSION}"
          run_cmd "mkdir -p \"$TARGET_ROOT\""

          if ! [[ "$COUNT" =~ ^[0-9]+$ ]]; then
            warn "dirs_count Í∞íÏù¥ Ïà´ÏûêÍ∞Ä ÏïÑÎãôÎãàÎã§: $COUNT ‚Üí Ïä§ÌÇµ"
            exit 0
          fi

          if [ "$COUNT" -gt 0 ]; then
            echoe "ÎåÄÎüâ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±: ${TARGET_ROOT} Ïóê ${COUNT}Í∞ú"
            seq -w 1 "$COUNT" | while read -r i; do
              run_cmd "mkdir -p \"${TARGET_ROOT}/dir_${i}\""
            done
            run_cmd "ls -al \"${TARGET_ROOT}\" | head -n 50"
          fi

      # ‚îÄ‚îÄ ISO ÏÉùÏÑ±(Îç∞Ïù¥ÌÑ∞ Ï£ºÏûÖ Ìè¨Ìï®) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Build ISO (with injected data)"
        id: iso
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
          ISO_NAME: ${{ inputs.iso_name || github.event.inputs.iso_name }}
          ISO_LABEL: ${{ inputs.iso_label || github.event.inputs.iso_label }}
          ISO_INJECT_DIR: ${{ inputs.iso_inject_dir || github.event.inputs.iso_inject_dir }}
          ISO_INJECT_GLOB: ${{ inputs.iso_inject_glob || github.event.inputs.iso_inject_glob }}
          ISO_EXTRA_TEXT: ${{ inputs.iso_extra_text || github.event.inputs.iso_extra_text }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"

          DL_DIR="downloads/python-${VERSION}"
          ISO_ROOT="iso_root/python-${VERSION}"
          OUT_DIR="outputs"
          mkdir -p "$ISO_ROOT" "$OUT_DIR"

          # 1) Í≥µÏãù Îã§Ïö¥Î°úÎìú ÌååÏùº Î≥µÏÇ¨
          run_cmd "cp -a ${DL_DIR}/* ${ISO_ROOT}/ 2>/dev/null || true"

          # 2) Ï£ºÏûÖ: ÎîîÎ†âÌÜ†Î¶¨
          if [ -n "${ISO_INJECT_DIR}" ] && [ -d "${ISO_INJECT_DIR}" ]; then
            echoe "Ï£ºÏûÖ(ÎîîÎ†âÌÜ†Î¶¨): ${ISO_INJECT_DIR} ‚Üí ${ISO_ROOT}/extras/"
            run_cmd "mkdir -p ${ISO_ROOT}/extras"
            run_cmd "cp -a \"${ISO_INJECT_DIR}\" \"${ISO_ROOT}/extras/\""
          fi

          # 3) Ï£ºÏûÖ: Í∏ÄÎ°≠
          if [ -n "${ISO_INJECT_GLOB}" ]; then
            echoe "Ï£ºÏûÖ(Í∏ÄÎ°≠): ${ISO_INJECT_GLOB} ‚Üí ${ISO_ROOT}/extras/"
            run_cmd "mkdir -p ${ISO_ROOT}/extras"
            # Í∏ÄÎ°≠ÏùÑ safe evalÎ°ú ÌôïÏû•
            shopt -s globstar nullglob
            for f in ${ISO_INJECT_GLOB}; do
              if [ -e "$f" ]; then
                if [ -d "$f" ]; then
                  run_cmd "cp -a \"$f\" \"${ISO_ROOT}/extras/\""
                else
                  run_cmd "cp -a \"$f\" \"${ISO_ROOT}/extras/\""
                fi
              fi
            done
            shopt -u globstar || true
          fi

          # 4) Ï£ºÏûÖ: README.txt
          if [ -n "${ISO_EXTRA_TEXT}" ]; then
            run_cmd "mkdir -p ${ISO_ROOT}"
            {
              echo "Python Version: ${VERSION}"
              echo "Generated at: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
              echo "Repo: $GITHUB_REPOSITORY (run #$GITHUB_RUN_NUMBER)"
              echo ""
              echo "${ISO_EXTRA_TEXT}"
            } > "${ISO_ROOT}/README.txt"
          fi

          # 5) ISO Ïù¥Î¶Ñ/ÎùºÎ≤®
          NAME="${ISO_NAME:-python-${VERSION}}"
          LABEL="${ISO_LABEL:-PYTHON_${VERSION//./_}}"
          ISO_PATH="${OUT_DIR}/${NAME}.iso"

          # 6) ISO ÏÉùÏÑ± (Joliet + Rock Ridge)
          run_cmd "genisoimage -quiet -V \"${LABEL}\" -J -R -o \"${ISO_PATH}\" \"${ISO_ROOT}\""
          # xorriso ÎåÄÏ≤¥Î™ÖÎ†π (genisoimage ÏóÜÍ±∞ÎÇò Ïã§Ìå® Ïãú)
          if [ ! -s "${ISO_PATH}" ]; then
            warn "genisoimage Ïã§Ìå® ÎòêÎäî 0Î∞îÏù¥Ìä∏ ‚Üí xorrisoÎ°ú Ïû¨ÏãúÎèÑ"
            run_cmd "xorriso -as mkisofs -quiet -volid \"${LABEL}\" -J -R -o \"${ISO_PATH}\" \"${ISO_ROOT}\""
          fi

          [ -s "${ISO_PATH}" ] || { fail "ISO ÏÉùÏÑ± Ïã§Ìå®"; exit 1; }

          # ISO Ï≤¥ÌÅ¨ÏÑ¨
          sha256sum "${ISO_PATH}" | tee "${ISO_PATH}.sha256" 1>&2

          printf 'iso_path=%s\n' "${ISO_PATH}" >> "$GITHUB_OUTPUT"

      # ‚îÄ‚îÄ ÏïÑÌã∞Ìå©Ìä∏ ÏóÖÎ°úÎìú ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Upload artifacts (downloads + ISO + logs + SBOM + scan)"
        uses: actions/upload-artifact@v4
        with:
          name: python-${{ steps.resolve.outputs.version }}-bundle-${{ github.run_number }}
          path: |
            ${{ steps.download.outputs.base_dir }}
            iso_root
            ${{ steps.iso.outputs.iso_path }}
            ${{ steps.iso.outputs.iso_path }}.sha256
            downloads/sbom-python.json
            downloads/trivy.txt
            .github/echo_logs
          if-no-files-found: warn
          retention-days: ${{ inputs.retention_days || github.event.inputs.retention_days }}
          compression-level: 6

      # ‚îÄ‚îÄ Provenance(ÏÑ†ÌÉù) & Release(ÏÑ†ÌÉù) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Attest build provenance (SLSA-ish)"
        if: always()
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: "python-${{ steps.resolve.outputs.version }}-bundle"
          subject-digest: "sha256:$(sha256sum ${{ steps.iso.outputs.iso_path }} | cut -d' ' -f1)"

      - name: "Create GitHub Release (optional)"
        if: ${{ (inputs.create_release || github.event.inputs.create_release) == true }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.resolve.outputs.version }}
          name: "Python ${{ steps.resolve.outputs.version }} bundle"
          draft: false
          prerelease: false
          files: |
            ${{ steps.download.outputs.base_dir }}/*
            ${{ steps.iso.outputs.iso_path }}
            ${{ steps.iso.outputs.iso_path }}.sha256
            downloads/sbom-python.json
            downloads/trivy.txt

      # ‚îÄ‚îÄ Ïã§Ìå® Ïãú Îç§ÌîÑ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Failure dump"
        if: failure()
        run: |
          set -Eeuo pipefail
          echo "### Downloads tree" >> $GITHUB_STEP_SUMMARY
          { echo '```'; find downloads -maxdepth 3 -type f -printf '%P\n' | sort || true; echo '```'; } >> $GITHUB_STEP_SUMMARY
          echo "### ISO root tree" >> $GITHUB_STEP_SUMMARY
          { echo '```'; find iso_root -maxdepth 4 -type f -printf '%P\n' | sort || true; echo '```'; } >> $GITHUB_STEP_SUMMARY

      # ‚îÄ‚îÄ ÏöîÏïΩ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "Summary"
        env:
          VERSION: ${{ steps.resolve.outputs.version }}
        run: |
          set -Eeuo pipefail
          source "$ECHO_HELPERS"
          echoe "‚úÖ ÏôÑÎ£å: Python ${VERSION} Îã§Ïö¥Î°úÎìú Î∞è Í≤ÄÏ¶ù, ISO ÏÉùÏÑ±/Ï£ºÏûÖÍπåÏßÄ ÏôÑÎ£å."

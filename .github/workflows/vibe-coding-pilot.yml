name: "ðŸŽ§ Vibe Coding Pilot â€” MUST Create + Perm/Upgrade + Server+DB Init + Bulk Modify + Safe-Continue + Always-Success (â‰¤10 inputs)"

on:
  workflow_dispatch:
    inputs:
      framework:
        type: choice
        default: "fastapi"
        options: ["fastapi", "springboot", "node-express"]
      run_security:
        type: boolean
        default: true
      run_docs:
        type: boolean
        default: true
      install_servers:
        description: "Nginx/Apache/Redis/PostgreSQL ì„¤ì¹˜Â·ê¸°ë™Â·ì´ˆê¸°í™”(ì‹¤íŒ¨í•´ë„ í†µê³¼)"
        type: boolean
        default: true
      auto_commit:
        type: boolean
        default: false
      force_success_message:
        type: boolean
        default: true
      creation_scale:
        description: "ëŒ€ëŸ‰ ìƒì„± ê·œëª¨"
        type: choice
        default: "medium"
        options: ["small", "medium", "large", "xlarge"]
      bulk_enable:
        description: "ëŒ€ëŸ‰ ìˆ˜ì •(ì¹˜í™˜/ì¶”ê°€/ë¦¬ë„¤ìž„/ë³µì œ) ì‹¤í–‰"
        type: boolean
        default: true
      bulk_profile:
        description: "ëŒ€ëŸ‰ ìˆ˜ì • í”„ë¡œí•„"
        type: choice
        default: "basic"
        options: ["basic", "docs-only", "aggressive"]
      chmod_mode:
        description: "íŒŒì¼ chmod (ë””ë ‰í† ë¦¬ëŠ” 755 ê³ ì •)"
        default: "644"

permissions:
  contents: write
  security-events: write

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/artifacts
  GATHER_DIR: .github/artifacts/gather
  DIRS_ROOT: .github/echo_dirs
  FILES_ROOT: .github/echo_files
  ECHO_OK: "âœ…"
  ECHO_WARN: "âš ï¸"
  ECHO_FAIL: "âŒ"

jobs:
  all-in-one:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      # ---------- ê³µí†µ í—¬í¼ ----------
      - name: Init echo helpers (fail-safe)
        id: helpers
        shell: bash
        continue-on-error: true
        run: |
          set +e
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${GATHER_DIR}" .github/scripts
          cat > /tmp/safe_run.sh <<'SH'
          #!/usr/bin/env bash
          set +e
          ECHO_OK="${ECHO_OK:-âœ…}"; ECHO_WARN="${ECHO_WARN:-âš ï¸}"; ECHO_FAIL="${ECHO_FAIL:-âŒ}"
          LOG_DIR="${LOG_DIR:-.github/echo_logs}"; mkdir -p "$LOG_DIR"
          LOG_FILE="${LOG_DIR}/vibe-$(date +%Y%m%d%H%M%S).log"
          FAIL_COUNT_FILE="${LOG_DIR}/.fail.count"; : > "$FAIL_COUNT_FILE"
          echoe(){ printf '%s %s\n' "$ECHO_OK" "$*" | tee -a "$LOG_FILE"; }
          warne(){ printf '%s %s\n' "$ECHO_WARN" "$*" | tee -a "$LOG_FILE"; }
          faile(){ printf '%s %s (rc=%s)\n' "$ECHO_FAIL" "$1" "${2:-1}" | tee -a "$LOG_FILE"; }
          inc_fail(){ n=$(cat "$FAIL_COUNT_FILE" 2>/dev/null || echo 0); n=$((n+1)); echo "$n" > "$FAIL_COUNT_FILE"; }
          safe_run(){ local cmd="$*"; echoe "â–¶ ${cmd}"; bash -lc "$cmd"; local rc=$?; if [ $rc -ne 0 ]; then faile "FAILED: $cmd" $rc; inc_fail; fi; return 0; }
          summarize(){ local n=$(cat "$FAIL_COUNT_FILE" 2>/dev/null || echo 0); echoe "ë‹¨ê³„ ì™„ë£Œ (ì‹¤íŒ¨ ${n}ê±´ ê¸°ë¡, íŒŒì´í”„ë¼ì¸ ê³„ì† ì§„í–‰)."; }
          SH
          chmod +x /tmp/safe_run.sh
          echo "ok=1" >> "$GITHUB_OUTPUT"

      # ---------- í•„ìˆ˜ íŒŒì¼/ë””ë ‰í† ë¦¬/ê¶Œí•œ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ì „ ë°°ì¹˜ ----------
      - name: Create MUST files & permission scripts (no-skip)
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          # í•„ìˆ˜ ë””ë ‰í† ë¦¬
          safe_run "mkdir -p ${DIRS_ROOT} ${FILES_ROOT} app tests docs/adr docs/api .github/scripts .github/echo_artifacts"
          # í•„ìˆ˜ íŒŒì¼(ë ˆí¬ í‘œì¤€)
          cat > .gitignore <<'EOF'
          __pycache__/
          .venv/
          node_modules/
          .DS_Store
          .env
          EOF
          cat > .gitattributes <<'EOF'
          * text=auto eol=lf
          EOF
          cat > .editorconfig <<'EOF'
          root = true
          [*]
          end_of_line = lf
          insert_final_newline = true
          charset = utf-8
          indent_style = space
          indent_size = 2
          EOF
          cat > .env.sample <<'EOF'
          APP_ENV=dev
          DB_HOST=127.0.0.1
          DB_PORT=5432
          DB_NAME=vibe_db
          DB_USER=vibe_user
          DB_PASS=vibe_pass_123
          EOF
          # ê¶Œí•œ ì ìš© ìŠ¤í¬ë¦½íŠ¸ & ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸
          cat > .github/scripts/permissions.sh <<'BASH'
          #!/usr/bin/env bash
          set +e
          find . -type d -not -path './.git/*' -exec chmod 755 {} +
          find . -type f -not -path './.git/*' -exec chmod ${CHMOD_MODE:-644} {} +
          chmod +x .github/scripts/*.sh 2>/dev/null || true
          BASH
          chmod +x .github/scripts/permissions.sh
          # ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸(í˜„ìž¬ ì ìš© ë‚´ì—­ ìŠ¤ëƒ…ìƒ·)
          (echo "# PERMISSIONS_APPLIED"; date -Is; ) > ${ARTIFACT_DIR}/PERMISSIONS_APPLIED.txt
          summarize

      # ---------- ì‹œìŠ¤í…œ ì—…ê·¸ë ˆì´ë“œ(ìŠ¤í‚µ ì—†ì´ ì§„í–‰) ----------
      - name: System upgrade & cleanup (no-skip)
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          safe_run "sudo apt-get update -y"
          safe_run "sudo DEBIAN_FRONTEND=noninteractive apt-get -y -o Dpkg::Options::=--force-confnew full-upgrade"
          safe_run "sudo apt-get -y autoremove"
          safe_run "sudo apt-get -y autoclean"
          summarize

      # ---------- ìƒì„± ê·œëª¨ ë§¤í•‘ ----------
      - name: Derive creation scale
        id: scale
        shell: bash
        continue-on-error: true
        run: |
          case "${{ inputs.creation_scale }}" in
            small)  echo "DIRS=25"  >> $GITHUB_OUTPUT; echo "FILES=30"  >> $GITHUB_OUTPUT ;;
            medium) echo "DIRS=50"  >> $GITHUB_OUTPUT; echo "FILES=80"  >> $GITHUB_OUTPUT ;;
            large)  echo "DIRS=150" >> $GITHUB_OUTPUT; echo "FILES=300" >> $GITHUB_OUTPUT ;;
            xlarge) echo "DIRS=400" >> $GITHUB_OUTPUT; echo "FILES=800" >> $GITHUB_OUTPUT ;;
          esac

      # ---------- MUST: ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬/íŒŒì¼ ìƒì„± ----------
      - name: MUST â€” Bulk directory create
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          safe_run "i=1; while [ \$i -le '${{ steps.scale.outputs.DIRS }}' ]; do d=\$(printf '%s/d%04d' '${DIRS_ROOT}' \"\$i\"); mkdir -p \"\$d\" || true; i=\$((i+1)); done"
          summarize

      - name: MUST â€” Bulk file create
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          safe_run "i=1; while [ \$i -le '${{ steps.scale.outputs.FILES }}' ]; do f=\$(printf '%s/file%04d.txt' '${FILES_ROOT}' \"\$i\"); echo \"echo-file-\$i $(date -Iseconds)\" > \"\$f\" || true; i=\$((i+1)); done"
          safe_run "printf '# Vibe Coding Pilot\n- Created: %s\n' \"$(date -Iseconds)\" > README.md"
          safe_run "printf '# ADR-0001: Adopt Vibe Coding\n- Status: Accepted\n' > docs/adr/0001-adopt-vibe-coding.md"
          safe_run "printf '# API Notes\n- /health\n- /items/{id}\n' > docs/api/openapi-notes.md"
          summarize

      # ---------- ë ˆí¬ ê¶Œí•œ ì¼ê´„ ë°˜ì˜ ----------
      - name: Apply repository permissions (no-skip)
        env:
          CHMOD_MODE: ${{ inputs.chmod_mode }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          safe_run "bash .github/scripts/permissions.sh"
          safe_run "find . -maxdepth 3 -printf '%M %u:%g %p\n' | head -n 300 >> ${ARTIFACT_DIR}/PERMISSIONS_APPLIED.txt"
          summarize

      # ---------- í”„ë ˆìž„ì›Œí¬ ìŠ¤ìºí´ë“œ ----------
      - name: Scaffold â€” FastAPI
        if: ${{ inputs.framework == 'fastapi' }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          safe_run "python3 -m venv .venv && . .venv/bin/activate && pip -q install --upgrade pip fastapi uvicorn[standard] pytest httpx"
          cat > app/main.py <<'PY'
          from fastapi import FastAPI
          app = FastAPI()
          @app.get("/health")
          def health(): return {"status":"ok"}
          @app.get("/items/{item_id}")
          def read_item(item_id:int): return {"id": item_id, "name": f"item-{item_id}"}
          PY
          cat > tests/test_app.py <<'PY'
          from fastapi.testclient import TestClient
          from app.main import app
          c = TestClient(app)
          def test_health(): assert c.get("/health").json()["status"] == "ok"
          def test_item(): assert c.get("/items/7").json()["id"] == 7
          PY
          summarize

      - name: Scaffold â€” Spring demo
        if: ${{ inputs.framework == 'springboot' }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          safe_run "sudo apt-get install -y maven"
          safe_run "mkdir -p demo && cd demo && mvn -q -B archetype:generate -DgroupId=com.example -DartifactId=demo -DarchetypeArtifactId=maven-archetype-quickstart -DarchetypeVersion=1.5"
          safe_run "sed -i 's/junit:junit:4.11/junit:junit:4.13.2/' demo/pom.xml || true"
          summarize

      - name: Scaffold â€” Node/Express
        if: ${{ inputs.framework == 'node-express' }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          safe_run "mkdir -p nodeapp && cd nodeapp && npm init -y"
          cat > nodeapp/index.js <<'JS'
          const express = require('express'); const app = express();
          app.get('/health', (_,res)=>res.json({status:'ok'}));
          app.get('/items/:id', (req,res)=>res.json({id:+req.params.id, name:`item-${req.params.id}`}));
          app.listen(3000, ()=>console.log('up'));
          JS
          cat > nodeapp/package.json <<'JSON'
          {"name":"nodeapp","version":"1.0.0","main":"index.js",
           "scripts":{"start":"node index.js","test":"node -e \"process.exit(0)\""}}
          JSON
          summarize

      - name: Smoke run â€” FastAPI/Node
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          if [ "${{ inputs.framework }}" = "fastapi" ]; then
            safe_run ". .venv/bin/activate && uvicorn app.main:app --host 127.0.0.1 --port 8000 &"
            sleep 2
            safe_run "curl -fsSL http://127.0.0.1:8000/health | tee ${LOG_DIR}/health.json"
            safe_run "pkill -f uvicorn || true"
          elif [ "${{ inputs.framework }}" = "node-express" ]; then
            safe_run "cd nodeapp && npm run -s start &"
            sleep 2
            safe_run "curl -fsSL http://127.0.0.1:3000/health | tee ${LOG_DIR}/health-node.json"
            safe_run "pkill -f node || true"
          else
            warne "spring demoëŠ” ë¹Œë“œë§Œ ì‹œì—°"
          fi
          summarize

      # ---------- ì„œë²„(ì›¹/ìºì‹œ/DB) ì„¤ì¹˜Â·ì—…ê·¸ë ˆì´ë“œÂ·ê¸°ë™ ----------
      - name: Server stack install/upgrade/start (nginx/apache/redis/postgres)
        if: ${{ inputs.install_servers == 'true' || inputs.install_servers == true }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          # ì„¤ì¹˜ ë° ì—…ê·¸ë ˆì´ë“œ
          safe_run "sudo apt-get update -y"
          safe_run "sudo apt-get install -y nginx apache2 redis-server postgresql postgresql-contrib"
          safe_run "sudo DEBIAN_FRONTEND=noninteractive apt-get -y upgrade"
          # ê¸°ë³¸ íŽ˜ì´ì§€/ê¶Œí•œ
          safe_run "echo 'OK NGINX $(date -Iseconds)' | sudo tee /var/www/html/index.html >/dev/null"
          safe_run "echo '<h1>OK APACHE $(date -Iseconds)</h1>' | sudo tee /var/www/html/index-apache.html >/dev/null"
          # ì„œë¹„ìŠ¤ ê¸°ë™
          safe_run "sudo systemctl daemon-reload || true"
          safe_run "sudo systemctl enable --now nginx || sudo service nginx start || true"
          safe_run "sudo systemctl enable --now apache2 || sudo service apache2 start || true"
          safe_run "sudo systemctl enable --now redis-server || sudo service redis-server start || true"
          safe_run "sudo systemctl enable --now postgresql || sudo service postgresql start || true"
          # í™•ì¸
          safe_run "curl -fsS http://127.0.0.1/ | head -n 1 | tee ${LOG_DIR}/nginx_check.txt"
          safe_run "redis-cli ping | tee ${LOG_DIR}/redis_check.txt || true"
          safe_run "psql --version | tee ${LOG_DIR}/psql_ver.txt || true"
          summarize

      # ---------- âœ… DB ì´ˆê¸°í™”/ì‹œë“œ/ë¤í”„(í•„ìˆ˜) ----------
      - name: PostgreSQL init + seed + dump (no-skip)
        if: ${{ inputs.install_servers == 'true' || inputs.install_servers == true }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          DB_NAME="vibe_db"; DB_USER="vibe_user"; DB_PASS="vibe_pass_123"
          cat > /tmp/init.sql <<'SQL'
          -- role/db ìƒì„±(ì¡´ìž¬ ì‹œ ì—ëŸ¬ ë¬´ì‹œ)
          DO $$ BEGIN
            IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'vibe_user') THEN
              CREATE ROLE vibe_user LOGIN PASSWORD 'vibe_pass_123';
            END IF;
          END $$;
          CREATE DATABASE vibe_db OWNER vibe_user;
          \connect vibe_db
          CREATE TABLE IF NOT EXISTS items(
            id SERIAL PRIMARY KEY,
            name TEXT NOT NULL,
            created_at TIMESTAMPTZ DEFAULT now()
          );
          INSERT INTO items(name) VALUES ('seed-1'), ('seed-2') ON CONFLICT DO NOTHING;
          SQL
          # ì‹¤í–‰(ì´ë¯¸ ì¡´ìž¬í•˜ë©´ ì‹¤íŒ¨ ë©”ì‹œì§€ë§Œ ì¶œë ¥ í›„ ì§„í–‰)
          safe_run "sudo -u postgres psql -v ON_ERROR_STOP=0 -f /tmp/init.sql"
          # ê¶Œí•œ/ì ‘ì† í™•ì¸
          cat > /tmp/test.sql <<'SQL'
          \connect vibe_db
          \dt
          SELECT count(*) AS item_cnt FROM items;
          SQL
          safe_run "sudo -u postgres psql -v ON_ERROR_STOP=0 -f /tmp/test.sql | tee ${LOG_DIR}/pg_test.txt"
          # ë¤í”„
          safe_run "sudo -u postgres pg_dump -Fc -d vibe_db -f ${ARTIFACT_DIR}/vibe_db.dump || true"
          summarize

      # ---------- ëŒ€ëŸ‰ ìˆ˜ì • í”„ë¡œí•„ ----------
      - name: Resolve bulk profile
        id: bulkvars
        shell: bash
        continue-on-error: true
        run: |
          if [ "${{ inputs.bulk_enable }}" != "true" ]; then
            echo "ENABLE=false" >> $GITHUB_OUTPUT; exit 0; fi
          case "${{ inputs.bulk_profile }}" in
            basic)
              echo "GLOBS=.github/echo_files/*.txt docs/**/*.md README.md" >> $GITHUB_OUTPUT
              echo "FROM=echo-file"   >> $GITHUB_OUTPUT
              echo "TO=vibe-file"     >> $GITHUB_OUTPUT
              echo "APPEND=# appended-by-workflow" >> $GITHUB_OUTPUT
              echo "RPRE=bulk_"       >> $GITHUB_OUTPUT
              echo "RSUF="            >> $GITHUB_OUTPUT
              echo "COPIES=2"         >> $GITHUB_OUTPUT
              ;;
            docs-only)
              echo "GLOBS=docs/**/*.md README.md" >> $GITHUB_OUTPUT
              echo "FROM=Accepted"    >> $GITHUB_OUTPUT
              echo "TO=Accepted âœ…"    >> $GITHUB_OUTPUT
              echo "APPEND=# docs-touched" >> $GITHUB_OUTPUT
              echo "RPRE="            >> $GITHUB_OUTPUT
              echo "RSUF=_v2"         >> $GITHUB_OUTPUT
              echo "COPIES=0"         >> $GITHUB_OUTPUT
              ;;
            aggressive)
              echo "GLOBS=**/*.{md,txt}" >> $GITHUB_OUTPUT
              echo "FROM=item-"       >> $GITHUB_OUTPUT
              echo "TO=vitem-"        >> $GITHUB_OUTPUT
              echo "APPEND=# aggressive-bulk" >> $GITHUB_OUTPUT
              echo "RPRE=ag_"         >> $GITHUB_OUTPUT
              echo "RSUF="            >> $GITHUB_OUTPUT
              echo "COPIES=1"         >> $GITHUB_OUTPUT
              ;;
          esac
          echo "ENABLE=true" >> $GITHUB_OUTPUT

      # ---------- ëŒ€ëŸ‰ ìˆ˜ì • ----------
      - name: BULK MODIFY â€” replace/append/rename/duplicate/chmod
        if: steps.bulkvars.outputs.ENABLE == 'true'
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          GLOBS="${{ steps.bulkvars.outputs.GLOBS }}"
          FROM="${{ steps.bulkvars.outputs.FROM }}"
          TO="${{ steps.bulkvars.outputs.TO }}"
          APPEND_LINE="${{ steps.bulkvars.outputs.APPEND }}"
          RPRE="${{ steps.bulkvars.outputs.RPRE }}"
          RSUF="${{ steps.bulkvars.outputs.RSUF }}"
          COPIES="${{ steps.bulkvars.outputs.COPIES }}"
          FMODE="${{ inputs.chmod_mode }}"
          mapfile -t TARGETS < <(bash -lc "shopt -s nullglob globstar; for g in ${GLOBS}; do echo \$g; done")
          if [ ${#TARGETS[@]} -eq 0 ]; then warne "ëŒ€ìƒ ê¸€ë¡­(${GLOBS})ì— í•´ë‹¹í•˜ëŠ” íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            for g in "${TARGETS[@]}"; do
              for f in $g; do
                [ -f "$f" ] || continue
                [ -n "$FROM" ] && safe_run "sed -i 's/${FROM//\//\\/}/${TO//\//\\/}/g' \"$f\""
                [ -n "$APPEND_LINE" ] && safe_run "printf '%s\n' \"$APPEND_LINE\" >> \"$f\""
                dir=$(dirname "$f"); base=$(basename "$f")
                name="${base%.*}"; ext="${base##*.}"; dot="."; [ "$base" = "$ext" ] && dot=""
                new="${dir}/${RPRE}${name}${RSUF}${dot}${ext}"
                if [ -n "$RPRE" ] || [ -n "$RSUF" ]; then safe_run "mv \"$f\" \"$new\""; f="$new"; fi
                if [ "$COPIES" -gt 0 ]; then idx=1; while [ $idx -le "$COPIES" ]; do clone="${f%.*}_copy${idx}${dot}${ext}"; safe_run "cp -f \"$f\" \"$clone\""; idx=$((idx+1)); done; fi
              done
            done
          fi
          safe_run "find . -type f -not -path './.git/*' -exec chmod ${FMODE} {} + || true"
          safe_run "find . -type d -not -path './.git/*' -exec chmod 755 {} + || true"
          safe_run "git status --porcelain | tee ${LOG_DIR}/bulk_modify_changes.txt || true"
          summarize

      # ---------- ë¬¸ì„œ/ë³´ì•ˆ ----------
      - name: Docs pack (ADR/API)
        if: ${{ inputs.run_docs == 'true' || inputs.run_docs == true }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          safe_run "zip -qr ${ARTIFACT_DIR}/docs.zip docs || true"
          summarize

      - name: SBOM (Syft)
        if: ${{ inputs.run_security == 'true' || inputs.run_security == true }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          safe_run "curl -fsSL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin || true"
          safe_run "syft scan dir:. -o cyclonedx-json > ${ARTIFACT_DIR}/sbom.json || syft packages dir:. -o cyclonedx-json > ${ARTIFACT_DIR}/sbom.json || true"
          summarize

      - name: Vulnerability scan (Trivy)
        if: ${{ inputs.run_security == 'true' || inputs.run_security == true }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          safe_run "curl -fsSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin || true"
          safe_run "trivy fs --scanners vuln,secret,misconfig --timeout 10m --no-progress -f json -o ${ARTIFACT_DIR}/trivy.json . || true"
          summarize

      # ---------- ì•ˆì „ ìˆ˜ì§‘ & ì—…ë¡œë“œ ----------
      - name: SAFE gather workspace artifacts
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/safe_run.sh
          WS="${GITHUB_WORKSPACE}"
          mkdir -p "${GATHER_DIR}"
          for p in ".github/echo_logs" ".github/artifacts" "${DIRS_ROOT}" "${FILES_ROOT}" "app" "tests" "docs" "nodeapp" "demo" "README.md" ".env.sample" ".editorconfig" ".gitattributes" ".gitignore"; do
            [ -e "$p" ] || continue
            R="$(realpath -s "$p" 2>/dev/null || echo '')"
            case "$R" in "$WS"/*) ;; *) warne "ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ë°– ê²½ë¡œ ìŠ¤í‚µ: $p -> $R"; continue;; esac
            safe_run "rsync -a --relative \"$p\" \"${GATHER_DIR}/\" || true"
          done
          safe_run "find \"${FILES_ROOT}\" -maxdepth 1 -type f -print0 2>/dev/null | xargs -0 -I{} sha256sum '{}' | tee ${GATHER_DIR}/files.sha256 || true"
          safe_run "find \"${DIRS_ROOT}\" -maxdepth 2 2>/dev/null | head -n 200 | tee ${GATHER_DIR}/created-list.txt || true"
          safe_run "zip -qr ${GATHER_DIR}/prototype-${{ inputs.framework }}.zip app nodeapp demo 2>/dev/null || true"
          summarize

      - name: Upload gathered artifacts (workspace-only)
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: vibe-artifacts
          path: .github/artifacts/gather/**
          if-no-files-found: warn
          compression-level: 6
          overwrite: false
          include-hidden-files: true

      - name: Auto-commit generated files (optional)
        if: ${{ inputs.auto_commit == 'true' || inputs.auto_commit == true }}
        shell: bash
        continue-on-error: true
        run: |
          set +e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore(vibe): must-create/perm/upgrade/server+db/bulk & artifacts [skip ci]" || true
          git push || true

      - name: âœ… Always-success banner
        if: ${{ inputs.force_success_message == 'true' || inputs.force_success_message == true }}
        shell: bash
        run: |
          echo "## âœ… ì „ì²´ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ (ìŠ¤í‚µ ì—†ì´ ì „ êµ¬ê°„ ì‹¤í–‰ â€” ì‹¤íŒ¨ëŠ” ë©”ì‹œì§€ ì¶œë ¥ í›„ ì •ìƒ ì²˜ë¦¬)" >> "$GITHUB_STEP_SUMMARY"
          echo "- creation_scale=${{ inputs.creation_scale }}, framework=${{ inputs.framework }}, bulk_profile=${{ inputs.bulk_profile }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- chmod: íŒŒì¼ ${{ inputs.chmod_mode }}, ë””ë ‰í† ë¦¬ 755" >> "$GITHUB_STEP_SUMMARY"
          echo "- DB: vibe_db(+role, table, seed, dump) ì´ˆê¸°í™”Â·ì ê²€ ì™„ë£Œ(í™˜ê²½ ì œì•½ ì‹œ ë©”ì‹œì§€ í›„ ê³„ì†)" >> "$GITHUB_STEP_SUMMARY"
          echo "- ì•„í‹°íŒ©íŠ¸: vibe-artifacts (logs/lists/sbom/trivy/prototype/pg_dump/permissions)" >> "$GITHUB_STEP_SUMMARY"

name: "ğŸ§ Vibe Coding Pilot â€” Skip-on-Fail + Dir/File Create + Always-Success"

on:
  workflow_dispatch:
    inputs:
      framework:
        description: "ìƒ˜í”Œ í”„ë¡œí† íƒ€ì… í”„ë ˆì„ì›Œí¬"
        type: choice
        required: true
        default: "fastapi"
        options: ["fastapi", "springboot", "node-express"]
      run_security:
        description: "SBOM/ì·¨ì•½ì (Trivy) ì‹¤í–‰"
        type: boolean
        default: true
      run_docs:
        description: "ë¬¸ì„œ(ADR/ì„¤ê³„/API ìŠ¤í™) ìë™ ìƒì„±"
        type: boolean
        default: true
      dirs_root:
        description: "ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ë£¨íŠ¸(ì˜ˆ: .github/echo_dirs)"
        required: true
        default: ".github/echo_dirs"
      dirs_count:
        description: "ìƒì„±í•  ë””ë ‰í† ë¦¬ ê°œìˆ˜"
        required: true
        default: "25"
      files_root:
        description: "ëŒ€ëŸ‰ íŒŒì¼ ë£¨íŠ¸(ì˜ˆ: .github/echo_files)"
        required: true
        default: ".github/echo_files"
      files_count:
        description: "ìƒì„±í•  íŒŒì¼ ê°œìˆ˜"
        required: true
        default: "30"
      force_success_message:
        description: "ë§ˆì§€ë§‰ì— âœ… ì„±ê³µ ë°°ë„ˆ ê°•ì œ ì¶œë ¥"
        type: boolean
        default: true
  push:
    paths:
      - ".github/workflows/vibe-coding-pilot.yml"

permissions:
  contents: write
  actions: read
  checks: read
  security-events: write

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/artifacts
  ECHO_OK: "âœ…"
  ECHO_WARN: "âš ï¸"
  ECHO_FAIL: "âŒ"

jobs:
  setup-generate-create:
    name: "0) ì¤€ë¹„ Â· í”„ë¡œí† íƒ€ì… Â· ë””ë ‰í† ë¦¬/íŒŒì¼ ìƒì„±(ë°˜ë“œì‹œ) â€” Skip-on-Fail"
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Echo helpers (skip-safe)
        id: echo_helpers
        shell: bash
        continue-on-error: true
        run: |
          set +e
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}"
          cat > /tmp/echo_helpers.sh <<'SH'
          #!/usr/bin/env bash
          set +e
          ECHO_OK="${ECHO_OK:-âœ…}"; ECHO_WARN="${ECHO_WARN:-âš ï¸}"; ECHO_FAIL="${ECHO_FAIL:-âŒ}"
          LOG_DIR="${LOG_DIR:-.github/echo_logs}"; mkdir -p "$LOG_DIR"
          LOG_FILE="${LOG_DIR}/vibe-$(date +%Y%m%d%H%M%S).log"
          FAIL_COUNT_FILE="${LOG_DIR}/.fail.count"; : > "$FAIL_COUNT_FILE"

          echoe(){ printf '%s %s\n' "$ECHO_OK" "$*" | tee -a "$LOG_FILE"; }
          warne(){ printf '%s %s\n' "$ECHO_WARN" "$*" | tee -a "$LOG_FILE"; }
          faile(){ printf '%s %s (rc=%s)\n' "$ECHO_FAIL" "$1" "${2:-1}" | tee -a "$LOG_FILE"; }
          inc_fail(){ n=$(cat "$FAIL_COUNT_FILE" 2>/dev/null || echo 0); n=$((n+1)); echo "$n" > "$FAIL_COUNT_FILE"; }

          # ì‹¤íŒ¨í•´ë„ 0 ë°˜í™˜ â†’ íŒŒì´í”„ë¼ì¸ ê³„ì† ì§„í–‰
          run_cmd(){
            local cmd="$*"
            echoe "â–¶ ${cmd}"
            bash -lc "$cmd"
            local rc=$?
            if [ $rc -ne 0 ]; then faile "CMD FAILED: $cmd" $rc; inc_fail; fi
            return 0
          }

          print_summary(){
            local n=$(cat "$FAIL_COUNT_FILE" 2>/dev/null || echo 0)
            echoe "í˜„ì¬ ë‹¨ê³„ ì™„ë£Œ(ì‹¤íŒ¨ ${n}ê±´ ê¸°ë¡ë¨). íŒŒì´í”„ë¼ì¸ì€ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤."
          }
          SH
          chmod +x /tmp/echo_helpers.sh
          echo "helpers_ready=1" >> "$GITHUB_OUTPUT"

      - name: Base tooling (Node/Python/Zip) â€” skip on fail
        if: steps.echo_helpers.outputs.helpers_ready == '1'
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "sudo apt-get update -y"
          run_cmd "sudo apt-get install -y jq moreutils zip"
          run_cmd "corepack enable || true"
          run_cmd "sudo apt-get install -y python3-venv || true"
          print_summary

      # â”€â”€ ë°˜ë“œì‹œ: ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: MUST â€” Create directories (bulk) â€” always skip-on-fail
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          ROOT="${{ inputs.dirs_root }}"; COUNT="${{ inputs.dirs_count }}"
          run_cmd "mkdir -p \"$ROOT\""
          run_cmd "i=1; while [ \$i -le \"$COUNT\" ]; do d=\$(printf '%s/d%04d' \"$ROOT\" \"\$i\"); mkdir -p \"\$d\" || true; i=\$((i+1)); done"
          run_cmd "mkdir -p .github/echo_dirs .github/echo_files .github/echo_artifacts app tests docs/adr docs/api"
          print_summary

      # â”€â”€ ë°˜ë“œì‹œ: ëŒ€ëŸ‰ íŒŒì¼ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: MUST â€” Create files (bulk) â€” always skip-on-fail
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          FROOT="${{ inputs.files_root }}"; FCOUNT="${{ inputs.files_count }}"
          run_cmd "mkdir -p \"$FROOT\""
          run_cmd "i=1; while [ \$i -le \"$FCOUNT\" ]; do f=\$(printf '%s/file%04d.txt' \"$FROOT\" \"\$i\"); echo \"echo-file-\$i $(date -Iseconds)\" > \"\$f\" || true; i=\$((i+1)); done"
          # ìƒ˜í”Œ í•„ìˆ˜ íŒŒì¼(README/ì„¤ê³„/API/í—¬ìŠ¤ì²´í¬)
          run_cmd "printf '# Vibe Coding Pilot\n\n- Created at: %s\n' \"$(date -Iseconds)\" > README.md"
          run_cmd "printf '# ADR-0001: Adopt Vibe Coding\n- Status: Accepted\n' > docs/adr/0001-adopt-vibe-coding.md"
          run_cmd "printf '# API Notes\n- /health\n- /items/{id}\n' > docs/api/openapi-notes.md"
          print_summary

      # â”€â”€ í”„ë ˆì„ì›Œí¬ ìŠ¤ìºí´ë“œ(ì˜µì…˜) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Framework scaffold â€” FastAPI
        if: ${{ inputs.framework == 'fastapi' }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "python3 -m venv .venv && . .venv/bin/activate && pip -q install --upgrade pip"
          run_cmd ". .venv/bin/activate && pip -q install fastapi uvicorn[standard] pytest httpx"
          cat > app/main.py <<'PY'
          from fastapi import FastAPI
          app = FastAPI()
          @app.get("/health")
          def health(): return {"status":"ok"}
          @app.get("/items/{item_id}")
          def read_item(item_id:int): return {"id": item_id, "name": f"item-{item_id}"}
          PY
          cat > tests/test_app.py <<'PY'
          from fastapi.testclient import TestClient
          from app.main import app
          c = TestClient(app)
          def test_health(): assert c.get("/health").json()["status"] == "ok"
          def test_item(): assert c.get("/items/7").json()["id"] == 7
          PY
          print_summary

      - name: Framework scaffold â€” Spring (guarded)
        if: ${{ inputs.framework == 'springboot' }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "sudo apt-get install -y maven"
          run_cmd "mkdir -p demo && cd demo && mvn -q -B archetype:generate -DgroupId=com.example -DartifactId=demo -DarchetypeArtifactId=maven-archetype-quickstart -DarchetypeVersion=1.5"
          run_cmd "sed -i 's/junit:junit:4.11/junit:junit:4.13.2/' demo/pom.xml || true"
          print_summary

      - name: Framework scaffold â€” Node/Express
        if: ${{ inputs.framework == 'node-express' }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "mkdir -p nodeapp && cd nodeapp && npm init -y"
          cat > nodeapp/index.js <<'JS'
          const express = require('express'); const app = express();
          app.get('/health', (_,res)=>res.json({status:'ok'}));
          app.get('/items/:id', (req,res)=>res.json({id:+req.params.id, name:`item-${req.params.id}`}));
          app.listen(3000, ()=>console.log('up'));
          JS
          cat > nodeapp/package.json <<'JSON'
          {"name":"nodeapp","version":"1.0.0","main":"index.js",
           "scripts":{"start":"node index.js","test":"node -e \"process.exit(0)\""}}
          JSON
          print_summary

      - name: MUST â€” Verify created items (listing) â€” skip on fail
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "echo '### Created directories/files (top 100)'; find '${{ inputs.dirs_root }}' '${{ inputs.files_root }}' -maxdepth 2 | head -n 100 | tee -a ${LOG_DIR}/created-list.txt"
          run_cmd "find . -maxdepth 2 -type f -name 'README.md' -o -name '*.md' | head -n 50 | tee -a ${LOG_DIR}/created-list.txt"
          print_summary

      - name: Proto run smoke (FastAPI/Node) â€” skip on fail
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          if [ "${{ inputs.framework }}" = "fastapi" ]; then
            run_cmd ". .venv/bin/activate && uvicorn app.main:app --host 127.0.0.1 --port 8000 &"
            sleep 2
            run_cmd "curl -fsSL http://127.0.0.1:8000/health | tee ${LOG_DIR}/health.json"
            run_cmd "pkill -f uvicorn || true"
          elif [ "${{ inputs.framework }}" = "node-express" ]; then
            run_cmd "cd nodeapp && npm run -s start &"
            sleep 2
            run_cmd "curl -fsSL http://127.0.0.1:3000/health | tee ${LOG_DIR}/health-node.json"
            run_cmd "pkill -f node || true"
          else
            warne "spring scaffoldëŠ” ë¹Œë“œë§Œ ì‹œì—°"
          fi
          print_summary

      - name: Zip prototype artifact
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "zip -qr ${ARTIFACT_DIR}/prototype-${{ inputs.framework }}.zip app nodeapp demo || true"

      - name: Upload prototype artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: prototype-${{ inputs.framework }}
          path: .github/artifacts/prototype-${{ inputs.framework }}.zip
          if-no-files-found: ignore

      - name: âœ… Always-success banner (job tail)
        if: ${{ inputs.force_success_message == 'true' || inputs.force_success_message == true }}
        shell: bash
        run: |
          echo "## âœ… Setup/Generate/Create ë‹¨ê³„ ì™„ë£Œ (ì‹¤íŒ¨ëŠ” ëª¨ë‘ ìŠ¤í‚µë¨ & ì„±ê³µ ë©”ì‹œì§€ ê°•ì œ ì¶œë ¥)" >> "$GITHUB_STEP_SUMMARY"

  test-docs-security:
    name: "1) í…ŒìŠ¤íŠ¸ Â· ë¬¸ì„œ Â· ë³´ì•ˆ(SBOM/Scan) â€” Skip-on-Fail"
    runs-on: ubuntu-24.04
    needs: setup-generate-create

    steps:
      - uses: actions/checkout@v4

      - name: Echo helpers (reuse)
        shell: bash
        continue-on-error: true
        run: |
          set +e
          if [ ! -f /tmp/echo_helpers.sh ]; then
            mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}"
            cat > /tmp/echo_helpers.sh <<'SH'
            #!/usr/bin/env bash
            set +e
            ECHO_OK="${ECHO_OK:-âœ…}"; ECHO_WARN="${ECHO_WARN:-âš ï¸}"; ECHO_FAIL="${ECHO_FAIL:-âŒ}"
            LOG_DIR="${LOG_DIR:-.github/echo_logs}"; mkdir -p "$LOG_DIR"
            LOG_FILE="${LOG_DIR}/vibe-$(date +%Y%m%d%H%M%S).log"
            FAIL_COUNT_FILE="${LOG_DIR}/.fail.count"; : > "$FAIL_COUNT_FILE"
            echoe(){ printf '%s %s\n' "$ECHO_OK" "$*" | tee -a "$LOG_FILE"; }
            warne(){ printf '%s %s\n' "$ECHO_WARN" "$*" | tee -a "$LOG_FILE"; }
            faile(){ printf '%s %s (rc=%s)\n' "$ECHO_FAIL" "$1" "${2:-1}" | tee -a "$LOG_FILE"; }
            inc_fail(){ n=$(cat "$FAIL_COUNT_FILE" 2>/dev/null || echo 0); n=$((n+1)); echo "$n" > "$FAIL_COUNT_FILE"; }
            run_cmd(){ local cmd="$*"; echoe "â–¶ ${cmd}"; bash -lc "$cmd"; local rc=$?; if [ $rc -ne 0 ]; then faile "CMD FAILED: $cmd" $rc; inc_fail; fi; return 0; }
            print_summary(){ local n=$(cat "$FAIL_COUNT_FILE" 2>/dev/null || echo 0); echoe "í˜„ì¬ ë‹¨ê³„ ì™„ë£Œ(ì‹¤íŒ¨ ${n}ê±´). ê³„ì† ì§„í–‰."; }
            SH
            chmod +x /tmp/echo_helpers.sh
          fi

      - name: Python tests (FastAPI) â€” skip on fail
        if: ${{ github.event.inputs.framework == 'fastapi' }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "python3 -m venv .venv && . .venv/bin/activate && pip -q install --upgrade pip pytest httpx fastapi uvicorn[standard]"
          run_cmd ". .venv/bin/activate && pytest -q || true"
          print_summary

      - name: Maven test (Spring) â€” guarded
        if: ${{ github.event.inputs.framework == 'springboot' && hashFiles('demo/pom.xml') != '' }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "sudo apt-get install -y maven"
          run_cmd "cd demo && mvn -q -B -e -DskipTests=false test || true"
          print_summary

      - name: Node test (Express) â€” skip on fail
        if: ${{ github.event.inputs.framework == 'node-express' && hashFiles('nodeapp/package.json') != '' }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "cd nodeapp && npm i --silent || true"
          run_cmd "cd nodeapp && npm test || true"
          print_summary

      - name: Docs (ADR/ì„¤ê³„/API) â€” skip on fail
        if: ${{ github.event.inputs.run_docs == 'true' || github.event.inputs.run_docs == true }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "mkdir -p docs/adr docs/api"
          run_cmd "zip -qr ${ARTIFACT_DIR}/docs.zip docs || true"
          print_summary

      - name: SBOM (Syft) â€” skip on fail
        if: ${{ github.event.inputs.run_security == 'true' || github.event.inputs.run_security == true }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "curl -fsSL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin || true"
          run_cmd "syft packages dir:. -o cyclonedx-json > ${ARTIFACT_DIR}/sbom.json || true"
          print_summary

      - name: Vulnerability scan (Trivy) â€” skip on fail
        if: ${{ github.event.inputs.run_security == 'true' || github.event.inputs.run_security == true }}
        shell: bash
        continue-on-error: true
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "curl -fsSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin || true"
          run_cmd "trivy fs --scanners vuln,secret,misconfig --timeout 10m --no-progress -f json -o ${ARTIFACT_DIR}/trivy.json . || true"
          print_summary

      - name: Upload artifacts (logs/docs/sbom/scan)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vibe-artifacts
          path: |
            .github/echo_logs/**
            .github/artifacts/**
            ${{ inputs.dirs_root }}/**
            ${{ inputs.files_root }}/**
            app/**
            tests/**
            docs/**
            nodeapp/**
            demo/**
          if-no-files-found: warn

      - name: âœ… Always-success banner (job tail)
        if: ${{ github.event.inputs.force_success_message == 'true' || github.event.inputs.force_success_message == true }}
        shell: bash
        run: |
          echo "## âœ… Test/Docs/Security ë‹¨ê³„ ì™„ë£Œ (íŒŒì¼/ë””ë ‰í† ë¦¬ ìƒì„± í¬í•¨, ì‹¤íŒ¨ëŠ” ëª¨ë‘ ìŠ¤í‚µë¨)" >> "$GITHUB_STEP_SUMMARY"

  summary:
    name: "2) ìµœì¢… ìš”ì•½ (í•­ìƒ ì„±ê³µ ë©”ì„¸ì§€)"
    runs-on: ubuntu-24.04
    needs: [setup-generate-create, test-docs-security]
    steps:
      - name: âœ… Final SUCCESS banner
        shell: bash
        run: |
          echo "## âœ… ì „ì²´ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ (FAIL SAFE)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Framework: ${{ github.event.inputs.framework }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Docs: ${{ github.event.inputs.run_docs }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Security: ${{ github.event.inputs.run_security }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Dirs Root: ${{ github.event.inputs.dirs_root }} (count=${{ github.event.inputs.dirs_count }})" >> "$GITHUB_STEP_SUMMARY"
          echo "- Files Root: ${{ github.event.inputs.files_root }} (count=${{ github.event.inputs.files_count }})" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "ì•„í‹°íŒ©íŠ¸(prototype-*, vibe-artifacts)ì—ì„œ ìƒì„±ëœ ë””ë ‰í† ë¦¬/íŒŒì¼ê³¼ ë¡œê·¸Â·SBOMÂ·ìŠ¤ìº” ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”."

name: "üóÑÔ∏è DB Services + Echo Healthchecks (All-in-One, Curl+Allowlist)"

on:
  workflow_dispatch:
    inputs:
      enable_heavy:
        description: "Î¨¥Í±∞Ïö¥ DB(Cassandra/Scylla)ÎèÑ Ìè¨Ìï® Ïã§Ìñâ"
        type: boolean
        required: false
        default: false
      allow_domains_csv:
        description: "curl ÌóàÏö© ÎèÑÎ©îÏù∏ CSV (Ïòà: raw.githubusercontent.com,downloads.mariadb.org)"
        required: false
        default: "raw.githubusercontent.com"
      extra_files:
        description: "curlÎ°ú Î∞õÏùÑ ÌååÏùºÎì§ (Í≥µÎ∞±/Ï§ÑÎ∞îÍøà/ÏâºÌëú Íµ¨Î∂Ñ) ‚Äî Ïòà: https://raw.githubusercontent.com/postgres/postgres/master/src/test/regress/sql/const.sql"
        required: false
        default: ""

permissions:
  contents: read

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ECHO_OK: "‚úÖ"
  ECHO_WARN: "‚ö†Ô∏è"
  ECHO_FAIL: "‚ùå"

jobs:
  # ------------------------------------------------------------
  # 0) Í≥µÌÜµ Ï§ÄÎπÑ: echo Ìó¨Ìçº/Í≤ÄÏ¶ù Ìï®Ïàò + curl ÌóàÏö©ÎèÑÎ©îÏù∏ + Í≥µÌÜµ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÑ§Ïπò
  # ------------------------------------------------------------
  prepare:
    runs-on: ubuntu-latest
    outputs:
      allow: ${{ steps.export-allow.outputs.allow }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare echo helpers (global)
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}"
          cat > /tmp/echo_helpers.sh <<'SH'
          set -Eeuo pipefail
          : "${LOG_DIR:=.github/echo_logs}"
          mkdir -p "${LOG_DIR}"

          echoe(){ printf '%s %s\n' "${ECHO_OK}" "$*"; }
          warn(){  printf '%s %s\n' "${ECHO_WARN}" "$*"; }
          fail(){  printf '%s %s\n' "${ECHO_FAIL}" "$*"; }
          logf(){  printf '%s\n' "$*" | tee -a "$1"; }

          # run_cmd "LOG_FILE" cmd...
          run_cmd(){
            local LOG_FILE="$1"; shift
            logf "$LOG_FILE" "‚ñ∂ $*"
            # shellcheck disable=SC2068
            "$@" 2>&1 | tee -a "$LOG_FILE"
            local rc=${PIPESTATUS[0]}
            if [ $rc -eq 0 ]; then echoe "DONE: $*"; else warn "RC=$rc ‚Üê $*"; fi
            return $rc
          }

          # curl_get url out [sha256]
          curl_get(){
            local url="$1"; local out="$2"; local want_sha="${3:-}"
            local allow="${ALLOW_DOMAINS_CSV:-}"
            local host; host=$(printf '%s' "$url" | awk -F/ '{print $3}')
            if [ -n "$allow" ] && ! printf '%s\n' "$allow" | tr ',' '\n' | tr -d ' ' | grep -Fxq "$host"; then
              echo "Blocked host: $host (allow=$allow)"; return 2
            fi
            curl -fSsvL --retry 3 --retry-all-errors --retry-delay 2 --connect-timeout 20 --max-time 180 "$url" -o "$out"
            if [ -n "$want_sha" ]; then
              echo "$want_sha  $out" | sha256sum -c -
            fi
          }

          # wait-for port with timeout
          wait_port(){
            local host="$1" port="$2" wait="${3:-60}"
            local end=$((SECONDS+wait))
            while [ $SECONDS -lt $end ]; do
              if (echo >"/dev/tcp/${host}/${port}") >/dev/null 2>&1; then
                echoe "port ${host}:${port} open"
                return 0
              fi
              sleep 1
            done
            warn "timeout waiting for ${host}:${port}"
            return 1
          }
          SH
          chmod +x /tmp/echo_helpers.sh
          echo "‚úÖ echo helpers ready ‚Üí /tmp/echo_helpers.sh"

      - name: Install DB client tools (APT)
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          LOG="${LOG_DIR}/clients-install.log"
          run_cmd "$LOG" sudo apt-get update
          run_cmd "$LOG" sudo apt-get install -y --no-install-recommends \
            postgresql-client \
            mysql-client \
            mariadb-client \
            redis-tools \
            mongodb-clients \
            clickhouse-client \
            curl jq netcat-traditional
          echoe "Clients installed."

      - name: Export allow domains
        id: export-allow
        run: |
          echo "allow=${{ github.event.inputs.allow_domains_csv }}" >> "$GITHUB_OUTPUT"

      - name: Optional: curl download extra files (allowlist enforced)
        if: ${{ inputs.extra_files != '' }}
        env:
          ALLOW_DOMAINS_CSV: ${{ steps.export-allow.outputs.allow }}
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          LOG="${LOG_DIR}/curl-downloads.log"
          mkdir -p .github/downloads
          # Í≥µÎ∞±/ÏâºÌëú/Ï§ÑÎ∞îÍøàÏùÑ Î™®Îëê Íµ¨Î∂ÑÏûêÎ°ú Ï≤òÎ¶¨
          printf '%s\n' "${{ github.event.inputs.extra_files }}" | tr ',\n' '  ' | xargs -n1 -I{} bash -c '
            f={}; [ -z "$f" ] && exit 0
            base=$(basename "$f")
            run_cmd "'"$LOG"'" curl_get "$f" ".github/downloads/$base"
          '
          echoe "curl downloads completed."

  # ------------------------------------------------------------
  # 1) ÌïµÏã¨ DB Î¨∂Ïùå (PostgreSQL, MySQL, MariaDB, MongoDB, Redis)
  # ------------------------------------------------------------
  core-dbs:
    runs-on: ubuntu-latest
    needs: [prepare]
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: app
        ports: ["5432:5432"]
        options: >-
          --health-cmd="pg_isready -U test"
          --health-interval=5s --health-timeout=3s --health-retries=30
      mysql:
        image: mysql:8.4
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: app
          MYSQL_USER: app
          MYSQL_PASSWORD: app
        ports: ["3306:3306"]
        options: >-
          --health-cmd="mysqladmin ping -h localhost -proot"
          --health-interval=5s --health-timeout=3s --health-retries=30
      mariadb:
        image: mariadb:11
        env:
          MARIADB_ROOT_PASSWORD: root
          MARIADB_DATABASE: app
          MARIADB_USER: app
          MARIADB_PASSWORD: app
        ports: ["3307:3306"] # Ìò∏Ïä§Ìä∏ 3307Î°ú Îß§Ìïë(3306Í≥º Ï∂©Îèå Î∞©ÏßÄ)
      mongo:
        image: mongo:7
        ports: ["27017:27017"]
      redis:
        image: redis:7
        ports: ["6379:6379"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy echo helpers from prepare
        run: |
          set -Eeuo pipefail
          cp -f /tmp/echo_helpers.sh /tmp/echo_helpers.sh || true
          echo "OK"

      - name: Wait ports
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          LOG="${LOG_DIR}/core-wait.log"
          run_cmd "$LOG" wait_port 127.0.0.1 5432 90
          run_cmd "$LOG" wait_port 127.0.0.1 3306 90
          run_cmd "$LOG" wait_port 127.0.0.1 3307 90
          run_cmd "$LOG" wait_port 127.0.0.1 27017 90
          run_cmd "$LOG" wait_port 127.0.0.1 6379 60

      - name: Health & smoke tests (psql/mysql/mariadb/mongo/redis)
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          LOG="${LOG_DIR}/core-smoke.log"

          # PostgreSQL
          run_cmd "$LOG" psql "postgresql://test:test@127.0.0.1:5432/app" -c "SELECT version();"
          run_cmd "$LOG" psql "postgresql://test:test@127.0.0.1:5432/app" -c "CREATE TABLE IF NOT EXISTS t(id serial primary key, v text); INSERT INTO t(v) VALUES('ok'); SELECT count(*) FROM t;"

          # MySQL
          run_cmd "$LOG" mysql -h 127.0.0.1 -P 3306 -uroot -proot -e "SELECT VERSION(); CREATE DATABASE IF NOT EXISTS smoke; USE smoke; CREATE TABLE IF NOT EXISTS t(id INT PRIMARY KEY AUTO_INCREMENT, v VARCHAR(50)); INSERT INTO t(v) VALUES('ok'); SELECT COUNT(*) FROM t;"

          # MariaDB (port 3307)
          run_cmd "$LOG" mariadb -h 127.0.0.1 -P 3307 -uroot -proot -e "SELECT VERSION(); CREATE DATABASE IF NOT EXISTS smoke; USE smoke; CREATE TABLE IF NOT EXISTS t(id INT PRIMARY KEY AUTO_INCREMENT, v VARCHAR(50)); INSERT INTO t(v) VALUES('ok'); SELECT COUNT(*) FROM t;"

          # MongoDB
          run_cmd "$LOG" mongo --host 127.0.0.1 --eval 'db.runCommand({ ping: 1 })'
          run_cmd "$LOG" mongo --host 127.0.0.1 --eval 'db.getSiblingDB("smoke").t.insertOne({v:"ok"}); db.getSiblingDB("smoke").t.countDocuments()'

          # Redis
          run_cmd "$LOG" redis-cli -h 127.0.0.1 PING
          run_cmd "$LOG" redis-cli -h 127.0.0.1 SET foo bar
          run_cmd "$LOG" redis-cli -h 127.0.0.1 GET foo

  # ------------------------------------------------------------
  # 2) Î∂ÑÏÑù/ÏãúÍ≥ÑÏó¥ Î¨∂Ïùå (ClickHouse, QuestDB, InfluxDB, VictoriaMetrics)
  # ------------------------------------------------------------
  analytical-dbs:
    runs-on: ubuntu-latest
    needs: [prepare]
    services:
      clickhouse:
        image: clickhouse/clickhouse-server:24.8
        ports: ["9000:9000", "8123:8123"]
      questdb:
        image: questdb/questdb:latest
        ports: ["9009:9009","8812:8812","9000:9000"] # 9000ÏùÄ UI(Ï§ëÎ≥µÏãú Î¨¥Ïãú)
      influx:
        image: influxdb:2
        ports: ["8086:8086"]
      victoriametrics:
        image: victoriametrics/victoria-metrics:latest
        ports: ["8428:8428"]
    steps:
      - uses: actions/checkout@v4
      - name: Copy echo helpers
        run: cp -f /tmp/echo_helpers.sh /tmp/echo_helpers.sh || true
      - name: Wait ports
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          LOG="${LOG_DIR}/anal-wait.log"
          run_cmd "$LOG" wait_port 127.0.0.1 8123 120   # ClickHouse HTTP
          run_cmd "$LOG" wait_port 127.0.0.1 9000 120   # ClickHouse native / QuestDB UI Ï∂©Îèå Î¨¥Ïãú
          run_cmd "$LOG" wait_port 127.0.0.1 8812 120   # QuestDB PG wire
          run_cmd "$LOG" wait_port 127.0.0.1 8086 120   # InfluxDB 2
          run_cmd "$LOG" wait_port 127.0.0.1 8428 120   # VictoriaMetrics
      - name: Health & smoke tests
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          LOG="${LOG_DIR}/anal-smoke.log"

          # ClickHouse (HTTP ping)
          run_cmd "$LOG" bash -lc 'curl -fsS http://127.0.0.1:8123/ping'

          # ClickHouse client (Ï°¥Ïû¨ Ïãú)
          if command -v clickhouse-client >/dev/null 2>&1; then
            run_cmd "$LOG" clickhouse-client --host 127.0.0.1 --query "SELECT version();"
          fi

          # QuestDB (PG wire Ìò∏Ìôò: 127.0.0.1:8812) ‚Üí psql ÏÇ¨Ïö© Í∞ÄÎä•(ÏûàÎã§Î©¥)
          if command -v psql >/dev/null 2>&1; then
            run_cmd "$LOG" psql "postgresql://admin:quest@127.0.0.1:8812/qdb?sslmode=disable" -c "SELECT 1;" || true
          fi

          # InfluxDB v2 readiness
          run_cmd "$LOG" curl -fsS http://127.0.0.1:8086/health

          # VictoriaMetrics readiness
          run_cmd "$LOG" curl -fsS http://127.0.0.1:8428/metrics | head -n 5

  # ------------------------------------------------------------
  # 3) Í∑∏ÎûòÌîÑ/Î©ÄÌã∞Î™®Îç∏/ÌÇ§Í∞í Î¨∂Ïùå (Neo4j, ArangoDB, etcd, CouchDB)
  # ------------------------------------------------------------
  graph-kv-dbs:
    runs-on: ubuntu-latest
    needs: [prepare]
    services:
      neo4j:
        image: neo4j:5
        env:
          NEO4J_AUTH: neo4j/testpass
        ports: ["7687:7687","7474:7474"]
      arango:
        image: arangodb:3.11
        env:
          ARANGO_ROOT_PASSWORD: root
        ports: ["8529:8529"]
      etcd:
        image: gcr.io/etcd-development/etcd:v3.5.13
        env:
          ALLOW_NONE_AUTHENTICATION: "yes"
        ports: ["2379:2379","2380:2380"]
        options: >-
          --health-cmd="etcdctl endpoint health || exit 1"
          --health-interval=10s --health-timeout=5s --health-retries=20
      couchdb:
        image: couchdb:3
        env:
          COUCHDB_USER: admin
          COUCHDB_PASSWORD: admin
        ports: ["5984:5984"]
    steps:
      - uses: actions/checkout@v4
      - name: Copy echo helpers
        run: cp -f /tmp/echo_helpers.sh /tmp/echo_helpers.sh || true
      - name: Wait ports
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          LOG="${LOG_DIR}/gkv-wait.log"
          run_cmd "$LOG" wait_port 127.0.0.1 7687 120
          run_cmd "$LOG" wait_port 127.0.0.1 7474 120
          run_cmd "$LOG" wait_port 127.0.0.1 8529 120
          run_cmd "$LOG" wait_port 127.0.0.1 2379 120
          run_cmd "$LOG" wait_port 127.0.0.1 5984 120
      - name: Health & smoke tests
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          LOG="${LOG_DIR}/gkv-smoke.log"

          # Neo4j (HTTP UI)
          run_cmd "$LOG" curl -fsS http://127.0.0.1:7474/ || true

          # ArangoDB
          run_cmd "$LOG" curl -fsS http://127.0.0.1:8529/_api/version
          run_cmd "$LOG" curl -fsS -u root:root --header 'Content-Type: application/json' \
            --data '{"name":"smoke"}' http://127.0.0.1:8529/_api/database || true

          # etcd
          run_cmd "$LOG" curl -fsS http://127.0.0.1:2379/health || true

          # CouchDB
          run_cmd "$LOG" curl -fsS http://admin:admin@127.0.0.1:5984/

  # ------------------------------------------------------------
  # 4) Î¨¥Í±∞Ïö¥ DB (ÏòµÏÖò): Cassandra, ScyllaDB
  # ------------------------------------------------------------
  heavy-dbs:
    if: ${{ inputs.enable_heavy == true }}
    runs-on: ubuntu-latest
    needs: [prepare]
    services:
      cassandra:
        image: cassandra:4.1
        ports: ["9042:9042"]
        options: >-
          --health-cmd="cqlsh -e 'DESCRIBE CLUSTER' || exit 1"
          --health-interval=20s --health-timeout=10s --health-retries=30
      scylla:
        image: scylladb/scylla:5.4
        ports: ["9142:9042"] # Ìò∏Ïä§Ìä∏ 9142‚ÜíÏª®ÌÖåÏù¥ÎÑà 9042 (cassandraÏôÄ Ï∂©Îèå Î∞©ÏßÄ)
    steps:
      - uses: actions/checkout@v4
      - name: Copy echo helpers
        run: cp -f /tmp/echo_helpers.sh /tmp/echo_helpers.sh || true
      - name: Wait ports (ÎäêÎ¶º Ï£ºÏùò)
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          LOG="${LOG_DIR}/heavy-wait.log"
          run_cmd "$LOG" wait_port 127.0.0.1 9042 300
          run_cmd "$LOG" wait_port 127.0.0.1 9142 300
      - name: Health & smoke tests (Cassandra/Scylla)
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh
          LOG="${LOG_DIR}/heavy-smoke.log"
          # cqlsh Ìå®ÌÇ§ÏßÄÎäî Í∏∞Î≥∏ ÎØ∏Ìè¨Ìï® ‚Üí Ïª®ÌÖåÏù¥ÎÑà execÎ°ú Í∞ÑÎã® Ï≤¥ÌÅ¨
          run_cmd "$LOG" bash -lc 'docker ps'
          # Í∞ÑÎã®Ìïú TCP ÌôïÏù∏
          run_cmd "$LOG" bash -lc 'echo | nc -vz 127.0.0.1 9042'
          run_cmd "$LOG" bash -lc 'echo | nc -vz 127.0.0.1 9142'

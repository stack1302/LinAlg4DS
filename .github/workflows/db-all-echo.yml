name: "ðŸ§  MCP Setup + Health + Echo (5m Cron, Secure, Non-Interactive v2)"

on:
  workflow_dispatch:
    inputs:
      node_version:
        description: "Node.js version"
        required: true
        default: "20"
      python_version:
        description: "Python version"
        required: true
        default: "3.12"
      create_pr:
        description: "ì‚°ì¶œë¬¼(mcp ì„¤ì •/ìŠ¤í¬ë¦½íŠ¸/ë¡œê·¸) PR ìƒì„±"
        type: boolean
        required: true
        default: true
  schedule:
    - cron: "*/5 * * * *"  # 5ë¶„ ì£¼ê¸°

permissions:
  contents: write
  actions: read
  pull-requests: write

env:
  TZ: Asia/Seoul
  ECHO_OK: "âœ…"
  ECHO_WARN: "âš ï¸"
  ECHO_FAIL: "âŒ"
  LOG_DIR: .github/echo_logs
  OUT_DIR: .github/mcp_out
  MCP_DIR: .github/mcp
  NPM_REGISTRY: "https://registry.npmjs.org/"
  # ìµœê·¼ ì•…ì„± ì‚¬ë¡€: ë°œê²¬ ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬(í•„ìš” ì‹œ ëª©ë¡ í™•ìž¥)
  BLOCKED_NPM: "postmark-mcp@1.0.16"

jobs:
  mcp-all-in-one:
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare directories & echo helpers
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${OUT_DIR}" "${MCP_DIR}"
          cat > /tmp/echo_helpers.sh <<'SH'
          #!/usr/bin/env bash
          set -Eeuo pipefail
          ECHO_OK="${ECHO_OK:-âœ…}"; ECHO_WARN="${ECHO_WARN:-âš ï¸}"; ECHO_FAIL="${ECHO_FAIL:-âŒ}"
          LOG_DIR="${LOG_DIR:-.github/echo_logs}"; mkdir -p "${LOG_DIR}"
          logf(){ printf '%s\n' "$*" | tee -a "${LOG_DIR}/mcp.log"; }
          echoe(){ printf '%s %s\n' "${ECHO_OK}" "$*" | tee -a "${LOG_DIR}/mcp.log"; }
          warn(){  printf '%s %s\n' "${ECHO_WARN}" "$*" | tee -a "${LOG_DIR}/mcp.log"; }
          fail(){  printf '%s %s\n' "${ECHO_FAIL}" "$*" | tee -a "${LOG_DIR}/mcp.log"; }
          run_cmd(){
            logf "â–¶ $*"
            # shellcheck disable=SC2086
            eval $* 2>&1 | tee -a "${LOG_DIR}/mcp.log"
            local rc=${PIPESTATUS[0]}
            if [ $rc -eq 0 ]; then echoe "DONE ($rc): $*"; else warn "RC=$rc â† $*"; fi
            return $rc
          }
          npm_retry(){
            # npm ëª…ë ¹ ìž¬ì‹œë„ ëž˜í¼(3íšŒ)
            local cmd="$*"; local tries=0; local rc=0
            until [ $tries -ge 3 ]; do
              run_cmd "$cmd" && return 0
              rc=$?; tries=$((tries+1))
              warn "npm retry $tries (rc=$rc) â†’ 2s ëŒ€ê¸°"
              sleep 2
            done
            return $rc
          }
          SH
          chmod +x /tmp/echo_helpers.sh
          echo "${ECHO_OK} Echo helpers ready."

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.12' }}

      - name: Toolchain versions
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "node -v && npm -v && python -V && pip -V"

      - name: Configure npm registry (explicit)
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          run_cmd "npm config set registry '${NPM_REGISTRY}'"
          run_cmd "npm ping"

      - name: Install MCP tooling (SDK + Inspector) with fallbacks
        shell: bash
        run: |
          source /tmp/echo_helpers.sh

          # ---- JS: SDK (@modelcontextprotocol/sdk) ----
          # ìµœì‹  ë²„ì „ì„ ì¡°íšŒí•´ ì •í™•ížˆ í•€ê³ ì • ì„¤ì¹˜. ì‹¤íŒ¨ ì‹œ npx ì‚¬ìš©ìœ¼ë¡œ í´ë°±. :contentReference[oaicite:6]{index=6}
          SDK_VER="$(npm view @modelcontextprotocol/sdk version || true)"
          if [ -n "${SDK_VER}" ]; then
            npm_retry "npm i -g @modelcontextprotocol/sdk@${SDK_VER}"
          else
            warn "SDK version lookup failed â†’ npx ì‚¬ìš©ìœ¼ë¡œ í´ë°± ì˜ˆì •"
          fi

          # ---- JS: Inspector (@modelcontextprotocol/inspector) ----
          # InspectorëŠ” ê¸€ë¡œë²Œ ì„¤ì¹˜ ë¶ˆí•„ìš” â€” npx ì‹¤í–‰ ê¶Œìž¥. ë‹¨, list ì‹œ ë¹ ë¥´ê²Œ ì“°ê¸° ìœ„í•´ ê¸€ë¡œë²Œ ì„¤ì¹˜ë„ ì‹œë„. :contentReference[oaicite:7]{index=7}
          INS_VER="$(npm view @modelcontextprotocol/inspector version || true)"
          if [ -n "${INS_VER}" ]; then
            npm_retry "npm i -g @modelcontextprotocol/inspector@${INS_VER}" || warn "global inspector install failed â€” will use npx"
          else
            warn "Inspector version lookup failed â€” will use npx"
          fi

          # ---- PY: Python SDK (mcp[server]) ---- :contentReference[oaicite:8]{index=8}
          run_cmd "python -m pip install --upgrade pip"
          run_cmd "python -m pip install 'mcp[server]'"

          # ---- (ì˜µì…˜) íŒŒì¼ì‹œìŠ¤í…œ ì„œë²„(ìžˆìœ¼ë©´ ì„¤ì¹˜) ---- :contentReference[oaicite:9]{index=9}
          FS_VER="$(npm view @modelcontextprotocol/server-filesystem version || true)"
          if [ -n "${FS_VER}" ]; then
            npm_retry "npm i -g @modelcontextprotocol/server-filesystem@${FS_VER}" || warn "server-filesystem install failed â€” skip (optional)"
          else
            warn "server-filesystem not found â€” skip (optional)"
          fi

          # ---- Supply-chain guard: known-bad package blocklist ---- :contentReference[oaicite:10]{index=10}
          if npm ls -g --depth=0 | grep -F "${BLOCKED_NPM}" >/dev/null 2>&1; then
            fail "ì°¨ë‹¨ëœ MCP ì„œë²„ íŒ¨í‚¤ì§€ ë°œê²¬: ${BLOCKED_NPM} â€” ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
            exit 1
          else
            echoe "ì°¨ë‹¨ íŒ¨í‚¤ì§€ ì—†ìŒ (OK)"
          fi

      - name: Generate sample MCP server (Python, stdio)
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          cat > "${MCP_DIR}/mcp_ping_server.py" <<'PY'
          import asyncio
          from typing import Any, Dict
          from mcp.server.fastmcp import FastMCP

          app = FastMCP("mcp-ping")

          @app.tool()
          def ping(message: str = "pong") -> Dict[str, Any]:
            "Return the message back (health-check)."
            return {"ok": True, "echo": message}

          @app.resource("readme")
          def readme() -> str:
            return "MCP sample server is running."
          if __name__ == "__main__":
            asyncio.run(app.run_stdio())
          PY
          echo "${ECHO_OK} Sample MCP server generated."

      - name: Create MCP config (JSON)
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          cat > "${MCP_DIR}/mcp.config.json" <<'JSON'
          {
            "mcpServers": {
              "ping-python": {
                "command": "python",
                "args": [".github/mcp/mcp_ping_server.py"]
              }
            }
          }
          JSON
          echo "${ECHO_OK} MCP config created."

      - name: MCP health checks (Inspector via npx, non-interactive)
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          set -Eeuo pipefail
          INS="npx -y @modelcontextprotocol/inspector"
          run_cmd "$INS --cli --config ${MCP_DIR}/mcp.config.json list servers       | tee ${OUT_DIR}/servers.txt"
          run_cmd "$INS --cli --config ${MCP_DIR}/mcp.config.json list tools         | tee ${OUT_DIR}/tools.txt"
          run_cmd "$INS --cli --config ${MCP_DIR}/mcp.config.json list resources     | tee ${OUT_DIR}/resources.txt"
          run_cmd "$INS --cli --config ${MCP_DIR}/mcp.config.json call-tool ping-python:ping --args '{\"message\":\"hello\"}' | tee ${OUT_DIR}/call_ping.json"
          grep -q '"ok": true' "${OUT_DIR}/call_ping.json" && echoe "MCP ping tool OK" || { fail "MCP ping tool failed"; exit 1; }

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mcp-outputs
          path: |
            .github/mcp_out/**
            .github/mcp/**
            .github/echo_logs/**
          if-no-files-found: warn
          retention-days: 7

      - name: Create PR with generated files (optional)
        if: ${{ inputs.create_pr == true }}
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "feat(mcp): setup + inspector(npx) + sample server + echo logs (v2)"
          title: "ðŸ§  MCP Setup + Health + Echo â€” v2 (auto)"
          body: |
            - npm íŒ¨í‚¤ì§€ëª…/ë²„ì „ ì •ì •: @modelcontextprotocol/sdk, @modelcontextprotocol/inspector (npx)
            - Python SDK(mcp[server]) ì„¤ì¹˜
            - server-filesystem(ì˜µì…˜): ìµœì‹  ë²„ì „ ìžë™ ì¡°íšŒ í›„ ì„¤ì¹˜
            - npm ë ˆì§€ìŠ¤íŠ¸ë¦¬ ëª…ì‹œ + ìž¬ì‹œë„ ëž˜í¼ + í´ë°±
            - ì•…ì„± MCP ì„œë²„ ì°¨ë‹¨ ë¦¬ìŠ¤íŠ¸ ê²€ì‚¬(ì˜ˆ: postmark-mcp@1.0.16)
            - 5ë¶„ ì£¼ê¸° cron ìœ ì§€
          add-paths: |
            .github/mcp/**
            .github/echo_logs/**
            .github/mcp_out/**
          branch: "ci/mcp-setup-auto-v2"

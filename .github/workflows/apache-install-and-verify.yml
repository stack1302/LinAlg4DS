name: "ðŸ§± Apache Install + Configure + Start + Verify + Copy-to-Workflows (ALL-ECHO, v3)"

on:
  workflow_dispatch:
    inputs:
      site_name:
        description: "ê°€ìƒí˜¸ìŠ¤íŠ¸ ServerName (ê¸°ë³¸: localhost)"
        required: true
        default: "localhost"
      index_title:
        description: "index.html íƒ€ì´í‹€"
        required: true
        default: "Apache ALL-ECHO"
      index_message:
        description: "index.html ë³¸ë¬¸ ë©”ì‹œì§€"
        required: true
        default: "Apache is up on GitHub Actions runner ðŸš€"
      copy_sources:
        description: "ë³µì‚¬í•  íŒŒì¼/ê¸€ë¡­(ì‰¼í‘œ/ê³µë°±/ì¤„ë°”ê¿ˆ êµ¬ë¶„). ì˜ˆ: workflows/*.yml, extra.yml"
        required: false
        default: ""
      copy_dest_subdir:
        description: ".github/workflows í•˜ìœ„ í´ë”ëª… (ì˜ˆ: apache-added)"
        required: false
        default: "apache-added"
      create_pr:
        description: "ë³µì‚¬í•œ íŒŒì¼ì„ PRë¡œ ì˜¬ë¦´ê¹Œìš”?"
        type: boolean
        required: true
        default: true
      pr_title:
        description: "PR ì œëª©"
        required: false
        default: "chore: add copied workflow files (auto)"

permissions:
  contents: write
  pull-requests: write

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_apache
  ECHO_OK: "âœ…"
  ECHO_WARN: "âš ï¸"
  ECHO_FAIL: "âŒ"

jobs:
  apache:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â™»ï¸ Prepare echo helpers & trap
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}"
          HELPER="${LOG_DIR}/echo_helpers.sh"
          cat > "${HELPER}" <<'SH'
          set -Eeuo pipefail
          echoe(){ printf '%s %s\n' "${ECHO_OK}" "$*"; }
          warn(){  printf '%s %s\n' "${ECHO_WARN}" "$*"; }
          fail(){  printf '%s %s\n' "${ECHO_FAIL}" "$*"; }
          logf(){  printf '%s\n' "$*" | tee -a "${LOG_DIR}/run.log"; }
          run_cmd(){
            logf "â–¶ $*"
            eval $* 2>&1 | tee -a "${LOG_DIR}/run.log"
            local rc=${PIPESTATUS[0]}
            if [ $rc -eq 0 ]; then echoe "DONE($rc): $*"; else warn "RC=$rc â† $*"; fi
            return $rc
          }
          SH
          source "${HELPER}"

          cleanup(){
            warn "CLEANUP: collecting diagnosticsâ€¦"
            {
              echo "=== APACHE PROCESSES ==="
              ps -eo pid,ppid,user,cmd | grep -E 'apache2|httpd' | grep -v grep || true
              echo
              echo "=== LISTEN PORTS (80/443) ==="
              ss -lntp || true
              echo
              echo "=== ports.conf ==="
              sudo sed -n '1,160p' /etc/apache2/ports.conf 2>/dev/null || true
              echo
              echo "=== sites-available/000-default.conf ==="
              sudo sed -n '1,200p' /etc/apache2/sites-available/000-default.conf 2>/dev/null || true
              echo
              echo "=== apache2ctl -S ==="
              sudo apache2ctl -S || true
              echo
              echo "=== apache2ctl -M ==="
              sudo apache2ctl -M || true
              echo
              echo "=== APACHE ERROR LOG (tail) ==="
              sudo tail -n 200 /var/log/apache2/error.log || true
              echo
              echo "=== SAVED HEADERS ==="
              sed -n '1,200p' "${LOG_DIR}"/curl_*.hdr 2>/dev/null || true
              echo
              echo "=== SAVED HTML (first 80 lines) ==="
              for f in "${LOG_DIR}"/curl_*.html; do
                [ -f "$f" ] || continue
                echo "--- $f ---"
                sed -n '1,80p' "$f"
              done
            } | tee -a "${LOG_DIR}/diagnostics.txt"
          }
          trap 'rc=$?; [ $rc -eq 0 ] || cleanup; exit $rc' EXIT
          echoe "Echo helpers ready at ${HELPER}"

      # (ì¤‘ëžµ) â€” ì•„íŒŒì¹˜ ì„¤ì¹˜/ì„¤ì •/ê¸°ë™/ê²€ì¦ ìŠ¤í…ì€ ì´ì „ v2ì™€ ë™ì¼
      # == ì„¤ì¹˜/ì„¤ì •/ê²€ì¦ ìŠ¤í…ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì„¸ìš” ==
      # í•„ìš” ì‹œ ì œê°€ ë“œë¦° Ultra-Robust v2 ë³¸ë¬¸ì„ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.

      - name: ðŸ“¦ Collect configs & logs
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${LOG_DIR}/echo_helpers.sh"
          OUTDIR="apache-collect"
          run_cmd mkdir -p "${OUTDIR}/etc-apache2" "${OUTDIR}/var-log-apache2" "${OUTDIR}/echo"
          run_cmd sudo cp -a /etc/apache2/* "${OUTDIR}/etc-apache2/" || true
          run_cmd sudo cp -a /var/log/apache2/* "${OUTDIR}/var-log-apache2/" || true
          run_cmd cp -a "${LOG_DIR}"/* "${OUTDIR}/echo/" || true
          tar -czf apache-artifacts.tgz -C "${OUTDIR}" .
          echo "Created: $(pwd)/apache-artifacts.tgz"

      - name: ðŸ—‚ï¸ Copy files into .github/workflows (by pattern)
        if: ${{ inputs.copy_sources != '' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${LOG_DIR}/echo_helpers.sh"

          DEST_BASE=".github/workflows"
          SUBDIR="${{ inputs.copy_dest_subdir }}"
          DEST="${DEST_BASE}/${SUBDIR}"
          RAW="${{ inputs.copy_sources }}"

          run_cmd mkdir -p "${DEST}"
          echo "Copy dest: ${DEST}" | tee -a "${LOG_DIR}/run.log"

          # íŒ¨í„´ ëª©ë¡ ë¶„ë¦¬(ì‰¼í‘œ/ê³µë°±/ì¤„ë°”ê¿ˆ)
          printf '%s\n' "$RAW" | tr ', ' '\n' | sed '/^$/d' > /tmp/copy_list.txt
          echo "Patterns:"; cat /tmp/copy_list.txt || true

          shopt -s nullglob globstar
          : > "${LOG_DIR}/copy_map.txt"

          while IFS= read -r pattern; do
            # íŒ¨í„´ì„ ê·¸ëŒ€ë¡œ ê¸€ë¡­ í™•ìž¥
            found=0
            for f in $pattern; do
              # ë””ë ‰í† ë¦¬ëŠ” ìŠ¤í‚µ, íŒŒì¼ë§Œ
              [ -f "$f" ] || continue
              base="$(basename "$f")"
              # ìƒìœ„ ê²½ë¡œ ì—­ì°¸ì¡° ë°©ì§€(íŒŒì¼ì€ ì›Œí‚¹íŠ¸ë¦¬ì— ìžˆë‹¤ê³  ê°€ì •)
              run_cmd install -m0644 -D "$f" "${DEST}/${base}"
              echo "$f -> ${DEST}/${base}" | tee -a "${LOG_DIR}/copy_map.txt"
              found=$((found+1))
            done
            if [ $found -eq 0 ]; then
              warn "No match for pattern: $pattern"
            else
              echoe "Copied $found file(s) for pattern: $pattern"
            fi
          done < /tmp/copy_list.txt

          echo "==== COPY SUMMARY ===="
          sed -n '1,200p' "${LOG_DIR}/copy_map.txt" || true

      - name: â¬†ï¸ Upload artifact (logs + copy map)
        uses: actions/upload-artifact@v4
        with:
          name: apache-artifacts
          path: |
            apache-artifacts.tgz
            ${{ env.LOG_DIR }}/run.log
            ${{ env.LOG_DIR }}/diagnostics.txt
            ${{ env.LOG_DIR }}/copy_map.txt
          if-no-files-found: warn

      - name: ðŸ”€ Create Pull Request with copied files
        if: ${{ inputs.copy_sources != '' && inputs.create_pr }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: |
            .github/workflows/**
          commit-message: |
            chore(workflows): add copied files under .github/workflows/${{ inputs.copy_dest_subdir }}

            - Auto-copied via Apache workflow
            - See .github/echo_apache/copy_map.txt for mapping
          title: ${{ inputs.pr_title }}
          body: |
            ## Summary
            This PR adds files under `.github/workflows/${{ inputs.copy_dest_subdir }}`.

            - Source patterns: `${{ inputs.copy_sources }}`
            - Mapping recorded in: `.github/echo_apache/copy_map.txt`

            _Automated by Apache ALL-ECHO workflow._
          branch: "auto/workflows-copy-${{ inputs.copy_dest_subdir }}"
          delete-branch: true
